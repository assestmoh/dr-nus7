// server.js â€” Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø­Ø³Ù‘Ù†Ø© Ù„Ù…ÙˆØ¯ÙŠÙ„ openai/gpt-oss-120b

import 'dotenv/config';
import express from 'express';
import cors from 'cors';
import bodyParser from 'body-parser';
import fetch from 'node-fetch';

const app = express();

const GROQ_API_KEY = process.env.GROQ_API_KEY;
const MODEL_ID = process.env.GROQ_MODEL || "openai/gpt-oss-120b";
const PORT = process.env.PORT || 3000;

if (!GROQ_API_KEY) {
  console.error("âŒ GROQ_API_KEY ØºÙŠØ± Ù…Ø¶Ø¨ÙˆØ· ÙÙŠ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©");
  process.exit(1);
}

app.use(cors());
app.use(bodyParser.json());

// Ø°Ø§ÙƒØ±Ø© Ù…Ø­Ø§Ø¯Ø«Ø© Ø¨Ø³ÙŠØ·Ø©
const conversations = {};

function buildSystemPrompt() {
  return `
Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ØµØ­ÙŠ Ù…ÙˆØ«ÙˆÙ‚ Ù…ØªØ®ØµØµ ÙÙŠ Ø§Ù„ØªØ«Ù‚ÙŠÙ Ø§Ù„ØµØ­ÙŠ Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠ. Ù…Ù‡Ù…ØªÙƒ ØªÙ‚Ø¯ÙŠÙ… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙˆØ§Ø¶Ø­Ø© ÙˆØ¯Ù‚ÙŠÙ‚Ø© ÙˆØ¢Ù…Ù†Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª (Ø§Ù„Ø±Ø¬Ø§Ù„ â€“ Ø§Ù„Ù†Ø³Ø§Ø¡ â€“ Ø§Ù„Ø£Ø·ÙØ§Ù„) Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰ Ø§Ù„Ø³Ù‡Ù„Ø©.

Ø£Ø³Ù„ÙˆØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:
- Ø§ÙƒØªØ¨ Ø¨Ø£Ø³Ù„ÙˆØ¨ Ù‡Ø§Ø¯Ø¦ ÙˆÙ…Ù‡Ù†ÙŠ ÙŠØ´Ø¨Ù‡ ÙƒÙ„Ø§Ù… Ø§Ù„Ù…Ù…Ø§Ø±Ø³ Ø§Ù„ØµØ­ÙŠ.
- ÙƒÙ† Ù…Ø®ØªØµØ±Ù‹Ø§ ÙˆÙ…Ø¨Ø§Ø´Ø±Ù‹Ø§ Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø± Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø²Ø§Ø¦Ø¯ (Ù…Ù† 4 Ø¥Ù„Ù‰ 8 Ø£Ø³Ø·Ø±).
- Ø±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø§Ù„Ù†ØµØ§Ø¦Ø­ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ†ÙÙŠØ°.
- Ø§Ø³ØªØ®Ø¯Ù… Ù†Ù‚Ø§Ø· Ø¨Ø³ÙŠØ·Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© Ø¯ÙˆÙ† Ù…Ø¨Ø§Ù„ØºØ©.
- ØªØ¬Ù†Ù‘Ø¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„ØºØ±ÙŠØ¨Ø© Ø£Ùˆ Ø§Ù„Ù…ØªØ±Ø¬Ù…Ø© Ø­Ø±ÙÙŠÙ‹Ø§.

Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ©:
- Ù„Ø§ ØªÙ‚Ø¯Ù‘Ù… ØªØ´Ø®ÙŠØµÙ‹Ø§ Ø·Ø¨ÙŠÙ‹Ø§ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§.
- Ù„Ø§ ØªØ°ÙƒØ± Ø£Ø³Ù…Ø§Ø¡ Ø£Ø¯ÙˆÙŠØ© Ø£Ùˆ Ø¬Ø±Ø¹Ø§Øª Ø£Ùˆ ØªØ­Ø§Ù„ÙŠÙ„ Ù…Ø­Ø¯Ø¯Ø©.
- Ù„Ø§ ØªØµÙ Ø¹Ù„Ø§Ø¬Ù‹Ø§ Ø¯Ù‚ÙŠÙ‚Ù‹Ø§ Ù…Ø®ØµØµÙ‹Ø§ Ù„Ø­Ø§Ù„Ø© Ù…Ø±Ø¶ÙŠØ©.
- ÙŠÙ…ÙƒÙ†Ùƒ Ø°ÙƒØ±: Ù…ØªÙ‰ Ø£Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨ØŸ ÙˆÙ…ØªÙ‰ ØªØ³ØªØ¯Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„Ø© Ø·ÙˆØ§Ø±Ø¦.

Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ©:
- Ù„Ø§ ØªÙ‚ØªØ±Ø­ ØªÙ†Ø§ÙˆÙ„ Ø£Ùˆ Ø´Ø±Ø¨ Ø£ÙŠ Ù…Ø§Ø¯Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù„Ø£ÙƒÙ„ (Ù…Ø«Ù„ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù†ØŒ Ø§Ù„Ø¨Ù†Ø²ÙŠÙ†ØŒ Ø§Ù„Ø¨Ù„Ø§Ø³ØªÙŠÙƒØŒ Ø§Ù„Ø²Ø¬Ø§Ø¬ØŒ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©ØŒ Ø£Ùˆ Ø£ÙŠ Ø´ÙŠØ¡ ØºÙŠØ± Ù…Ù†Ø·Ù‚ÙŠ).
- Ù„Ø§ ØªÙ†ØµØ­ Ø¨ØªÙ†Ø§ÙˆÙ„ "ÙƒÙ„ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚" Ø£Ùˆ "Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„ÙÙˆØ§ÙƒÙ‡" Ø£Ùˆ Ø£ÙŠ Ø£ÙˆØ±Ø§Ù‚ ØºÙŠØ± Ù…Ø®ØµØµØ© Ù„Ù„Ø£ÙƒÙ„.
- Ø±ÙƒÙ‘Ø² ÙÙ‚Ø· Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø·Ø¹Ù…Ø© Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© Ø§Ù„Ù…Ø¹Ø±ÙˆÙØ©: Ø§Ù„Ø®Ø¶Ø±ÙˆØ§ØªØŒ Ø§Ù„ÙÙˆØ§ÙƒÙ‡ØŒ Ø§Ù„Ø­Ø¨ÙˆØ¨ Ø§Ù„ÙƒØ§Ù…Ù„Ø©ØŒ Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†Ø§ØªØŒ Ø§Ù„Ù…Ø§Ø¡.

ØµØ­Ø© Ø§Ù„Ù…Ø±Ø£Ø©:
- Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…ØªØ¹Ù„Ù‚Ù‹Ø§ Ø¨Ø§Ù„Ø­Ù…Ù„ Ø£Ùˆ Ø§Ù„Ø¯ÙˆØ±Ø© Ø£Ùˆ Ø§Ù„Ø±Ø¶Ø§Ø¹Ø© Ø£Ùˆ Ø§Ù„Ù‡Ø±Ù…ÙˆÙ†Ø§ØªØŒ ÙØ£Ø¬Ø¨ Ø¨Ø­Ø³Ø§Ø³ÙŠØ© ÙˆÙˆØ¶ÙˆØ­ØŒ Ù…Ø¹ ØªØ°ÙƒÙŠØ± Ø®ÙÙŠÙ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©.

ØµØ­Ø© Ø§Ù„Ø£Ø·ÙØ§Ù„:
- Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø·ÙÙ„ØŒ Ø®Ø§Ø·ÙØ¨ ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù…Ø¨Ø§Ø´Ø±Ø© ÙˆÙ‚Ø¯Ù‘Ù… Ù†ØµØ§Ø¦Ø­ Ù…Ø¨Ø³Ø·Ø©.
- Ø§Ø°ÙƒØ± Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø®Ø·Ø± Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ù„Ø£Ø·ÙØ§Ù„ Ø¯ÙˆÙ† Ù…Ø¨Ø§Ù„ØºØ©.

Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø®Ø·ÙˆØ±Ø©:
- Ø¥Ø°Ø§ ÙˆØ±Ø¯Øª ÙÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø£Ø¹Ø±Ø§Ø¶ Ù…Ø«Ù„ (Ø£Ù„Ù… ØµØ¯Ø± â€” Ø¶ÙŠÙ‚ Ù†ÙØ³ â€” ÙÙ‚Ø¯Ø§Ù† ÙˆØ¹ÙŠ â€” Ù†Ø²ÙŠÙ â€” ØªØ´Ù†Ø¬Ø§Øª â€” Ø­Ø±Ø§Ø±Ø© Ø¹Ø§Ù„ÙŠØ© Ø¹Ù†Ø¯ Ø·ÙÙ„)ØŒ ÙØ§Ø°ÙƒØ±Ù‡Ø§ ÙƒØªØ­Ø°ÙŠØ± Ù‡Ø§Ø¯Ø¦ ÙˆÙ…Ù‡Ù†ÙŠ.

Ø§Ù„Ø®ØªØ§Ù…:
- ÙÙŠ Ù†Ù‡Ø§ÙŠØ© ÙƒÙ„ Ø±Ø¯ØŒ Ø£Ø¶Ù:  
  "Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„ØªØ«Ù‚ÙŠÙ Ø§Ù„ØµØ­ÙŠ ÙÙ‚Ø· ÙˆÙ„Ø§ ØªØºÙ†ÙŠ Ø¹Ù† Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø£Ùˆ Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„ØµØ­ÙŠØ©."
`.trim();
}

// ÙƒÙ„Ù…Ø§Øª Ø®Ø·Ø± ØºØ°Ø§Ø¦ÙŠ (Ù‡Ù„ÙˆØ³Ø§Øª ØºÙŠØ± Ù…Ù†Ø·Ù‚ÙŠØ©)
const NON_FOOD = [
  "ÙÙˆÙ„Ø§Ø°", "Ø­Ø¯ÙŠØ¯", "Ø¨Ù†Ø²ÙŠÙ†", "Ø²Ø¬Ø§Ø¬", "Ø¨Ù„Ø§Ø³ØªÙŠÙƒ", "Ø­Ø§Ø³ÙˆØ¨", "ÙƒÙ…Ø¨ÙŠÙˆØªØ±", "Ù…Ø¹Ø§Ø¯Ù†", "ØªÙ†Ø¸ÙŠÙ"
];

// Ø¹Ø¨Ø§Ø±Ø§Øª Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„ØºØ±ÙŠØ¨Ø©
const LEAF_PHRASES = [
  "Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„ÙÙˆØ§ÙƒÙ‡", "ÙƒÙ„ Ø£ÙˆØ±Ø§Ù‚", "Ø£ÙƒÙ„ Ø£ÙˆØ±Ø§Ù‚"
];

// Ø¹Ø¨Ø§Ø±Ø§Øª Ø®Ø·ÙˆØ±Ø©
const DANGER_WORDS = [
  "Ø£Ù„Ù… ØµØ¯Ø±", "Ø¶ÙŠÙ‚ Ù†ÙØ³", "ÙÙ‚Ø¯Ø§Ù† ÙˆØ¹ÙŠ", "Ù†Ø²ÙŠÙ", "ØªØ´Ù†Ø¬", "ØµØ±Ø¹", "Ø¬Ù„Ø·Ø©", "Ø³ÙƒØªØ©"
];

async function askHealthBot(userMessage, sessionId = "default") {
  if (!conversations[sessionId]) conversations[sessionId] = [];

  conversations[sessionId].push({ role: "user", content: userMessage });

  // Ø­Ø¯ Ø£Ø¹Ù„Ù‰ Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
  if (conversations[sessionId].length > 10) {
    conversations[sessionId] = conversations[sessionId].slice(-10);
  }

  const messages = [
    { role: "system", content: buildSystemPrompt() },
    ...conversations[sessionId],
  ];

  const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
    method: "POST",
    headers: {
      Authorization: `Bearer ${GROQ_API_KEY}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      model: MODEL_ID,
      temperature: 0.35,
      max_tokens: 600,
      messages,
    }),
  });

  if (!response.ok) {
    console.error("Groq error:", await response.text());
    throw new Error("Groq API failed");
  }

  const data = await response.json();
  let reply = data.choices?.[0]?.message?.content || "";

  // ÙÙ„ØªØ± Ø§Ù„Ù…ÙˆØ§Ø¯ ØºÙŠØ± Ø§Ù„ØµØ§Ù„Ø­Ø© Ù„Ù„Ø£ÙƒÙ„
  if (NON_FOOD.some((x) => reply.includes(x))) {
    reply = `
ØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø¬Ø²Ø¡ ØºÙŠØ± Ù…Ù†Ø·Ù‚ÙŠ ÙÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ÙŠØªØ¹Ù„Ù‚ Ø¨Ù…ÙˆØ§Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­Ø© Ù„Ù„Ø£ÙƒÙ„.

Ù„Ù„ØªØºØ°ÙŠØ© Ø§Ù„ØµØ­ÙŠØ©:
â€¢ Ø±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø¶Ø±ÙˆØ§Øª ÙˆØ§Ù„ÙÙˆØ§ÙƒÙ‡ ÙˆØ§Ù„Ø­Ø¨ÙˆØ¨ Ø§Ù„ÙƒØ§Ù…Ù„Ø©.
â€¢ Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ†Ø§Øª Ø§Ù„ØµØ­ÙŠØ© Ù…Ø«Ù„ Ø§Ù„Ø³Ù…Ùƒ ÙˆØ§Ù„Ø¯Ø¬Ø§Ø¬ ÙˆØ§Ù„Ø¨Ù‚ÙˆÙ„ÙŠØ§Øª.
â€¢ Ø§Ø´Ø±Ø¨ Ø§Ù„Ù…Ø§Ø¡ Ø¨Ø§Ù†ØªØ¸Ø§Ù… ÙˆØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ø·Ø¹Ù…Ø© Ø§Ù„Ø¯Ø³Ù…Ø©.

Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„ØªØ«Ù‚ÙŠÙ Ø§Ù„ØµØ­ÙŠ ÙÙ‚Ø· ÙˆÙ„Ø§ ØªØºÙ†ÙŠ Ø¹Ù† Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø£Ùˆ Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„ØµØ­ÙŠØ©.
`.trim();
  }

  // ÙÙ„ØªØ± Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„ØºØ±ÙŠØ¨Ø©
  if (LEAF_PHRASES.some((x) => reply.includes(x))) {
    reply = `
Ù„Ø§ ÙŠÙÙ†ØµÙŽØ­ Ø¨ØªÙ†Ø§ÙˆÙ„ Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„Ù†Ø¨Ø§ØªØ§Øª ØºÙŠØ± Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ù„Ø£ÙƒÙ„ Ù…Ø«Ù„ "Ø£ÙˆØ±Ø§Ù‚ Ø§Ù„ÙÙˆØ§ÙƒÙ‡". Ø±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„ÙØ§ÙƒÙ‡Ø© Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© Ø§Ù„ØµØ§Ù„Ø­Ø© Ù„Ù„Ø£ÙƒÙ„ ÙÙ‚Ø·.

Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„ØªØ«Ù‚ÙŠÙ Ø§Ù„ØµØ­ÙŠ ÙÙ‚Ø· ÙˆÙ„Ø§ ØªØºÙ†ÙŠ Ø¹Ù† Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø£Ùˆ Ù…Ù‚Ø¯Ù… Ø§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„ØµØ­ÙŠØ©.
`.trim();
  }

  conversations[sessionId].push({ role: "assistant", content: reply });
  return reply;
}

app.post("/chat", async (req, res) => {
  try {
    let msg = (req.body.message || "").trim();
    if (!msg) return res.json({ reply: "Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙØ§Ø±ØºØ©." });

    let sessionId = req.ip || "default";

    // Ø¥Ø¶Ø§ÙØ© ØªØ­Ø°ÙŠØ± Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ ÙƒÙ„Ù…Ø§Øª Ø®Ø·ÙˆØ±Ø©
    if (DANGER_WORDS.some((w) => msg.includes(w))) {
      msg += "\n\n[ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ù†Ù…ÙˆØ°Ø¬: Ø±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø®Ø·ÙˆØ±Ø© ÙˆÙ…ØªÙ‰ Ø£Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨]";
    }

    const reply = await askHealthBot(msg, sessionId);
    res.json({ reply });

  } catch (err) {
    res.json({
      reply: "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨. ÙŠÙÙØ¶Ù‘ÙŽÙ„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ù‹Ø§."
    });
  }
});

app.listen(PORT, () =>
  console.log(`ðŸš€ ØµØ­ØªÙƒ Ø¨Ù„Ø³ ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙˆØ±Øª ${PORT} Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„: ${MODEL_ID}`)
);
