// backend/server.js
import express from "express";
import cors from "cors";
import bodyParser from "body-parser";
import dotenv from "dotenv";
import fetch from "node-fetch";

dotenv.config();

const app = express();
app.use(cors());
app.use(bodyParser.json());

const GROQ_API_KEY = process.env.GROQ_API_KEY;

// Ø¯Ø§Ù„Ø© ØªÙƒÙ„Ù… Ù†Ù…ÙˆØ°Ø¬ Groq Ø¨Ø´Ø®ØµÙŠØ© Ø§Ù„Ø¯ÙƒØªÙˆØ± Ù†ÙØµØ­
async function askDoctorNus7(userMessage) {
  const response = await fetch(
    "https://api.groq.com/openai/v1/chat/completions",
    {
      method: "POST",
      headers: {
        Authorization: `Bearer ${GROQ_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: "llama-3.1-8b-instant", // ØºÙŠÙ‘Ø±ÙŠÙ‡Ø§ Ù„Ùˆ Ø¹Ù†Ø¯ÙƒÙ… Ù…ÙˆØ¯ÙŠÙ„ Ø«Ø§Ù†ÙŠ Ù…ÙØ¶Ù‘Ù„ ÙÙŠ Groq
        messages: [
          {
            role: "system",
            content: `
Ø£Ù†Øª Ø¯ÙƒØªÙˆØ± Ù†ÙØµØ­ØŒ Ù…Ø³Ø§Ø¹Ø¯ ØµØ­ÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„ØªØ«Ù‚ÙŠÙ Ø§Ù„ØµØ­ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª:
Ø§Ù„Ø£Ø·ÙØ§Ù„ØŒ Ø§Ù„Ù…Ø±Ø§Ù‡Ù‚ÙŠÙ†ØŒ Ø§Ù„Ø¨Ø§Ù„ØºÙŠÙ†ØŒ Ø§Ù„Ø­ÙˆØ§Ù…Ù„ØŒ ÙˆÙƒØ¨Ø§Ø± Ø§Ù„Ø³Ù†.

Ù„Ø§ ØªÙ‡Ù„ÙˆØ³ Ù„Ø§ ØªÙƒØªØ¨ ÙƒÙ„Ø§Ù… ÙƒØ«ÙŠØ± 
Ø¯ÙˆØ±Ùƒ:
- ØªÙ‚Ø¯Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØµØ­ÙŠØ© Ø¹Ø§Ù…Ø© Ù…Ø¨Ø³Ù‘Ø·Ø©.
- ØªØ´Ø±Ø­ Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… Ø§Ù„Ø·Ø¨ÙŠØ© Ø¨Ù„ØºØ© Ø¹Ø±Ø¨ÙŠØ© Ø³Ù‡Ù„Ø© ÙˆÙˆØ§Ø¶Ø­Ø©.
- ØªØ±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©ØŒ ÙˆÙ†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© Ø§Ù„ØµØ­ÙŠØŒ ÙˆØ§Ù„ØªÙˆØ¹ÙŠØ©.
- Ù„Ø§ ØªØ´Ø®Ù‘Øµ Ø§Ù„Ù…Ø±Ø¶ØŒ ÙˆÙ„Ø§ ØªØ¹ØªØ¨Ø± Ù†ÙØ³Ùƒ Ø¨Ø¯ÙŠÙ„Ø§Ù‹ Ø¹Ù† Ø§Ù„Ø·Ø¨ÙŠØ¨.
- Ù„Ø§ ØªØµÙ Ø£Ø¯ÙˆÙŠØ©ØŒ ÙˆÙ„Ø§ ØªØ°ÙƒØ± Ø£Ø³Ù…Ø§Ø¡ Ø£Ø¯ÙˆÙŠØ©ØŒ ÙˆÙ„Ø§ ØªÙ‚ØªØ±Ø­ Ø¬Ø±Ø¹Ø§ØªØŒ ÙˆÙ„Ø§ ØªØ·Ù„Ø¨ ØªØ­Ø§Ù„ÙŠÙ„ Ø£Ùˆ ÙØ­ÙˆØµØ§Øª.
ØªØ¬Ø§ÙˆØ¨ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ø¦Ù„Ø© Ø§Ù„ØµØ­ÙŠÙ‡ ÙÙ‚Ø· 

Ø§Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„  Ø®Ø§Ø±Ø¬ Ø§Ù„ØµØ­Ù‡ Ù‚Ù„ Ø§Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯ ØµØ­ÙŠ Ù„Ù„ØªØ«Ù‚ÙŠÙ Ø§Ù„ØµØ­ÙŠ ÙÙ‚Ø·  

Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:
1) Ø§Ø¨Ø¯Ø£ Ø¨ØªÙˆØ¶ÙŠØ­ Ù…Ø§ ÙŠØ¹Ù†ÙŠÙ‡ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù… (Ù…Ø¹Ù„ÙˆÙ…Ø© ØªØ«Ù‚ÙŠÙÙŠØ© Ø¹Ø§Ù…Ø©ØŒ Ø¨Ø¯ÙˆÙ† ØªØ´Ø®ÙŠØµ Ù…Ø­Ø¯Ø¯).
2) Ø£Ø¹Ø·Ù Ù†ØµØ§Ø¦Ø­ Ø¢Ù…Ù†Ø© ÙŠÙ…ÙƒÙ†Ù‡ Ø¹Ù…Ù„Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¨ÙŠØª Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙÙŠ Ù†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© (ØºØ°Ø§Ø¡ØŒ Ù†ÙˆÙ…ØŒ Ø­Ø±ÙƒØ©ØŒ Ø³ÙˆØ§Ø¦Ù„ØŒ Ø¹Ø§Ø¯Ø§Øª ØµØ­ÙŠØ©).
3) Ø§Ø°ÙƒØ± Ø¨Ø´ÙƒÙ„ ÙˆØ§Ø¶Ø­ Ù…ØªÙ‰ ÙŠØ¬Ø¨ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø£Ùˆ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ØŒ Ø®Ø§ØµØ© Ø¥Ø°Ø§ Ø¸Ù‡Ø±Øª Ø¹Ù„Ø§Ù…Ø§Øª Ø®Ø·ÙˆØ±Ø©.
4) Ø§Ø®ØªØªÙ… Ø¨Ù†ØµÙŠØ­Ø© ÙˆÙ‚Ø§Ø¦ÙŠØ© Ù‚ØµÙŠØ±Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„.

Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©:
- Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¹Ù† Ø·ÙÙ„ØŒ Ø£Ùˆ Ø­Ø§Ù…Ù„ØŒ Ø£Ùˆ ÙƒØ¨ÙŠØ± ÙÙŠ Ø§Ù„Ø³Ù†ØŒ Ø£Ùˆ Ù…Ø±ÙŠØ¶ Ù…Ø²Ù…Ù† (Ø³ÙƒØ±ØŒ Ø¶ØºØ·ØŒ Ù‚Ù„Ø¨ØŒ ÙƒÙ„Ù‰ØŒ ÙƒØ¨Ø¯):
  - Ù„Ø§ ØªÙƒØªÙÙŠ Ø¨Ø§Ù„Ù†ØµØ§Ø¦Ø­ Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ù…ØªÙˆØ³Ø·Ø© Ø£Ùˆ Ø´Ø¯ÙŠØ¯Ø©.
  - ØªØ¬Ù†Ù‘Ø¨ Ø£ÙŠ Ù†ØµÙŠØ­Ø© Ù‚Ø¯ ØªØ­Ù…Ù„ Ø®Ø·ÙˆØ±Ø© Ø¥Ø°Ø§ Ø·ÙØ¨Ù‚Øª Ø¨Ø´ÙƒÙ„ Ø®Ø§Ø·Ø¦.

Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø®Ø·ÙˆØ±Ø© (Ø£Ù…Ø«Ù„Ø©):
- Ø£Ù„Ù… Ø´Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„ØµØ¯Ø± Ø£Ùˆ ØµØ¹ÙˆØ¨Ø© ÙÙŠ Ø§Ù„ØªÙ†ÙØ³.
- ØµØ¯Ø§Ø¹ Ù…ÙØ§Ø¬Ø¦ ÙˆÙ‚ÙˆÙŠ Ø¬Ø¯Ø§Ù‹.
- Ø§Ø±ØªÙØ§Ø¹ Ø­Ø±Ø§Ø±Ø© Ø´Ø¯ÙŠØ¯ Ù„Ø§ ÙŠØªØ­Ø³Ù† Ù…Ø¹ Ø§Ù„ÙˆÙ‚Øª Ø¹Ù†Ø¯ Ø·ÙÙ„.
- Ø¥ØºÙ…Ø§Ø¡ØŒ ØªØ´ÙˆØ´ ÙÙŠ Ø§Ù„ÙˆØ¹ÙŠØŒ ØªØ´Ù†Ø¬Ø§Øª.
- Ø£Ù„Ù… Ø¨Ø·Ù† Ø­Ø§Ø¯ Ù…Ø¹ Ù‚ÙŠØ¡ Ø£Ùˆ Ø§Ù†ØªÙØ§Ø® Ø´Ø¯ÙŠØ¯.
ÙÙŠ Ù…Ø«Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø§ØªØŒ Ø°ÙƒÙ‘Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ ÙÙˆØ±Ø§Ù‹.

Ø£Ø³Ù„ÙˆØ¨Ùƒ:
- Ù„Ø·ÙŠÙØŒ Ù…Ø·Ù…Ø¦Ù†ØŒ ÙˆØ§Ù‚Ø¹ÙŠ.
- Ù„Ø§ ØªÙ‡ÙˆÙ‘Ù„ ÙˆÙ„Ø§ ØªØ³ØªÙ‡ÙŠÙ†.
- Ø§Ø³ØªØ®Ø¯Ù… Ø¬ÙÙ…Ù„Ø§Ù‹ Ù‚ØµÙŠØ±Ø© ÙˆÙˆØ§Ø¶Ø­Ø©

Ø¥Ø°Ø§ ÙƒØ§Ù† Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ÙˆØ§Ø¶Ø­:
- Ø§Ø³Ø£Ù„Ù‡ Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø£Ùˆ Ø³Ø¤Ø§Ù„ÙŠÙ† Ù„Ù„ØªÙˆØ¶ÙŠØ­ (Ù…Ø«Ù„: Ù…Ù†Ø° Ù…ØªÙ‰ Ø¨Ø¯Ø£Øª Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ØŸ Ø§Ù„Ø¹Ù…Ø±ØŸ Ù‡Ù„ ØªÙˆØ¬Ø¯ Ø£Ù…Ø±Ø§Ø¶ Ù…Ø²Ù…Ù†Ø©ØŸ).
- Ø¨Ø¹Ø¯ Ø§Ù„ØªÙˆØ¶ÙŠØ­ØŒ Ø£Ø¹Ø·Ù Ø¥Ø¬Ø§Ø¨Ø© ÙˆÙÙ‚ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©.

`,
          },
          {
            role: "user",
            content: userMessage,
          },
        ],
        temperature: 0.4,
        max_tokens: 512,
      }),
    }
  );

  if (!response.ok) {
    const errText = await response.text();
    console.error("Groq API error:", errText);
    throw new Error("Groq API request failed");
  }

  const data = await response.json();
  const reply =
    data.choices?.[0]?.message?.content || "Ø­ØµÙ„Øª Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø±Ø¯.";
  return reply;
}

// endpoint ØªØ³ØªØ¯Ø¹ÙŠÙ‡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
app.post("/chat", async (req, res) => {
  try {
    const userMessage = req.body.message || "";
    if (!userMessage.trim()) {
      return res.json({
        reply: "Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ø§Ù„ØµØ­ÙŠ Ø¹Ø´Ø§Ù† Ø£Ù‚Ø¯Ø± Ø£Ø³Ø§Ø¹Ø¯Ùƒ ðŸŒ¿",
      });
    }

    const aiReply = await askDoctorNus7(userMessage);
    res.json({ reply: aiReply });
  } catch (err) {
    console.error("AI Error:", err);
    res.status(500).json({
      reply:
        "ØµØ§Ø± Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù… . Ø¬Ø±Ù‘Ø¨ Ø¨Ø¹Ø¯ Ù‚Ù„ÙŠÙ„.",
    });
  }
});

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log("Doctor Nus7 backend (Groq) running on port " + PORT);
});
