// Server.js โ Dalil Alafiyah API (FULL) โ
// ููุงุญุธุฉ: ูุฐุง ุงูููู ESM (import). ุดุบููู ุจู Node 18+
// npm i express cors helmet multer express-rate-limit tesseract.js pdf-parse dotenv
// ุซู: node Server.js

import "dotenv/config";
import express from "express";
import cors from "cors";
import helmet from "helmet";
import multer from "multer";
import rateLimit from "express-rate-limit";
import { createRequire } from "module";
import { createWorker } from "tesseract.js";

const require = createRequire(import.meta.url);
const pdfParse = require("pdf-parse");

const app = express();
const upload = multer({ limits: { fileSize: 8 * 1024 * 1024 } });

/* =========================
   Config
========================= */
const PORT = process.env.PORT || 8000;
const GROQ_API_KEY = process.env.GROQ_API_KEY || "";
const GROQ_MODEL = process.env.GROQ_MODEL || "openai/gpt-oss-120b";
const INTERNAL_API_KEY = process.env.INTERNAL_API_KEY || "";

/* Official Shifaa links */
const SHIFAA_ANDROID =
  "https://play.google.com/store/apps/details?id=om.gov.moh.phr&pcampaignid=web_share";
const SHIFAA_IOS =
  "https://apps.apple.com/us/app/%D8%B4-%D9%81-%D8%A7%D8%A1/id1455936672?l=ar";

/* WhatsApp appointments number (as provided) */
const WHATSAPP_APPOINTMENTS = "9880 9901";

/* =========================
   Middleware
========================= */
app.use(helmet({ crossOriginResourcePolicy: false }));

app.use(
  rateLimit({
    windowMs: 60 * 1000,
    max: 90,
    standardHeaders: true,
    legacyHeaders: false,
  })
);

function requireApiKey(req, res, next) {
  if (!INTERNAL_API_KEY) return next();
  const key = req.header("x-api-key");
  if (key !== INTERNAL_API_KEY)
    return res.status(401).json({ ok: false, error: "unauthorized" });
  next();
}
app.use(requireApiKey);

// ุนุฏูููุง ุญุณุจ ูุทุงูู
const ALLOWED_ORIGINS = new Set([
  "https://alafya.netlify.app",
  "http://localhost:5173",
  "http://localhost:3000",
  "http://localhost:8000",
]);

function isAllowedOrigin(origin) {
  try {
    const u = new URL(origin);
    if (ALLOWED_ORIGINS.has(origin)) return true;
    if (u.hostname === "localhost") return true;
    if (u.hostname.endsWith(".netlify.app")) return true;
    return false;
  } catch {
    return false;
  }
}

app.use(
  cors({
    origin: (origin, cb) => {
      if (!origin) return cb(null, true);
      if (isAllowedOrigin(origin)) return cb(null, true);
      return cb(new Error("CORS blocked: " + origin));
    },
    methods: ["GET", "POST", "OPTIONS"],
    allowedHeaders: ["Content-Type", "Authorization", "x-user-id", "x-api-key"],
  })
);

app.use(express.json({ limit: "2mb" }));
app.use(express.urlencoded({ extended: true, limit: "2mb" }));

/* =========================
   Metrics
========================= */
const METRICS = {
  startedAt: new Date().toISOString(),
  chatRequests: 0,
  chatOk: 0,
  chatFail: 0,
  reportRequests: 0,
  reportOk: 0,
  reportFail: 0,
  emergencyTriggers: 0,
  avgLatencyMs: 0,
  categoryCount: Object.create(null),
  flows: Object.fromEntries(
    [
      "sugar",
      "bp",
      "bmi",
      "water",
      "calories",
      "mental",
      "first_aid",
      "general",
      // institutional
      "medication_general_guidance",
      "lab_preparation",
      "common_conditions_education",
      "prevention_lifestyle",
      "facility_navigation",
      "shifaa_appointments",
    ].flatMap((k) => [
      [`${k}Started`, 0],
      [`${k}Completed`, 0],
    ])
  ),
};

function bumpCategory(cat) {
  if (!cat) return;
  METRICS.categoryCount[cat] = (METRICS.categoryCount[cat] || 0) + 1;
}

function updateAvgLatency(ms) {
  const alpha = 0.2;
  METRICS.avgLatencyMs =
    METRICS.avgLatencyMs === 0
      ? ms
      : Math.round(alpha * ms + (1 - alpha) * METRICS.avgLatencyMs);
}

/* =========================
   Sessions (in-memory) + TTL
========================= */
const sessions = new Map(); // userId -> { history, lastCard, flow, step, profile, ts, lastInText, lastInAt }

function getUserId(req) {
  const headerId = req.header("x-user-id");
  if (headerId) return headerId;
  const ua = req.header("user-agent") || "na";
  return `anon:${req.ip}:${ua.slice(0, 60)}`;
}

function getSession(userId) {
  const id = userId || "anon";
  if (!sessions.has(id)) {
    sessions.set(id, {
      history: [],
      lastCard: null,
      flow: null,
      step: 0,
      profile: {},
      ts: Date.now(),
      // โ ููุน ุงูุงุฒุฏูุงุฌ (double submit)
      lastInText: "",
      lastInAt: 0,
    });
  }
  const s = sessions.get(id);
  s.ts = Date.now();
  return s;
}

setInterval(() => {
  const now = Date.now();
  for (const [k, v] of sessions) {
    if (now - (v.ts || 0) > 24 * 60 * 60 * 1000) sessions.delete(k);
  }
}, 30 * 60 * 1000);

function trimHistory(history, max = 10) {
  if (history.length <= max) return history;
  return history.slice(history.length - max);
}

function resetFlow(session) {
  session.flow = null;
  session.step = 0;
  session.profile = {};
}

/* =========================
   OCR (tesseract.js)
========================= */
let ocrWorkerPromise = null;

async function getOcrWorker() {
  if (!ocrWorkerPromise) {
    ocrWorkerPromise = (async () => {
      const worker = await createWorker("eng+ara");
      return worker;
    })();
  }
  return ocrWorkerPromise;
}

async function ocrImageBuffer(buffer) {
  const worker = await getOcrWorker();
  const { data } = await worker.recognize(buffer);
  return data?.text ? String(data.text) : "";
}

/* =========================
   Helpers
========================= */
function safeJsonParse(s) {
  try {
    return JSON.parse(s);
  } catch {
    return null;
  }
}

function sleep(ms) {
  return new Promise((r) => setTimeout(r, ms));
}

function clampText(s, maxChars) {
  const t = String(s || "").trim();
  if (t.length <= maxChars) return t;
  return t.slice(0, maxChars) + "\n...[ุชู ูุต ุงููุต ูุชูุงุฏู ุงูุฃุฎุทุงุก]";
}

function normalizeArabic(s) {
  return String(s || "")
    .trim()
    .toLowerCase()
    .replace(/[\u064B-\u0652\u0670]/g, "")
    .replace(/[ุฃุฅุข]/g, "ุง")
    .replace(/ู/g, "ู")
    .replace(/ุฉ/g, "ู")
    .replace(/\s+/g, " ");
}

// =========================
// Quick choices sanitizer (prevents mismatched buttons)
// =========================
function tokenizeKeywords(s) {
  const t = normalizeArabic(s);
  const stop = new Set([
    "ูู","ูู","ุงูุด","ูุด","ูุง","ูุงุฐุง","ููู","ููุด","ููุงุฐุง","ูุชู","ููู","ุงูู","ุนูู","ูู","ูู","ุงูู","ุฅูู","ุนู",
    "ุงูุง","ุงูุช","ุงูุชู","ุงูุชู","ูู","ูู","ูู",
    "ุงูููู","ููููุง","ูููููุง","ุนุงุฏุฉ","ุบุงูุจุง","ุบุงูุจูุง","ุชูุฑูุจุง","ุชูุฑูุจูุง",
    "ูุงูู","ูุงููู","ูููุฉ","ุนูุฏู","ุนูุฏู","ุงุจุบู","ุงุจู","ูููู","ุชูุฏุฑ","ุงูุฏุฑ","ุฃูุฏุฑ",
    "ุงุดุฑุจ","ุชุดุฑุจ","ุดุฑุจ","ุงุดุฑุจู","ุชุดุฑุจู","ุงุดุฑุจู","ุชุดุฑุจูู","ุชุดุฑุจูู",
    "ูุนูู","ุจุณ","ุจุนุฏ","ูุจู","ูุน","ุจุฏูู","ุงู","ููุง","ูุงู","ูุฃู"
  ]);

  const words = t
    .split(" ")
    .map((w) => w.trim())
    .filter((w) => w && w.length >= 3 && !stop.has(w));

  return new Set(words);
}

function isAllowedQuickChoice(choice) {
  const c = String(choice || "").trim();
  if (!c) return false;
  return /^(ูุนู|ูุง|ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ|ุฅูุบุงุก|ุงูุบุงุก|ุชุฎุทู|ุฃูุชุจ ุงููุฑุงุกุฉ|ุงูุชุจ ุงููุฑุงุกุฉ|ูุง ุฃุนุฑู|ูุง ุงุนุฑู|ุจุฏูู ุญุณุงุจ|ุฃุญุณุจ|ุงุญุณุจ|ุฑูุงุจุท ุงูุชุญููู|ุฎุทูุงุช ุญุฌุฒ ููุนุฏ|ุนู ุจุฑูุงูุฌ ุดูุงุก)$/i.test(
    c
  );
}

/**
 * โ Ensures quick_choices match next_question (or verdict) at least loosely.
 * If not, we drop them to avoid confusing the user.
 */
function sanitizeQuickChoices(card) {
  if (!card || !Array.isArray(card.quick_choices) || card.quick_choices.length === 0) return card;

  // Keep deterministic menus and known flows as-is
  const title = String(card.title || "");
  if (/^(ุฏููู ุงูุนุงููุฉ|ุชูุถูุญ ุจุณูุท|ุชูุถูุญ ุณุฑูุน|๐ฉธ|๐ซ|โ๏ธ|๐ง|๐ฅ|๐ง|๐ฉน|๐|๐|๐ฅ|๐|๐งช|๐ฟ)/.test(title)) {
    return card;
  }

  const anchor = String(card.next_question || card.verdict || "").trim();
  if (!anchor) return { ...card, quick_choices: [] };

  const aKeys = tokenizeKeywords(anchor);
  const kept = card.quick_choices.filter((ch) => {
    if (isAllowedQuickChoice(ch)) return true;
    const cKeys = tokenizeKeywords(ch);
    for (const k of cKeys) if (aKeys.has(k)) return true;
    return false;
  });

  return { ...card, quick_choices: kept.length ? kept.slice(0, 6) : [] };
}

function isGreeting(text) {
  const t = normalizeArabic(text);
  return /^(ุงูุณูุงู ุนูููู|ุณูุงู ุนูููู|ุงูุณูุงู|ุณูุงู|ูุฑุญุจุง|ุงููุง|ููุง|ุตุจุงุญ ุงูุฎูุฑ|ูุณุงุก ุงูุฎูุฑ)([!ุ. ]*)$/.test(
    t
  );
}

function isThanks(text) {
  const t = normalizeArabic(text);
  return /^(ุดูุฑุง|ุดูุฑูุง|ูุดููุฑ|ูุนุทูู ุงูุนุงููู|ุฌุฒุงู ุงููู ุฎูุฑ)([!ุ. ]*)$/.test(t);
}

function looksLikeAppointments(text) {
  const t = String(text || "");
  return /ููุนุฏ|ููุงุนูุฏ|ุญุฌุฒ|ุงุญุฌุฒ|ุญุฌูุฒุงุช|ุญุฌุฒุช|ุญุฌุฒู|appointment|booking|ุดูุงุก/i.test(t);
}

function isEmergencyText(text) {
  return /(ุฃูู ุตุฏุฑ|ุงูู ุตุฏุฑ|ุถูู ููุณ|ุตุนูุจุฉ ุชููุณ|ุงุฎุชูุงู|ุฅุบูุงุก|ุงุบูุงุก|ุดูู|ุถุนู ููุงุฌุฆ|ูุฒูู ุดุฏูุฏ|ุชุดูุฌ|ููุจุฉ|ุงููุงุฑ ุงูุชุญุงุฑูุฉ|ุฃููุงุฑ ุงูุชุญุงุฑูุฉ|ุงูุชุญุงุฑ|ุงูุฐุงุก ุงูููุณ|ุฅูุฐุงุก ุงูููุณ)/i.test(
    String(text || "")
  );
}

function inferCategoryFromMessage(message) {
  const t = String(message || "");

  if (isEmergencyText(t)) return "emergency";
  if (looksLikeAppointments(t)) return "appointments";
  if (/(ุชูุฑูุฑ|ุชุญุงููู|ุชุญููู|ูุชูุฌุฉ|cbc|hba1c|cholesterol|vitamin|lab|report|pdf|ุตูุฑุฉ)/i.test(t))
    return "report";
  if (/(ููู|ุชูุชุฑ|ุงูุชุฆุงุจ|ูุฒุงุฌ|ููู|ุฃุฑู|panic|anxiety|depress)/i.test(t)) return "mental";
  if (/(bmi|ูุชูุฉ ุงูุฌุณู|ูุคุดุฑ ูุชูุฉ|ูุฒูู|ุทููู)/i.test(t)) return "bmi";
  if (/(ุถุบุท|ุถุบุท ุงูุฏู|systolic|diastolic|mmhg|ููู ุฒุฆุจูู)/i.test(t)) return "bp";
  if (/(ุณูุฑ|ุณูุฑู|glucose|mg\/dl|ุตุงุฆู|ุจุนุฏ ุงูุฃูู|ุจุนุฏ ุงูุงูู|hba1c)/i.test(t)) return "sugar";
  if (/(ูุงุก|ุณูุงุฆู|ุดุฑุจ|ุชุฑุทูุจ|hydration)/i.test(t)) return "water";
  if (/(ุณุนุฑุงุช|calories|ุฏุงูุช|ุฑุฌูู|ุชุฎุณูุณ|ุชูุญูู|ุฒูุงุฏุฉ ูุฒู|ูุธุงู ุบุฐุงุฆู)/i.test(t)) return "calories";
  if (/(ุงุณุนุงูุงุช|ุฅุณุนุงูุงุช|ุญุฑูู|ุฌุฑุญ|ุงุฎุชูุงู|ุฅุบูุงุก|ูุฒูู|ูุณุฑ|first aid)/i.test(t))
    return "first_aid";
  return "general";
}

/** โ ููู: ุงุณุชุซูุงุก ุงููุณุงุฑุงุช/ุงูุงุฎุชูุงุฑุงุช ูู "ุบุงูุถ" */
function isTooVague(text, session) {
  const t = String(text || "").trim();

  // โ ุฅุฐุง ูุงูุช ุฅุฌุงุจุฉ ูุนู/ูุง ุนูู ุณุคุงู ุณุงุจู (next_question)ุ ูุง ุชุนุชุจุฑูุง ุบุงูุถุฉ
  const hasPendingQ = !!session?.lastCard?.next_question;
  if (hasPendingQ && /^(ูุนู|ูุง)$/i.test(t)) return false;

  // ุฑููุฒ ุงููุณุงุฑุงุช
  if (/(๐ฉธ|๐ซ|โ๏ธ|๐ง|๐ฅ|๐ง|๐ฉน|๐|๐|๐ฅ|๐|๐งช|๐ฟ)/.test(t)) return false;

  // ูููุงุช ุงููุณุงุฑุงุช ุงูุฃุณุงุณูุฉ
  if (
    /^(ุงูุณูุฑ|ุณูุฑ|๐ฉธ ุงูุณูุฑ|๐ฉธ|ุงูุถุบุท|ุถุบุท|๐ซ ุงูุถุบุท|๐ซ|bmi|BMI|โ๏ธ BMI|โ๏ธ|ูุงุก|ุดุฑุจ ุงููุงุก|๐ง ุดุฑุจ ุงููุงุก|๐ง|ุณุนุฑุงุช|calories|๐ฅ ุงูุณุนุฑุงุช|๐ฅ|ูุฒุงุฌ|๐ง ุทูููุง ุนูู ูุฒุงุฌู|๐ง|ุงุณุนุงูุงุช|ุฅุณุนุงูุงุช|๐ฉน ุฅุณุนุงูุงุช ุฃูููุฉ|๐ฉน|ุงููู ุชูุฑูุฑู|๐ ุงููู ุชูุฑูุฑู|๐|ููุงุนูุฏ ุดูุงุก|๐ ููุงุนูุฏ ุดูุงุก|๐)$/i.test(
      t
    )
  )
    return false;

  // ูููุงุช ุงููุณุงุฑุงุช ุงููุคุณุณูุฉ ุงููุทููุจุฉ
  if (
    /^(๐\s*)?ุฅุฑุดุงุฏ ุฏูุงุฆู ุนุงู$/i.test(t) ||
    /^(๐งช\s*)?ุงูุชุญุถูุฑ ูููุฎุชุจุฑ ูุงูุชุญุงููู$/i.test(t) ||
    /^(๐ฉบ\s*)?ุชุซููู ุนู ูุฑุถ ุดุงุฆุน$/i.test(t) ||
    /^(๐ฟ\s*)?ุงูููุงูุฉ ูููุท ุงูุญูุงุฉ$/i.test(t) ||
    /^(๐ฅ\s*)?ุงูุชูุฌูู ุฏุงุฎู ุงูููุดุฃุฉ$/i.test(t) ||
    /^(๐\s*)?ููุงุนูุฏ ุดูุงุก( ูุงูุชุญุถูุฑ ููุง)?$/i.test(t)
  )
    return false;

  // ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ
  if (/^(ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ|ุงููุงุฆูู ุงูุฑุฆูุณูู|ูููู|ูุงุฆูุฉ|ุงุจุฏุฃ|ุงุจุฏุก)$/i.test(t)) return false;

  // ููุงุนุฏ ุงูุบููุถ
  if (t.length < 6) return true;
  if (t.length < 12 && !/[ุ?]/.test(t)) return true;
  return false;
}

function isBareYesNo(text) {
  return /^(ูุนู|ูุง|ok|okay)$/i.test(String(text || "").trim());
}

function makeCard({
  title,
  category,
  verdict,
  tips,
  when_to_seek_help,
  next_question,
  quick_choices,
}) {
  return {
    title: title || "ุฏููู ุงูุนุงููุฉ",
    category: category || "general",
    verdict: verdict || "",
    tips: Array.isArray(tips) ? tips : [],
    when_to_seek_help: when_to_seek_help || "",
    next_question: next_question || "",
    quick_choices: Array.isArray(quick_choices) ? quick_choices : [],
  };
}

function menuCard() {
  return makeCard({
    title: "ุฏููู ุงูุนุงููุฉ",
    category: "general",
    verdict: "ุงุฎุชุฑ ูุณุงุฑูุง (ูููุง ุฐููุฉ ุจุฃุณุฆูุฉ ุชุฎุตูุต ูุตูุฑุฉ):",
    tips: [],
    when_to_seek_help: "ุฅุฐุง ุฃุนุฑุงุถ ุฎุทูุฑุฉ (ุฃูู ุตุฏุฑ/ุถูู ููุณ/ุฅุบูุงุก/ูุฒูู ุดุฏูุฏ): ุทูุงุฑุฆ ููุฑูุง.",
    next_question: "ูุด ุชุญุจ ุชุจุฏุฃ ูููุ",
    quick_choices: [
      "๐ฉธ ุงูุณูุฑ",
      "๐ซ ุงูุถุบุท",
      "โ๏ธ BMI",
      "๐ง ุดุฑุจ ุงููุงุก",
      "๐ฅ ุงูุณุนุฑุงุช",
      "๐ง ุทูููุง ุนูู ูุฒุงุฌู",
      "๐ฉน ุฅุณุนุงูุงุช ุฃูููุฉ",
      "๐ ุงููู ุชูุฑูุฑู",
      "๐ ููุงุนูุฏ ุดูุงุก",
      // (ุงููุณุงุฑุงุช ุงููุคุณุณูุฉ ุชูุฏุงุฑ ูู ุงููุงุฌูุฉ ุนุจุฑ meta.route)
    ],
  });
}

function greetingCard() {
  return makeCard({
    title: "ุฏููู ุงูุนุงููุฉ",
    category: "general",
    verdict: "ูุนูููู ุงูุณูุงู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู ๐ฟ\nุฃูุง ููุง ููุชุซููู ุงูุตุญู. ููู ุฃูุฏุฑ ุฃุณุงุนุฏู ุงููููุ",
    tips: ["ุงุฎุชุฑ ูู ุงููุณุงุฑุงุช ุงูุณุฑูุนุฉ ุฃู ุงูุชุจ ุณุคุงูู ูุจุงุดุฑุฉ."],
    when_to_seek_help: "ุฅุฐุง ุนูุฏู ุฃูู ุตุฏุฑ/ุถูู ููุณ/ุฅุบูุงุก/ูุฒูู ุดุฏูุฏ: ุทูุงุฑุฆ ููุฑูุง.",
    next_question: "ูุด ุชุจุบู ุชุจุฏุฃ ูููุ",
    quick_choices: menuCard().quick_choices,
  });
}

function thanksCard() {
  return makeCard({
    title: "ุฏููู ุงูุนุงููุฉ",
    category: "general",
    verdict: "ุงูุนูู ๐ฟ ุฅุฐุง ุชุญุจุ ุงูุชุจ ุณุคุงูู ุงูุตุญู ูุจุงุดุฑุฉ ุฃู ุงุฎุชุฑ ูุณุงุฑ ูู ุงููุงุฆูุฉ.",
    tips: [],
    when_to_seek_help: "ุฅุฐุง ุฃุนุฑุงุถ ุทุงุฑุฆุฉ: ุทูุงุฑุฆ ููุฑูุง.",
    next_question: "ูุด ุชุญุจ ุชุณุฃูุ",
    quick_choices: ["๐ฉธ ุงูุณูุฑ", "๐ซ ุงูุถุบุท", "โ๏ธ BMI", "๐ง ุดุฑุจ ุงููุงุก", "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"],
  });
}

/* =========================
   Institutional paths (deterministic cards)
========================= */
function startInstitutionalFlow(session, route) {
  session.flow = route;
  session.step = 1;
  session.profile = {};

  METRICS.flows[`${route}Started`] = (METRICS.flows[`${route}Started`] || 0) + 1;

  if (route === "medication_general_guidance") {
    return makeCard({
      title: "๐ ุฅุฑุดุงุฏ ุฏูุงุฆู ุนุงู",
      category: "general",
      verdict:
        "ููุง **ุชุซููู ุนุงู** ุนู ุฃุดูุฑ ูุฆุงุช ุงูุฃุฏููุฉ (ุจุฏูู ูุตูุฉ/ุฌุฑุนุงุช).\n" +
        "ุงุฎุชุฑ ุจุทุงูุฉ:",
      tips: [
        "ูู ุฃุฐูุฑ ุฌุฑุนุงุช ุฃู ุฃุฏููุฉ ูุญุฏุฏุฉ ูุนูุงุฌ.",
        "ุฅุฐุง ูุฏูู ุญุณุงุณูุฉ ุฏูุงุฆูุฉ ุฃู ูุฑุถ ูุฒูู: ุงุณุชุดุฑ ุงูุทุจูุจ/ุงูุตูุฏูู.",
      ],
      when_to_seek_help:
        "ุฅุฐุง ุธูุฑุช ุญุณุงุณูุฉ ุดุฏูุฏุฉ (ุชูุฑู ูุฌู/ุถูู ููุณ/ุทูุญ ุดุฏูุฏ): ุทูุงุฑุฆ ููุฑูุง.",
      next_question: "ุฃู ูุฆุฉ ุชุฑูุฏ ุชูุฑุฃ ุนููุงุ",
      quick_choices: [
        "ูุถุงุฏ ุญููู",
        "ูุณููุงุช",
        "ูุถุงุฏ ุญุณุงุณูุฉ",
        "ุฃุฏููุฉ ุณุนุงู/ุฒูุงู",
        "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ",
      ],
    });
  }

  if (route === "lab_preparation") {
    return makeCard({
      title: "๐งช ุงูุชุญุถูุฑ ูููุฎุชุจุฑ ูุงูุชุญุงููู",
      category: "report",
      verdict: "ุงุฎุชุฑ ูุณุงุฑ ุฏุงุฎู ุงููุฎุชุจุฑ:",
      tips: [
        "ุฅุฐุง ุนูุฏู ุชุนูููุงุช ุฎุงุตุฉ ูู ุงูุทุจูุจ/ุงููุฎุชุจุฑ ููู ุงูุฃููู ุจุงูุชุทุจูู.",
        "ุจุนุถ ุงูุชุญุงููู ุชุญุชุงุฌ ุตูุงู ูุจุนุถูุง ูุง.",
      ],
      when_to_seek_help: "ุฅุฐุง ุนูุฏู ุฏูุฎุฉ ุดุฏูุฏุฉ/ุฅุบูุงุก ุจุนุฏ ุงูุณุญุจ: ุฑุงุฌุน ุงูุทุงูู ููุฑูุง.",
      next_question: "ูุด ุชุจูุ",
      quick_choices: ["๐งช ุงูุชุญุถูุฑ ูููุฎุชุจุฑ", "๐ ุงููู ุชูุฑูุฑู", "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"],
    });
  }

  if (route === "common_conditions_education") {
    return makeCard({
      title: "๐ฉบ ุชุซููู ุนู ูุฑุถ ุดุงุฆุน",
      category: "general",
      verdict: "ุงุฎุชุฑ ูุฑุถ ุดุงุฆุน ููุฑุงุกุฉ ุจุทุงูุฉ ุชุซููู ูุฎุชุตุฑุฉ:",
      tips: ["ูุนูููุฉ ุนุงูุฉ + ุฃุณุจุงุจ/ูุญูุฒุงุช + ููุงูุฉ + ูุชู ุชุฑุงุฌุน ุงูุทุจูุจ."],
      when_to_seek_help: "ุฃู ุฃุนุฑุงุถ ุดุฏูุฏุฉ/ูุชูุงููุฉ: ุฑุงุฌุน ุงูุทุจูุจ/ุงูุทูุงุฑุฆ.",
      next_question: "ุงุฎุชุฑ ูุฑุถ:",
      quick_choices: [
        "ุงูุณูุฑู",
        "ุงูุถุบุท",
        "ุงูุฑุจู",
        "ุงูููููู ุงูุนุตุจู",
        "ูุฒูุงุช ุงูุจุฑุฏ",
        "ุญุณุงุณูุฉ ููุณููุฉ",
        "ุขูุงู ุฃุณูู ุงูุธูุฑ",
        "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ",
      ],
    });
  }

  if (route === "prevention_lifestyle") {
    // โ ูุณุงุฑ ุงูููุงูุฉ = ูุณุงุฑุงุช ุฐููุฉ ููุท (ุญุฐู: ุงูุตุญุฉ ุงูุนุงูุฉ/ุงูููุงุนูุฏ/ุงูุทูุงุฑุฆ/ููู ุงูุชูุฑูุฑ + ุญุฐู ุงูุจุทุงูุงุช ุงูููุงุฆูุฉ ุงูุนุงูุฉ)
    return makeCard({
      title: "๐ฟ ุงูููุงูุฉ ูููุท ุงูุญูุงุฉ",
      category: "general",
      verdict: "ุงุฎุชุฑ ูุณุงุฑ ุฐูู:",
      tips: ["ุงููุณุงุฑุงุช ุงูุฐููุฉ ุชุณุฃูู ุฃุณุฆูุฉ ูุตูุฑุฉ ูุชุฎุตูุต ุงูุฅุฑุดุงุฏ."],
      when_to_seek_help: "ุฅุฐุง ุฃุนุฑุงุถ ุทุงุฑุฆุฉ: ุทูุงุฑุฆ ููุฑูุง.",
      next_question: "ูุด ุชุฎุชุงุฑุ",
      quick_choices: [
        "๐ฉธ ุงูุณูุฑ",
        "๐ซ ุงูุถุบุท",
        "โ๏ธ BMI",
        "๐ง ุดุฑุจ ุงููุงุก",
        "๐ฅ ุงูุณุนุฑุงุช",
        "๐ง ุทูููุง ุนูู ูุฒุงุฌู",
        "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ",
      ],
    });
  }

  if (route === "facility_navigation") {
    return makeCard({
      title: "๐ฅ ุงูุชูุฌูู ุฏุงุฎู ุงูููุดุฃุฉ",
      category: "general",
      verdict:
        "**ูุนูููุงุช ุฏุฎูู ูุฎุฏูุงุช ุงูููุดุฃุฉ (ูุฎุชุตุฑ ููุงุถุญ):**\n" +
        "โข ุฃุญุถุฑ **ุจุทุงูุฉ ุงูุดุฎุตูุฉ** ู **ุงูุจุทุงูุฉ ุงูุจูููุฉ**.\n" +
        "โข ุชุฃูุฏ ูู **ุชุฌุฏูุฏ/ุฏูุน ุงูุงุดุชุฑุงู ุงูุณููู** (ุญุณุจ ูุธุงู ุงูููุดุฃุฉ)ุ ูุซุงู ุชูุถูุญู: **1 ุฑูุงู ู200 ุจูุณุฉ ุณููููุง**.\n" +
        "โข ุฃุบูุจ ุงูุนูุงุฏุงุช ุชููู **ุจุงูููุงุนูุฏ**ุ ูุจุนุถูุง ูุฏ ูุชุทูุจ **ุชุญููู ูู ุงููุฑูุฒ ุงูุตุญู**.\n" +
        `โข ูุญุฌุฒ/ุงุณุชูุณุงุฑ ุงูููุงุนูุฏ ุนุจุฑ ูุงุชุณุงุจ: **${WHATSAPP_APPOINTMENTS}**\n\n` +
        "**ุงูุนูุงุฏุงุช ุงูุฎุงุฑุฌูุฉ ุงููุชููุฑุฉ ูุฏููุง:**\n" +
        "โข ุนูุงุฏุฉ ุฃุทูุงู\n" +
        "โข ุงูุฌูุฏูุฉ\n" +
        "โข ุฃุฐู ูุฃูู ูุญูุฌุฑุฉ\n" +
        "โข ุงูุนููู\n" +
        "โข ูุงุญุต ุจุตุฑูุงุช\n" +
        "โข ุงูุชุบุฐูุฉ\n" +
        "โข ุงูุนุธุงู\n" +
        "โข ุงูุฌุฑุงุญุฉ\n" +
        "โข ุงูุจุงุทููุฉ\n" +
        "โข ุงูุฃุดุนุฉ ุงูุณูููุฉ\n",
      tips: [
        "ุฅุฐุง ุงูุญุงูุฉ **ุทุงุฑุฆุฉ/ุถุฑูุฑูุฉ**: ูุฏ ูููู ุงูุญุถูุฑ ูุจุงุดุฑุฉ ุญุณุจ ุณูุงุณุงุช ุงูููุดุฃุฉ.",
        "ุงุญุชูุธ ุจุฃุณูุงุก ุงูุฃุฏููุฉ ูุงูุญุณุงุณูุงุช ุฅู ูุฌุฏุช ูุชุณุฑูุน ุงูุฅุฌุฑุงุกุงุช.",
      ],
      when_to_seek_help: "ุฅุฐุง ุฃุนุฑุงุถ ุฎุทูุฑุฉ: ุชูุฌู ููุทูุงุฑุฆ ููุฑูุง.",
      next_question: "ุชุญุจ ุชุฑุฌุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉุ",
      quick_choices: ["ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"],
    });
  }

  if (route === "shifaa_appointments") {
    return makeCard({
      title: "๐ ููุงุนูุฏ ุดูุงุก",
      category: "appointments",
      verdict:
        "ุชุทุจูู **ุดูุงุก** ูู ุจุฑูุงูุฌ ูุฒุงุฑุฉ ุงูุตุญุฉ ูู ุณูุทูุฉ ุนููุงู ูุฅุฏุงุฑุฉ ุงูููู ุงูุตุญู ูุงูููุงุนูุฏ.\n" +
        "ุงุฎุชุฑ ุจุทุงูุฉ:",
      tips: ["ูุฐู ูุนูููุงุช ุนุงูุฉ ุฏุงุฎู ุงูุชุทุจูู."],
      when_to_seek_help: "ุฅุฐุง ุญุงูุฉ ุทุงุฑุฆุฉ: ุงูุทูุงุฑุฆ ุฃูููุง.",
      next_question: "ูุด ุชุจุบูุ",
      quick_choices: ["ุฑูุงุจุท ุงูุชุญููู", "ุฎุทูุงุช ุญุฌุฒ ููุนุฏ", "ุนู ุจุฑูุงูุฌ ุดูุงุก", "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"],
    });
  }

  // fallback
  resetFlow(session);
  return menuCard();
}

function continueInstitutionalFlow(session, message) {
  const flow = session.flow;
  const m = String(message || "").trim();

  // allow return to main
  if (/^(ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ)$/i.test(m)) {
    resetFlow(session);
    METRICS.flows[`${flow}Completed`] = (METRICS.flows[`${flow}Completed`] || 0) + 1;
    return menuCard();
  }

  if (flow === "medication_general_guidance") {
    if (["ูุถุงุฏ ุญููู", "ูุณููุงุช", "ูุถุงุฏ ุญุณุงุณูุฉ", "ุฃุฏููุฉ ุณุนุงู/ุฒูุงู"].includes(m)) {
      let body = "";
      if (m === "ูุถุงุฏ ุญููู") {
        body =
          "ุงููุถุงุฏุงุช ุงูุญูููุฉ ุชูุณุชุฎุฏู **ูุจุนุถ ุงูุนุฏูู ุงูุจูุชูุฑูุฉ** ููุท.\n" +
          "โข ูุง ุชููุฏ ููุฒูุงู/ุงูุฅูููููุฒุง ุบุงูุจูุง ูุฃููุง ููุฑูุณุงุช.\n" +
          "โข ุณูุก ุงูุงุณุชุฎุฏุงู ูุฒูุฏ ููุงููุฉ ุงูุจูุชูุฑูุง.\n" +
          "โข ุฑุงุฌุน ุงูุทุจูุจ ุฅุฐุง ุญุฑุงุฑุฉ ุนุงููุฉ ูุณุชูุฑุฉุ ุตุนูุจุฉ ุชููุณุ ุฃูู ุดุฏูุฏุ ุฃู ุชุฏููุฑ.\n";
      }
      if (m === "ูุณููุงุช") {
        body =
          "ุงููุณููุงุช ุชุณุงุนุฏ ูู ุชุฎููู ุงูุฃูู/ุงูุญููู ุญุณุจ ุงูุญุงูุฉ.\n" +
          "โข ุงูุชุจู ููุญุณุงุณูุฉุ ุฃูุฑุงุถ ุงููุจุฏ/ุงููููุ ููุฑุญุฉ ุงููุนุฏุฉ.\n" +
          "โข ูุง ุชุฎูุท ุฃุฏููุฉ ูุชุดุงุจูุฉ ุจุฏูู ุงุณุชุดุงุฑุฉ.\n";
      }
      if (m === "ูุถุงุฏ ุญุณุงุณูุฉ") {
        body =
          "ุฃุฏููุฉ ุงูุญุณุงุณูุฉ ุชูุณุชุฎุฏู ูุฃุนุฑุงุถ ูุซู ุงูุนุทุงุณ/ุงูุญูุฉ/ุงูุทูุญ ุญุณุจ ุงูููุน.\n" +
          "โข ุจุนุถ ุงูุฃููุงุน ูุฏ ุชุณุจุจ ูุนุงุณ.\n" +
          "โข ุฅุฐุง ุชูุฑู ุจุงููุฌู ุฃู ุถูู ููุณ: ุทูุงุฑุฆ ููุฑูุง.\n";
      }
      if (m === "ุฃุฏููุฉ ุณุนุงู/ุฒูุงู") {
        body =
          "ุฃุฏููุฉ ุงูุฒูุงู ุบุงูุจูุง ุชูุฎูู ุงูุฃุนุฑุงุถ (ุงุญุชูุงู/ุณุนุงู) ููุง ุชุนุงูุฌ ุณุจุจ ุงูููุฑูุณ.\n" +
          "โข ุงุดุฑุจ ุณูุงุฆูุ ุฑุงุญุฉุ ูุฑุงูุจ ุนูุงูุงุช ุงูุฎุทุฑ.\n" +
          "โข ุฑุงุฌุน ุงูุทุจูุจ ุฅุฐุง ุญุฑุงุฑุฉ ูุฑุชูุนุฉ ูุณุชูุฑุฉ ุฃู ุตุนูุจุฉ ุชููุณ ุฃู ุฃูู ุตุฏุฑ.\n";
      }

      return makeCard({
        title: `๐ ุฅุฑุดุงุฏ ุฏูุงุฆู ุนุงู โ ${m}`,
        category: "general",
        verdict: body,
        tips: [
          "ุฅุฐุง ูุฏูู ูุฑุถ ูุฒูู/ุญูู/ุฃุทูุงู: ุงุณุชุดุฑ ุงูุทุจูุจ/ุงูุตูุฏูู ูุจู ุฃู ุงุณุชุฎุฏุงู.",
          "ุงูุฑุฃ ุงูุชุญุฐูุฑุงุช ูุงููุดุฑุฉ ุงููุฑููุฉ ุฏุงุฆููุง.",
        ],
        when_to_seek_help:
          "ุฃูู ุตุฏุฑ/ุถูู ููุณ/ุชูุฑู ูุฌู/ุทูุญ ุดุฏูุฏ/ุฅุบูุงุก: ุทูุงุฑุฆ ููุฑูุง.",
        next_question: "ุชุญุจ ุจุทุงูุฉ ุซุงููุฉุ",
        quick_choices: ["ูุถุงุฏ ุญููู", "ูุณููุงุช", "ูุถุงุฏ ุญุณุงุณูุฉ", "ุฃุฏููุฉ ุณุนุงู/ุฒูุงู", "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"],
      });
    }
    return startInstitutionalFlow(session, "medication_general_guidance");
  }

  if (flow === "lab_preparation") {
    if (m === "๐ ุงููู ุชูุฑูุฑู" || /ุงููู\s*ุชูุฑูุฑู/i.test(m)) {
      return makeCard({
        title: "๐ ุงููู ุชูุฑูุฑู",
        category: "report",
        verdict: "ุชูุงู. ุงุฑูุน ุตูุฑุฉ ุฃู PDF **ูุตู** ููุชูุฑูุฑ ูู ุฒุฑ ุงููุฑููุ ูุฃูุง ุฃุดุฑุญ ุจุดูู ุนุงู.",
        tips: ["ููุถู ุฅุฎูุงุก ุจูุงูุงุช ุดุฎุตูุฉ ุญุณุงุณุฉ ุฅู ุฃููู.", "ุตูุฑุฉ ูุงุถุญุฉ ูุฅุถุงุกุฉ ุฌูุฏุฉ ุชุณุงุนุฏ ูุซูุฑ."],
        when_to_seek_help: "ุฅุฐุง ุฃุนุฑุงุถ ุดุฏูุฏุฉ ูุน ุงูุชูุฑูุฑ: ุฑุงุฌุน ุงูุทุจูุจ/ุงูุทูุงุฑุฆ.",
        next_question: "ุฌุงูุฒ ุชุฑูุน ุงูุชูุฑูุฑุ",
        quick_choices: ["๐ ุฅุถุงูุฉ ูุฑูู", "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"],
      });
    }

    if (m === "๐งช ุงูุชุญุถูุฑ ูููุฎุชุจุฑ") {
      return makeCard({
        title: "๐งช ุงูุชุญุถูุฑ ูููุฎุชุจุฑ ูุงูุชุญุงููู",
        category: "report",
        verdict: "ุงุฎุชุฑ ููุน ุงูุชุญุถูุฑ:",
        tips: [
          "ุฅุฐุง ุงูุทุจูุจ ุทูุจ ุตูุงู: ุนุงุฏุฉ ูููู ูุงุก ููุท ูุณููุญ (ุญุณุจ ุชุนูููุงุช ุงููุฎุชุจุฑ).",
          "ุฃุฎุจุฑ ุงููุฎุชุจุฑ ุนู ุงูุฃุฏููุฉ ุงููุฒููุฉ/ุงูุญูู/ุงูุญุณุงุณูุฉ.",
        ],
        when_to_seek_help: "ุฏูุฎุฉ ุดุฏูุฏุฉ/ุฅุบูุงุก ุจุนุฏ ุงูุณุญุจ: ุฑุงุฌุน ุงูุทุงูู ููุฑูุง.",
        next_question: "ูุด ุงูุชุญููู ุงูุฃูุฑุจุ",
        quick_choices: ["ุชุญุงููู ุตูุงู", "ุชุญุงููู ุจูู", "ุชุญุงููู ุจุฑุงุฒ", "ุชุญุงููู ุฏููู", "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"],
      });
    }

    if (m === "ุชุญุงููู ุตูุงู") {
      return makeCard({
        title: "๐งช ุชุญุงููู ุตูุงู",
        category: "report",
        verdict:
          "**ุฅุฑุดุงุฏุงุช ุนุงูุฉ ููุตูุงู ูุจู ุงูุชุญุงููู:**\n" +
          "โข ุงุชุจุน ูุฏุฉ ุงูุตูุงู ุงูุชู ูุญุฏุฏูุง ุงููุฎุชุจุฑ/ุงูุทุจูุจ.\n" +
          "โข ุบุงูุจูุง ููุณูุญ ุจุงููุงุก ููุท.\n" +
          "โข ุชุฌูุจ ูุฌููุฏ ุดุฏูุฏ ูุจู ุงูุชุญููู.\n" +
          "โข ุฃุฎุจุฑ ุงููุฎุชุจุฑ ุนู ุงูุฃุฏููุฉ ุงููุฒููุฉ (ูุง ุชููู ุดูุก ูู ููุณู).\n",
        tips: ["ูู ุฌูุฏูุง ูุจู ุงูุชุญููู.", "ุงุดุฑุจ ูุงุก ูุชุณููู ุณุญุจ ุงูุฏู ุฅู ุณูุญ."],
        when_to_seek_help: "ุฅุฐุง ุดุนุฑุช ุจุฏูุฎุฉ ุดุฏูุฏุฉ ุฃู ุฅุบูุงุก: ุงุทูุจ ูุณุงุนุฏุฉ ููุฑูุง.",
        next_question: "ุชุจุบู ููุน ุชุญุงููู ุซุงููุฉุ",
        quick_choices: ["ุชุญุงููู ุจูู", "ุชุญุงููู ุจุฑุงุฒ", "ุชุญุงููู ุฏููู", "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"],
      });
    }

    if (m === "ุชุญุงููู ุจูู") {
      return makeCard({
        title: "๐งช ุชุญุงููู ุจูู",
        category: "report",
        verdict:
          "**ุฅุฑุดุงุฏุงุช ุนุงูุฉ ูุนููุฉ ุงูุจูู:**\n" +
          "โข ุงุณุชุฎุฏู ุนูุจุฉ ูุนููุฉ.\n" +
          "โข ูู ูุซูุฑ ูู ุงูุญุงูุงุช: ุนููุฉ ููุชุตู ุงูุจูู (midstream) ุชููู ุฃูุถู.\n" +
          "โข ุณููู ุงูุนููุฉ ุจุณุฑุนุฉ ูููุฎุชุจุฑ ุญุณุจ ุงูุชุนูููุงุช.\n",
        tips: ["ุงุบุณู ุงููุฏูู ูุจู ูุจุนุฏ.", "ูุง ุชููุณ ุฏุงุฎู ุงูุนูุจุฉ."],
        when_to_seek_help: "ุฅุฐุง ุฃูู ุดุฏูุฏ/ุญุฑุงุฑุฉ ุนุงููุฉ/ุฏู ูุงุถุญ ูู ุงูุจูู: ุฑุงุฌุน ุงูุทุจูุจ.",
        next_question: "ุชุจุบู ููุน ุชุญุงููู ุซุงููุฉุ",
        quick_choices: ["ุชุญุงููู ุตูุงู", "ุชุญุงููู ุจุฑุงุฒ", "ุชุญุงููู ุฏููู", "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"],
      });
    }

    if (m === "ุชุญุงููู ุจุฑุงุฒ") {
      return makeCard({
        title: "๐งช ุชุญุงููู ุจุฑุงุฒ",
        category: "report",
        verdict:
          "**ุฅุฑุดุงุฏุงุช ุนุงูุฉ ูุนููุฉ ุงูุจุฑุงุฒ:**\n" +
          "โข ุถุน ุงูุนููุฉ ูู ูุนุงุก ูุธูู/ูุฎุตุต.\n" +
          "โข ุชุฌูุจ ุงุฎุชูุงุทูุง ุจุงูุจูู/ุงููุงุก.\n" +
          "โข ุณููููุง ูููุฎุชุจุฑ ุฎูุงู ุงูููุช ุงููุญุฏุฏ.\n",
        tips: ["ุงุชุจุน ุชุนูููุงุช ุงููุฎุชุจุฑ ุงูุฎุงุตุฉ ุฅุฐุง ููุฌุฏุช.", "ุงุบุณู ุงููุฏูู ุฌูุฏูุง."],
        when_to_seek_help: "ุฅุณูุงู ุดุฏูุฏ ูุณุชูุฑ/ุฏู/ุฌูุงู: ุฑุงุฌุน ุงูุทุจูุจ.",
        next_question: "ุชุจุบู ููุน ุชุญุงููู ุซุงููุฉุ",
        quick_choices: ["ุชุญุงููู ุตูุงู", "ุชุญุงููู ุจูู", "ุชุญุงููู ุฏููู", "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"],
      });
    }

    if (m === "ุชุญุงููู ุฏููู") {
      return makeCard({
        title: "๐งช ุชุญุงููู ุฏููู",
        category: "report",
        verdict:
          "**ุฅุฑุดุงุฏุงุช ุนุงูุฉ ูุชุญููู ุงูุฏููู:**\n" +
          "โข ุจุนุถ ูุญูุตุงุช ุงูุฏููู ูุฏ ุชุญุชุงุฌ ุตูุงู ุญุณุจ ุณูุงุณุฉ ุงููุฎุชุจุฑ.\n" +
          "โข ุชุฌูุจ ูุฌุจุฉ ุฏุณูุฉ ูุจู ุงูุชุญููู.\n" +
          "โข ุฃุฎุจุฑ ุงููุฎุชุจุฑ ุนู ุงูุฃุฏููุฉ ุงููุฒููุฉ.\n",
        tips: ["ุงุชุจุน ุชุนูููุงุช ุงููุฎุชุจุฑ ุญุฑูููุง."],
        when_to_seek_help: "ุฅุฐุง ูุฏูู ุฃูู ุตุฏุฑ/ุถูู ููุณ: ุทูุงุฑุฆ ููุฑูุง.",
        next_question: "ุชุจุบู ููุน ุชุญุงููู ุซุงููุฉุ",
        quick_choices: ["ุชุญุงููู ุตูุงู", "ุชุญุงููู ุจูู", "ุชุญุงููู ุจุฑุงุฒ", "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"],
      });
    }

    return startInstitutionalFlow(session, "lab_preparation");
  }

  if (flow === "common_conditions_education") {
    const allowed = new Set([
      "ุงูุณูุฑู",
      "ุงูุถุบุท",
      "ุงูุฑุจู",
      "ุงูููููู ุงูุนุตุจู",
      "ูุฒูุงุช ุงูุจุฑุฏ",
      "ุญุณุงุณูุฉ ููุณููุฉ",
      "ุขูุงู ุฃุณูู ุงูุธูุฑ",
    ]);
    if (!allowed.has(m)) return startInstitutionalFlow(session, "common_conditions_education");

    let verdict = "";
    let tips = [];
    let seek = "ุฅุฐุง ุงูุฃุนุฑุงุถ ุดุฏูุฏุฉ/ุชุชูุงูู: ุฑุงุฌุน ุงูุทุจูุจ. ุฃูู ุตุฏุฑ/ุถูู ููุณ/ุฅุบูุงุก: ุทูุงุฑุฆ ููุฑูุง.";

    if (m === "ุงูุณูุฑู") {
      verdict =
        "ุงูุณูุฑู ูุนูู ุงุฑุชูุงุน ุณูุฑ ุงูุฏู ููุชุฑุงุช ุทูููุฉ.\n" +
        "ุงูุชุฑููุฒ ูููู ุนูู: ุงูุบุฐุงุก ุงููุชูุงุฒูุ ุงููุดุงุทุ ูุงููุชุงุจุนุฉ ุงูุทุจูุฉ.\n";
      tips = [
        "ููู ุงูุณูุฑูุงุช ูุงููุดุฑูุจุงุช ุงููุญูุงุฉ.",
        "ูุฌุจุงุช ูุชูุงุฒูุฉ: ุฎุถุงุฑ + ุจุฑูุชูู + ูุฑุจูููุฏุฑุงุช ูุนูุฏุฉ.",
        "ุญุงูุธ ุนูู ุญุฑูุฉ ููููุฉ ููุงุณุจุฉ.",
      ];
    }
    if (m === "ุงูุถุบุท") {
      verdict =
        "ุงุฑุชูุงุน ุงูุถุบุท ุบุงูุจูุง ุจูุง ุฃุนุฑุงุถ ูุงุถุญุฉุ ูููู ูุคุซุฑ ุนูู ุงูููุจ ูุงูููู ูุน ุงูููุช.\n" +
        "ุงูููู: ุชูููู ุงูููุญุ ูุดุงุท ููุชุธูุ ููุชุงุจุนุฉ ุงููุฑุงุกุงุช.\n";
      tips = [
        "ููู ุงูููุญ ูุงูุฃุทุนูุฉ ุงููุตูุนุฉ.",
        "ูุดุงุท ูุนุชุฏู ุฃุบูุจ ุฃูุงู ุงูุฃุณุจูุน.",
        "ููู ุฌูุฏ ูุชูููู ุงูุชูุชุฑ.",
      ];
    }
    if (m === "ุงูุฑุจู") {
      verdict =
        "ุงูุฑุจู ูุณุจุจ ุถูู ููุณ/ุตููุฑ ููุชุฃุซุฑ ุจุงููููุฌุงุช ูุซู ุงูุบุจุงุฑ ูุงูุฑูุงุฆุญ ูุงูุฏุฎุงู.\n" +
        "ุชุฌูุจ ุงููููุฌุงุช ูุฏุฑ ุงูุฅููุงู ูุงุชุจุงุน ุฎุทุฉ ุงูุทุจูุจ.\n";
      tips = [
        "ุชุฌูุจ ุงูุฏุฎุงู ูุงูุนุทูุฑ ุงููููุฉ ูุงูุบุจุงุฑ.",
        "ุฑุงูุจ ุฃู ูุญูุฒ ูุฒูุฏ ุงูุฃุนุฑุงุถ.",
        "ุฅุฐุง ุญุตูุช ููุจุฉ ุดุฏูุฏุฉ: ุงุทูุจ ูุณุงุนุฏุฉ ุทุจูุฉ ููุฑูุง.",
      ];
    }
    if (m === "ุงูููููู ุงูุนุตุจู") {
      verdict =
        "ุงูููููู ุงูุนุตุจู ูุณุจุจ ุงูุชูุงุฎ/ุฃูู ุจุทู/ุชุบูุฑุงุช ุจุงูุฅุฎุฑุงุฌ ุนูุฏ ุจุนุถ ุงูุฃุดุฎุงุต.\n" +
        "ุงูุชุญูู ูููู ุนุจุฑ ุงูุบุฐุงุก ูุชูููู ุงูุชูุชุฑ.\n";
      tips = [
        "ุณุฌูู ุงูุฃุทุนูุฉ ุงูุชู ุชููุฌ ุงูุฃุนุฑุงุถ ูุชุฌูุจูุง.",
        "ููู ุจุจุทุก ูููู ุงููุดุฑูุจุงุช ุงูุบุงุฒูุฉ.",
        "ุฅุฏุงุฑุฉ ุงูุชูุชุฑ (ูุดู/ุชููุณ/ููู).",
      ];
    }
    if (m === "ูุฒูุงุช ุงูุจุฑุฏ") {
      verdict =
        "ูุฒูุงุช ุงูุจุฑุฏ ุบุงูุจูุง ููุฑูุณูุฉ ูุชุชุญุณู ูุน ุงูููุช ูุงูุฑุงุญุฉ.\n" +
        "ุงูุนูุงุฌ ูููู ูุชุฎููู ุงูุฃุนุฑุงุถ ูุงูููุงูุฉ ูู ุงูุนุฏูู.\n";
      tips = [
        "ุฑุงุญุฉ + ุณูุงุฆู + ุชุบุฐูุฉ ุฎูููุฉ.",
        "ุชุฌูุจ ูุฎุงูุทุฉ ุงูุขุฎุฑูู ุฅุฐุง ุนูุฏู ุฃุนุฑุงุถ.",
        "ุฑุงูุจ ุนูุงูุงุช ุงูุฎุทุฑ (ุถูู ููุณ/ุฃูู ุตุฏุฑ/ุญุฑุงุฑุฉ ุนุงููุฉ ูุณุชูุฑุฉ).",
      ];
    }
    if (m === "ุญุณุงุณูุฉ ููุณููุฉ") {
      verdict =
        "ุงูุญุณุงุณูุฉ ุงูููุณููุฉ ุชุณุจุจ ุนุทุงุณ/ุญูุฉ/ุงุญุชูุงู ุจุณุจุจ ุงูุบุจุงุฑ/ุญุจูุจ ุงูููุงุญ.\n" +
        "ุงูููุงูุฉ: ุชูููู ุงูุชุนุฑุถ ูููููุฌุงุช ูุชูุธูู ุงูุฃูู ุญุณุจ ุงูุญุงุฌุฉ.\n";
      tips = [
        "ุชุฌูุจ ุงูุบุจุงุฑ ูุฏุฑ ุงูุฅููุงู ูุฃุบูู ุงูููุงูุฐ ููุช ุงูุนูุงุตู.",
        "ุงุณุชุญู/ุบููุฑ ุงูููุงุจุณ ุจุนุฏ ุงูุชุนุฑุถ ููุบุจุงุฑ.",
        "ุฅุฐุง ุถูู ููุณ ุดุฏูุฏ: ุทูุงุฑุฆ.",
      ];
    }
    if (m === "ุขูุงู ุฃุณูู ุงูุธูุฑ") {
      verdict =
        "ุฃูู ุฃุณูู ุงูุธูุฑ ุดุงุฆุน ููุฏ ูุฑุชุจุท ุจูุถุนูุงุช ุฌููุณ/ุฅุฌูุงุฏ ุนุถูู.\n" +
        "ุงูุชุญุณู ุบุงูุจูุง ูููู ูุน ุงูุญุฑูุฉ ุงูุฎูููุฉ ูุชุตุญูุญ ุงููุถุนูุฉ.\n";
      tips = [
        "ุชุฌูุจ ุงูุฌููุณ ุงูุทููู ูุฎุฐ ููุงุตู ุญุฑูุฉ.",
        "ุชูุงุฑูู ุชูุฏุฏ ูุทููุฉ ุฅุฐุง ูุง ูู ุฃูู ุดุฏูุฏ.",
        "ุฑุงุฌุน ุงูุทุจูุจ ุฅุฐุง ุฎุฏุฑ ุดุฏูุฏ/ุถุนู ุจุงูุณุงููู/ููุฏุงู ุงูุชุญูู ุจุงูุจูู.",
      ];
    }

    return makeCard({
      title: `๐ฉบ ุชุซููู ูุฎุชุตุฑ โ ${m}`,
      category: "general",
      verdict,
      tips,
      when_to_seek_help: seek,
      next_question: "ุชุจุบู ุชุฎุชุงุฑ ูุฑุถ ุซุงููุ",
      quick_choices: [
        "ุงูุณูุฑู",
        "ุงูุถุบุท",
        "ุงูุฑุจู",
        "ุงูููููู ุงูุนุตุจู",
        "ูุฒูุงุช ุงูุจุฑุฏ",
        "ุญุณุงุณูุฉ ููุณููุฉ",
        "ุขูุงู ุฃุณูู ุงูุธูุฑ",
        "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ",
      ],
    });
  }

  if (flow === "prevention_lifestyle") {
    // โ ุฌุณุฑ: ูู ุงููุณุชุฎุฏู ุงุฎุชุงุฑ ุฃุญุฏ "ุงููุณุงุฑุงุช ุงูุฐููุฉ" ูู ุฏุงุฎู ุงูููุงูุฉุ ูุฎุฑุฌ ูู ุงููุณุงุฑ ุงููุคุณุณู ููุจุฏุฃ ุงููุณุงุฑ ุงูุฐูู
    const smartMap = [
      { key: "bp", re: /^(๐ซ\s*)?(ุงูุถุบุท|ุถุบุท|ุถุบุท ุงูุฏู)$/i },
      { key: "sugar", re: /^(๐ฉธ\s*)?(ุงูุณูุฑ|ุณูุฑ)$/i },
      { key: "bmi", re: /^(โ๏ธ\s*)?(BMI|bmi|ูุชูู|ูุชูุฉ ุงูุฌุณู|ูุคุดุฑ ูุชูู)/i },
      { key: "water", re: /^(๐ง\s*)?(ุดุฑุจ ุงููุงุก|ูุงุก|ุชุฑุทูุจ)$/i },
      { key: "calories", re: /^(๐ฅ\s*)?(ุงูุณุนุฑุงุช|ุณุนุฑุงุช|calories|ุฑุฌูู|ุฏุงูุช)$/i },
      { key: "mental", re: /^(๐ง\s*)?(ุทู.?ูุง ุนูู ูุฒุงุฌู|ูุฒุงุฌ|ููู|ุชูุชุฑ|ุงูุชุฆุงุจ)$/i },
    ];

    const smart = smartMap.find((x) => x.re.test(m));
    if (smart) {
      // ุงุจุฏุฃ ุงููุณุงุฑ ุงูุฐูู
      resetFlow(session);
      return startFlow(session, smart.key);
    }

    // ุชู ุชุญููู ูุฐุง ุงููุณุงุฑ ุฅูู "ูุณุงุฑุงุช ุฐููุฉ ููุท" โ ุฃู ุงุฎุชูุงุฑ ุขุฎุฑ ูุฑุฌุน ูููุงุฆูุฉ ุงูุฎุงุตุฉ ุจุงูููุงูุฉ
    return startInstitutionalFlow(session, "prevention_lifestyle");
  }

  if (flow === "facility_navigation") {
    resetFlow(session);
    return menuCard();
  }

  if (flow === "shifaa_appointments") {
    if (m === "ุฑูุงุจุท ุงูุชุญููู") {
      return makeCard({
        title: "๐ ุดูุงุก โ ุฑูุงุจุท ุงูุชุญููู",
        category: "appointments",
        verdict: "ุฑูุงุจุท ุงูุชุญููู ุงูุฑุณููุฉ:",
        tips: [`ุฃูุฏุฑููุฏ: ${SHIFAA_ANDROID}`, `ุขูููู: ${SHIFAA_IOS}`],
        when_to_seek_help: "ุฅุฐุง ุฃุนุฑุงุถ ุทุงุฑุฆุฉ: ุงูุทูุงุฑุฆ ุฃูููุง.",
        next_question: "ุชุจุบู ุจุทุงูุฉ ุซุงููุฉุ",
        quick_choices: ["ุฎุทูุงุช ุญุฌุฒ ููุนุฏ", "ุนู ุจุฑูุงูุฌ ุดูุงุก", "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"],
      });
    }

    if (m === "ุฎุทูุงุช ุญุฌุฒ ููุนุฏ") {
      return makeCard({
        title: "๐ ุดูุงุก โ ุทุฑููุฉ ุญุฌุฒ ููุนุฏ",
        category: "appointments",
        verdict:
          "**ุฎุทูุงุช ุงูุญุฌุฒ ุฏุงุฎู ุชุทุจูู ุดูุงุก:**\n" +
          "1) ุงูุชุญ ุชุทุจูู ุดูุงุก.\n" +
          "2) ุงุถุบุท ุนูู **ุงูููุงุนูุฏ**.\n" +
          "3) ุงุฎุชุฑ **ุขุฎุฑ ุญุฌุฒ ููุนุฏ / ุญุฌุฒ ููุนุฏ**.\n" +
          "4) ุงุฎุชุฑ **ุงููุคุณุณุฉ** ุงูุชู ุชุฑูุฏูุง.\n" +
          "5) ุงุฎุชุฑ **ุงูุนูุงุฏุฉ ุงููุชููุฑุฉ**.\n",
        tips: ["ุฅุฐุง ูุง ุนูุฏู ุงูุชุทุจูู: ุงุณุชุฎุฏู ุจุทุงูุฉ ุฑูุงุจุท ุงูุชุญููู."],
        when_to_seek_help: "ุฅุฐุง ุฃุนุฑุงุถ ุทุงุฑุฆุฉ: ุงูุทูุงุฑุฆ ุฃูููุง.",
        next_question: "ุชุจุบู ุจุทุงูุฉ ุซุงููุฉุ",
        quick_choices: ["ุฑูุงุจุท ุงูุชุญููู", "ุนู ุจุฑูุงูุฌ ุดูุงุก", "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"],
      });
    }

    if (m === "ุนู ุจุฑูุงูุฌ ุดูุงุก") {
      return makeCard({
        title: "๐ ุนู ุจุฑูุงูุฌ ุดูุงุก",
        category: "appointments",
        verdict:
          "ุดูุงุก ุจุฑูุงูุฌ ูู ุณูุทูุฉ ุนููุงู ูุณุงุนุฏู ุจุฅุฏุงุฑุฉ ูููู ุงูุตุญู.\n" +
          "**ุฃุจุฑุฒ ุงูุฎูุงุฑุงุช ุฏุงุฎู ุดูุงุก (ุญุณุจ ูุง ุทูุจุช):**",
        tips: [
          "ุงูุณุฌูุงุช ุงูุทุจูุฉ: ุนุฑุถ ุฒูุงุฑุงุชู ูุงูุชุงุฑูุฎ ุงูุทุจู ูุงูุญุณุงุณูุฉ ูุงูุชุดุฎูุต ุงูููุงุฆู.",
          "ุฃูุฑุงุฏ ุงูุนุงุฆูุฉ: ุชูุฏุฑ ุชุดูู ุจูุงูุงุช ุฃูุฑุงุฏ ุงูุนุงุฆูุฉ ุฅุฐุง ุฃุนูุงุฑูู **ุฃูู ูู 18**. (ููู 18 ูุณุชุฎุฏู ุงูุชุทุจูู ุจููุณู).",
          "ุงููุญูุตุงุช ุงููุฎุจุฑูุฉ: ุชูุฏุฑ ุชุตูุฑ ุงูุดุงุดุฉ ูุชุณุชุฎุฏู **ุฏููู ุงูุนุงููุฉ** ูููู ุงูุชูุฑูุฑ.",
          "ุงููุณุชูุฏุงุช: ุทุจุงุนุฉ ุงูุฅุฌุงุฒุงุช ููุญููุง (ุญุณุจ ุงูุฅุชุงุญุฉ).",
          "ุงูุชุจุฑุน ุจุงูุฃุนุถุงุก: ุฎูุงุฑ ุถูู ุงูุฎุฏูุงุช (ุญุณุจ ุงูุฅุชุงุญุฉ).",
        ],
        when_to_seek_help: "ุฅุฐุง ุธูุฑุช ูุชุงุฆุฌ ููููุฉ ุฃู ุฃุนุฑุงุถ ูููุฉ: ุฑุงุฌุน ุงูุทุจูุจ/ุงูุทูุงุฑุฆ.",
        next_question: "ุชุจุบู ุจุทุงูุฉ ุซุงููุฉุ",
        quick_choices: ["ุฑูุงุจุท ุงูุชุญููู", "ุฎุทูุงุช ุญุฌุฒ ููุนุฏ", "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"],
      });
    }

    return startInstitutionalFlow(session, "shifaa_appointments");
  }

  return null;
}

/** Router ูุนู/ูุง ุจูุงุก ุนูู ุขุฎุฑ ุณุคุงู ูุนูู */
function yesNoRouter(session, message) {
  const lastQ = String(session?.lastCard?.next_question || "").trim();
  if (!lastQ) return null;

  const m = String(message || "").trim();
  const isYes = /^ูุนู$/i.test(m);
  const isNo = /^ูุง$/i.test(m);
  if (!isYes && !isNo) return null;

  if (/ููุท\s*ุญูุงู|ููุท ุญูุงุฉ|ุจุฏู\s*ุงูุนูุงุฌ|ุจุฏู ุงูุนูุงุฌ/i.test(lastQ)) {
    if (isYes) {
      return makeCard({
        title: "๐ฟ ูุตุงุฆุญ ููุท ุญูุงุฉ",
        category: "general",
        verdict: "ูุฐู ูุตุงุฆุญ ุนุงูุฉ ูุขููุฉ ุชุณุงุนุฏ ูุซูุฑูุง:",
        tips: [
          "ุฎููู ุงูุณูุฑูุงุช ูุงููุดุฑูุจุงุช ุงููุญููุงุฉ ูุฏุฑ ุงูุฅููุงู.",
          "ุงุฎุชุฑ ูุฌุจุงุช ูุชูุงุฒูุฉ: ุจุฑูุชูู + ุฎุถุงุฑ + ูุฑุจูููุฏุฑุงุช ูุนูุฏุฉ.",
          "ูุดุงุท ุจุฏูู ูุนุชุฏู 30 ุฏูููุฉ ูุนุธู ุฃูุงู ุงูุฃุณุจูุน (ูุดู ุณุฑูุน).",
          "ููู ููุชุธู ูุชูููู ุงูุณูุฑ.",
          "ุงุดุฑุจ ูุงุก ุจุงูุชุธุงู ูููู ุงููุฌุจุงุช ุงูุณุฑูุนุฉ.",
        ],
        when_to_seek_help:
          "ุฅุฐุง ุงูุฃุนุฑุงุถ ูุณุชูุฑุฉ/ุชุณูุก ุฃู ุธูุฑุช ุนูุงูุงุช ุฎุทูุฑุฉ (ุฃูู ุตุฏุฑ/ุถูู ููุณ/ุฅุบูุงุก): ุฑุงุฌุน ุงูุทุจูุจ/ุงูุทูุงุฑุฆ.",
        next_question: "ุชุญุจ ูุฑูุฒ ุนูู: ุงูุชุบุฐูุฉ ููุง ุงููุดุงุท ุงูุจุฏููุ",
        quick_choices: ["ุงูุชุบุฐูุฉ", "ุงููุดุงุท ุงูุจุฏูู", "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"],
      });
    }
    if (isNo) {
      return makeCard({
        title: "ุฏููู ุงูุนุงููุฉ",
        category: "general",
        verdict: "ุชูุงู.",
        tips: [],
        when_to_seek_help: "ุฅุฐุง ุฃุนุฑุงุถ ุทุงุฑุฆุฉ: ุทูุงุฑุฆ ููุฑูุง.",
        next_question: "ุชุฑุฌุน ูููุงุฆูุฉ ุงูุฑุฆูุณูุฉุ",
        quick_choices: ["ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"],
      });
    }
  }

  if (/ุดุฑุญ|ุฎุทูุงุช|ุชูุงุตูู/i.test(lastQ)) {
    if (isYes) {
      return makeCard({
        title: "ุชูุถูุญ",
        category: session.lastCard?.category || "general",
        verdict: "ุชูุงู. ุงูุชุจ ูู: ูุด ุจุงูุถุจุท ุชุจุบู ุฃุนุฑูู ุนูููุ",
        tips: ["ูุซุงู: ุฎุทูุงุช ุงูุญุฌุฒุ ุชุนุฏูู ููุนุฏุ ุฅูุบุงุกุ ุฃู ุทุฑููุฉ ุงูุงุณุชุฎุฏุงู."],
        when_to_seek_help: "",
        next_question: "ูุด ุชุจุบู ุชุญุฏูุฏูุงุ",
        quick_choices: ["ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ", "ุฅูุบุงุก"],
      });
    }
    if (isNo) {
      return makeCard({
        title: "ุฏููู ุงูุนุงููุฉ",
        category: "general",
        verdict: "ุชู ๐",
        tips: [],
        when_to_seek_help: "",
        next_question: "ุชุญุจ ุชุณุฃู ุดูุก ุซุงููุ",
        quick_choices: ["ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"],
      });
    }
  }

  return null;
}

/* =========================
   Flow engine (existing smart flows)
========================= */
function startFlow(session, flowKey) {
  session.flow = flowKey;
  session.step = 1;
  session.profile = {};
  METRICS.flows[`${flowKey}Started`]++;
  bumpCategory(flowKey);

  const commonAge = ["ุฃูู ูู 18", "18โ40", "41โ60", "60+"];

  if (flowKey === "sugar") {
    return makeCard({
      title: "๐ฉธ ูุณุงุฑ ุงูุณูุฑ ุงูุฐูู",
      category: "sugar",
      verdict: "ุนุดุงู ุฃุนุทูู ูุนูููุงุช ููุงุณุจุฉุ ุงุฎุชุฑ ูุฆุชู ุงูุนูุฑูุฉ:",
      tips: [],
      when_to_seek_help: "",
      next_question: "",
      quick_choices: commonAge,
    });
  }

  if (flowKey === "bp") {
    return makeCard({
      title: "๐ซ ูุณุงุฑ ุงูุถุบุท ุงูุฐูู",
      category: "bp",
      verdict: "ุงุฎุชุฑ ูุฆุชู ุงูุนูุฑูุฉ:",
      tips: [],
      when_to_seek_help: "",
      next_question: "",
      quick_choices: commonAge,
    });
  }

  if (flowKey === "bmi") {
    return makeCard({
      title: "โ๏ธ ูุณุงุฑ BMI ุงูุฐูู",
      category: "bmi",
      verdict: "ูุด ูุฏูู ุงูุขูุ",
      tips: [],
      when_to_seek_help: "",
      next_question: "",
      quick_choices: ["ุฅููุงุต ูุฒู", "ุฒูุงุฏุฉ ูุฒู", "ุชุญุณูู ููุงูุฉ", "ูุชุงุจุนุฉ ุนุงูุฉ"],
    });
  }

  if (flowKey === "water") {
    return makeCard({
      title: "๐ง ูุณุงุฑ ุดุฑุจ ุงููุงุก ุงูุฐูู",
      category: "water",
      verdict: "ูุด ูุถุน ูุดุงุทู ุงููููู ุบุงูุจูุงุ",
      tips: [],
      when_to_seek_help: "",
      next_question: "",
      quick_choices: ["ุฎููู (ุนูู ููุชุจู)", "ูุชูุณุท", "ุนุงูู/ุฑูุงุถุฉ"],
    });
  }

  if (flowKey === "calories") {
    return makeCard({
      title: "๐ฅ ูุณุงุฑ ุงูุณุนุฑุงุช ุงูุฐูู",
      category: "calories",
      verdict: "ูุด ูุฏููุ",
      tips: [],
      when_to_seek_help: "",
      next_question: "",
      quick_choices: ["ุฅููุงุต ูุฒู", "ุชุซุจูุช ูุฒู", "ุฒูุงุฏุฉ ูุฒู", "ุชุญุณูู ุฃูู ุตุญู"],
    });
  }

  if (flowKey === "mental") {
    return makeCard({
      title: "๐ง ูุณุงุฑ ุงููุฒุงุฌ ุงูุฐูู",
      category: "mental",
      verdict: "ุฎูุงู ุขุฎุฑ ุฃุณุจูุนุ ููู ูุงู ูุฒุงุฌู ุบุงูุจูุงุ",
      tips: [],
      when_to_seek_help: "",
      next_question: "",
      quick_choices: ["ููุชุงุฒ", "ุฌูุฏ", "ูุชุนุจ", "ุณูุฆ"],
    });
  }

  if (flowKey === "first_aid") {
    return makeCard({
      title: "๐ฉน ูุณุงุฑ ุงูุฅุณุนุงูุงุช ุงูุฃูููุฉ ุงูุฐูู",
      category: "general",
      verdict:
        "ุฃูุฏู ุฅุฑุดุงุฏุงุช ุนุงูุฉ ูุจุณูุทุฉ ููุท.\n" +
        "๐จ ุนูุงูุงุช ุฎุทุฑ ุชุณุชุฏุนู ุงูุทูุงุฑุฆ ููุฑูุง: ุฃูู ุตุฏุฑ ุดุฏูุฏ/ุถูู ููุณ ุดุฏูุฏ/ูุฒูู ุดุฏูุฏ/ููุฏุงู ูุนู/ุชุดูุฌุงุช/ุญุณุงุณูุฉ ุดุฏูุฏุฉ.\n" +
        "ุฅุฐุง ูุง ูู ุนูุงูุงุช ุฎุทุฑุ ุงุฎุชุฑ ุงูุญุงูุฉ ุงูุฃูุฑุจ:",
      tips: [],
      when_to_seek_help: "ุฅุฐุง ููุฏุงู ูุนู/ูุฒูู ุดุฏูุฏ/ุตุนูุจุฉ ุชููุณ: ุงุชุตู ุจุงูุฅุณุนุงู ููุฑูุง.",
      next_question: "ูุด ุงูุญุงูุฉ ุงูุฃูุฑุจุ",
      quick_choices: ["ุญุฑูู ุจุณูุทุฉ", "ุฌุฑุญ/ูุฒูู ุจุณูุท", "ุงุฎุชูุงู", "ุฅุบูุงุก", "ุงูุชูุงุก/ูุฏูุฉ", "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"],
    });
  }

  return menuCard();
}

function parseWeightHeight(text) {
  const t = String(text || "").toLowerCase();
  const w = t.match(/(\d{2,3})\s*(kg|ูุฌู|ูุบ|ูููู|ููููุฌุฑุงู)?/i);
  const h = t.match(/(\d{2,3})\s*(cm|ุณู|ุณูุชููุชุฑ)?/i);
  const w2 = t.match(/ูุฒู\s*[:=]?\s*(\d{2,3})/i);
  const h2 = t.match(/ุทูู\s*[:=]?\s*(\d{2,3})/i);

  const weight = w2 ? Number(w2[1]) : w ? Number(w[1]) : null;
  const height = h2 ? Number(h2[1]) : h ? Number(h[1]) : null;

  const W = weight && weight >= 25 && weight <= 250 ? weight : null;
  const H = height && height >= 100 && height <= 220 ? height : null;

  return { weightKg: W, heightCm: H };
}

function bmiFrom(weightKg, heightCm) {
  const h = heightCm / 100;
  const bmi = weightKg / (h * h);
  return Math.round(bmi * 10) / 10;
}

function continueFlow(session, message) {
  const flow = session.flow;
  const step = session.step;
  const m = String(message || "").trim();

  const commonAge = ["ุฃูู ูู 18", "18โ40", "41โ60", "60+"];

  if (flow === "sugar") {
    if (step === 1) {
      session.profile.ageGroup = m;
      session.step = 2;
      return makeCard({
        title: "๐ฉธ ูุณุงุฑ ุงูุณูุฑ ุงูุฐูู",
        category: "sugar",
        verdict: "ูู ุชู ุชุดุฎูุตู ุจุงูุณูุฑู ูู ูุจูุ",
        tips: [],
        when_to_seek_help: "",
        next_question: "",
        quick_choices: ["ูุนู", "ูุง", "ุบูุฑ ูุชุฃูุฏ"],
      });
    }
    if (step === 2) {
      session.profile.diagnosed = m;
      session.step = 3;
      return makeCard({
        title: "๐ฉธ ูุณุงุฑ ุงูุณูุฑ ุงูุฐูู",
        category: "sugar",
        verdict: "ูุด ูุฏูู ุงูุขูุ",
        tips: [],
        when_to_seek_help: "",
        next_question: "",
        quick_choices: ["ููู ูุจุณุท", "ุฃูู ููุงุณุจ", "ุชูููู ุงูุงุฑุชูุงุนุงุช", "ูุชุงุจุนุฉ ุนุงูุฉ"],
      });
    }
    if (step === 3) {
      session.profile.goal = m;
      session.step = 4;
      return null;
    }
  }

  if (flow === "bp") {
    if (step === 1) {
      session.profile.ageGroup = m;
      session.step = 2;
      return makeCard({
        title: "๐ซ ูุณุงุฑ ุงูุถุบุท ุงูุฐูู",
        category: "bp",
        verdict: "ูู ุชู ุชุดุฎูุตู ุจุถุบุท ุงูุฏู ูู ูุจูุ",
        tips: [],
        when_to_seek_help: "",
        next_question: "",
        quick_choices: ["ูุนู", "ูุง", "ุบูุฑ ูุชุฃูุฏ"],
      });
    }
    if (step === 2) {
      session.profile.diagnosed = m;
      session.step = 3;
      return makeCard({
        title: "๐ซ ูุณุงุฑ ุงูุถุบุท ุงูุฐูู",
        category: "bp",
        verdict: "ูู ูุฏูู ูุฑุงุกุฉ ุถุบุท ุงูุขู/ูุคุฎุฑูุงุ (ุงุฎุชูุงุฑู)",
        tips: ["ุฅุฐุง ุชุนุฑููุงุ ุงูุชุจูุง ูุซู: 120/80. ุฃู ุงุฎุชุฑ: ูุง ุฃุนุฑู."],
        when_to_seek_help: "",
        next_question: "",
        quick_choices: ["ุฃูุชุจ ุงููุฑุงุกุฉ", "ูุง ุฃุนุฑู"],
      });
    }
    if (step === 3) {
      if (/ูุง\s*ุฃุนุฑู/i.test(m)) {
        session.profile.reading = "unknown";
        session.step = 4;
        return null;
      }
      session.profile.reading = "pending";
      session.step = 31;
      return makeCard({
        title: "๐ซ ูุณุงุฑ ุงูุถุบุท ุงูุฐูู",
        category: "bp",
        verdict: "ุงูุชุจ ูุฑุงุกุฉ ุงูุถุบุท ุจุงูุดูู (ุงููุจุงุถู/ุงูุจุณุงุทู) ูุซู: 120/80",
        tips: [],
        when_to_seek_help: "",
        next_question: "",
        quick_choices: ["ุฅูุบุงุก"],
      });
    }
    if (step === 31) {
      session.profile.readingValue = m;
      session.step = 4;
      return null;
    }
  }

  if (flow === "bmi") {
    if (step === 1) {
      session.profile.goal = m;
      session.step = 2;
      return makeCard({
        title: "โ๏ธ ูุณุงุฑ BMI ุงูุฐูู",
        category: "bmi",
        verdict: "ุงุฎุชุฑ ูุฆุชู ุงูุนูุฑูุฉ:",
        tips: [],
        when_to_seek_help: "",
        next_question: "",
        quick_choices: commonAge,
      });
    }
    if (step === 2) {
      session.profile.ageGroup = m;
      session.step = 3;
      return makeCard({
        title: "โ๏ธ ูุณุงุฑ BMI ุงูุฐูู",
        category: "bmi",
        verdict: "ูู ุชุจู ุฃุญุณุจ BMIุ",
        tips: ["ุฅุฐุง ูุนู: ุงูุชุจ ูุฒู ูุทูู ูุซู: ูุฒู 70ุ ุทูู 170"],
        when_to_seek_help: "",
        next_question: "",
        quick_choices: ["ุฃุญุณุจ", "ุจุฏูู ุญุณุงุจ"],
      });
    }
    if (step === 3) {
      if (/ุจุฏูู/i.test(m)) {
        session.profile.calc = "no";
        session.step = 4;
        return null;
      }
      session.profile.calc = "yes";
      session.step = 32;
      return makeCard({
        title: "โ๏ธ ูุณุงุฑ BMI ุงูุฐูู",
        category: "bmi",
        verdict: "ุงูุชุจ ุงููุฒู ูุงูุทูู ูุซู: ูุฒู 70ุ ุทูู 170",
        tips: [],
        when_to_seek_help: "",
        next_question: "",
        quick_choices: ["ุฅูุบุงุก"],
      });
    }
    if (step === 32) {
      const { weightKg, heightCm } = parseWeightHeight(m);
      session.profile.weightKg = weightKg;
      session.profile.heightCm = heightCm;
      if (weightKg && heightCm) session.profile.bmi = bmiFrom(weightKg, heightCm);
      session.step = 4;
      return null;
    }
  }

  if (flow === "water") {
    if (step === 1) {
      session.profile.activity = m;
      session.step = 2;
      return makeCard({
        title: "๐ง ูุณุงุฑ ุดุฑุจ ุงููุงุก ุงูุฐูู",
        category: "water",
        verdict: "ููู ุงูุฌู ุนูุฏู ุบุงูุจูุง ูุฐู ุงููุชุฑุฉุ",
        tips: [],
        when_to_seek_help: "",
        next_question: "",
        quick_choices: ["ูุนุชุฏู", "ุญุงุฑ", "ูููู ุฃุบูุจ ุงูููุช"],
      });
    }
    if (step === 2) {
      session.profile.climate = m;
      session.step = 3;
      return makeCard({
        title: "๐ง ูุณุงุฑ ุดุฑุจ ุงููุงุก ุงูุฐูู",
        category: "water",
        verdict: "ูู ุชูุฏุฑ: ุงูุชุจ ูุฒูู ุจุงููููู (ุงุฎุชูุงุฑู) ุฃู ุงุฎุชุฑ: ุชุฎุทู",
        tips: ["ูุซุงู: 70"],
        when_to_seek_help: "",
        next_question: "",
        quick_choices: ["ุชุฎุทู"],
      });
    }
    if (step === 3) {
      if (/ุชุฎุทู/i.test(m)) {
        session.profile.weightKg = null;
        session.step = 4;
        return null;
      }
      const n = Number(String(m).match(/\d{2,3}/)?.[0]);
      session.profile.weightKg = n && n >= 25 && n <= 250 ? n : null;
      session.step = 4;
      return null;
    }
  }

  if (flow === "calories") {
    if (step === 1) {
      session.profile.goal = m;
      session.step = 2;
      return makeCard({
        title: "๐ฅ ูุณุงุฑ ุงูุณุนุฑุงุช ุงูุฐูู",
        category: "calories",
        verdict: "ูุณุชูู ูุดุงุทู ุงูููููุ",
        tips: [],
        when_to_seek_help: "",
        next_question: "",
        quick_choices: ["ุฎููู", "ูุชูุณุท", "ุนุงูู"],
      });
    }
    if (step === 2) {
      session.profile.activity = m;
      session.step = 3;
      return makeCard({
        title: "๐ฅ ูุณุงุฑ ุงูุณุนุฑุงุช ุงูุฐูู",
        category: "calories",
        verdict: "ุงุฎุชุฑ ูุฆุชู ุงูุนูุฑูุฉ:",
        tips: [],
        when_to_seek_help: "",
        next_question: "",
        quick_choices: commonAge,
      });
    }
    if (step === 3) {
      session.profile.ageGroup = m;
      session.step = 4;
      return null;
    }
  }

  if (flow === "mental") {
    if (step === 1) {
      session.profile.mood = m;
      session.step = 2;
      return makeCard({
        title: "๐ง ูุณุงุฑ ุงููุฒุงุฌ ุงูุฐูู",
        category: "mental",
        verdict: "ููู ูููู ุฎูุงู ุขุฎุฑ ุฃุณุจูุนุ",
        tips: [],
        when_to_seek_help: "",
        next_question: "",
        quick_choices: ["ุฌูุฏ", "ูุชูุณุท", "ุณูุฆ", "ุฃุฑู ุดุฏูุฏ"],
      });
    }
    if (step === 2) {
      session.profile.sleep = m;
      session.step = 3;
      return makeCard({
        title: "๐ง ูุณุงุฑ ุงููุฒุงุฌ ุงูุฐูู",
        category: "mental",
        verdict: "ูุด ุฃูุซุฑ ุดุนูุฑ ูุฒุนุฌุ",
        tips: [],
        when_to_seek_help: "",
        next_question: "",
        quick_choices: ["ููู", "ุชูุชุฑ", "ุญุฒู", "ุถุบุท ุนูู", "ุฃููุงุฑ ูุซูุฑุฉ"],
      });
    }
    if (step === 3) {
      session.profile.feeling = m;
      session.step = 4;
      return null;
    }
  }

  if (flow === "first_aid") {
    if (step === 1) {
      const allowed = new Set(["ุญุฑูู ุจุณูุทุฉ", "ุฌุฑุญ/ูุฒูู ุจุณูุท", "ุงุฎุชูุงู", "ุฅุบูุงุก", "ุงูุชูุงุก/ูุฏูุฉ"]);
      if (!allowed.has(m)) {
        return startFlow(session, "first_aid");
      }
      session.profile.scenario = m;
      session.step = 4;
      return null;
    }
  }

  if (flow === "general") {
    if (step === 1) {
      session.profile.intent = m;
      session.step = 4;
      return null;
    }
  }

  return null;
}

/* =========================
   Groq call (Structured JSON)
========================= */
const CARD_SCHEMA = {
  type: "object",
  additionalProperties: false,
  properties: {
    title: { type: "string" },
    category: {
      type: "string",
      enum: [
        "general",
        "emergency",
        "appointments",
        "report",
        "mental",
        "bmi",
        "bp",
        "sugar",
        "water",
        "calories",
      ],
    },
    verdict: { type: "string" },
    tips: { type: "array", items: { type: "string" } },
    when_to_seek_help: { type: "string" },
    next_question: { type: "string" },
    quick_choices: { type: "array", items: { type: "string" } },
  },
  required: ["title", "category", "verdict", "tips", "when_to_seek_help", "next_question", "quick_choices"],
};

function chatSystemPrompt() {
  return (
    "ุฃูุช ูุณุงุนุฏ ุชุซููู ุตุญู ููุทุ ููุณุช ุทุจูุจูุง ููุง ุจุฏููุงู ุนู ุงูุงุณุชุดุงุฑุฉ ุงูุทุจูุฉ.\n" +
    "ุฅุฐุง ุจุฏุฃ ุงููุณุชุฎุฏู ุจุชุญูุฉุ ุงุจุฏุฃ ุจุฑุฏ ุงุฌุชูุงุนู ูุตูุฑ ุซู ุงูุชูู ููุณุคุงู ุงูุตุญู.\n" +
    "ูุฏูู ูุนูููุงุช ุนุงูุฉ ุนู ุงูุตุญุฉ ูููุท ุงูุญูุงุฉ ุจุฃุณููุจ ุนุฑุจู ูุงุถุญ ููุฎุชุตุฑ.\n" +
    "ููููุน ููุนูุง ุจุงุชูุง: ุงูุชุดุฎูุตุ ูุตู ุงูุฃุฏููุฉุ ุงูุฌุฑุนุงุชุ ุฃู ุฎุทุฉ ุนูุงุฌ.\n" +
    "ุงุฐูุฑ ูุชู ูุฌุจ ูุฑุงุฌุนุฉ ุงูุทุจูุจ/ุงูุทูุงุฑุฆ ุนูุฏ ุฃุนุฑุงุถ ุฎุทูุฑุฉ.\n" +
    "ุฅุฐุง ูู ุชูู ูุชุฃูุฏูุงุ ูู: ูุง ุฃุนูู.\n" +
    "ุฃุฎุฑุฌ JSON ููุท ุจุงูููุงุชูุญ ุงููุญุฏุฏุฉ.\n"
  );
}

function reportSystemPrompt() {
  return (
    "ุฃูุช ูุณุงุนุฏ ุชุซููู ุตุญู ุนุฑุจู ูุดุฑุญ ูุชุงุฆุฌ ุงูุชุญุงููู/ุงูุชูุงุฑูุฑ.\n" +
    "ุงููุฏุฎู ูุต ููุณุชุฎุฑุฌ ูู ุตูุฑุฉ/ููู.\n" +
    "ุงุดุฑุญ ุจุงูุนุฑุจูุฉ ุจุดูู ุนุงู + ูุตุงุฆุญ ุนุงูุฉ + ูุชู ูุฑุงุฌุน ุงูุทุจูุจ.\n" +
    "ููููุน: ุชุดุฎูุต ูุคูุฏุ ุฌุฑุนุงุชุ ูุตู ุนูุงุฌ.\n" +
    "ุฃุฎุฑุฌ JSON ููุท ุจููุณ ููุงุชูุญ ุงูุจุทุงูุฉ.\n"
  );
}

async function callGroqJSON({ system, user, maxTokens = 1400 }) {
  if (!GROQ_API_KEY) throw new Error("Missing GROQ_API_KEY");

  const url = "https://api.groq.com/openai/v1/chat/completions";
  const body = {
    model: GROQ_MODEL,
    temperature: 0.2,
    max_tokens: maxTokens,
    response_format: {
      type: "json_schema",
      json_schema: { name: "dalil_alafiyah_card", strict: true, schema: CARD_SCHEMA },
    },
    messages: [
      { role: "system", content: system },
      { role: "user", content: user },
    ],
  };

  for (let attempt = 0; attempt < 3; attempt++) {
    const res = await fetch(url, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${GROQ_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify(body),
    });

    if (res.status === 429) {
      await sleep(1200 + attempt * 700);
      continue;
    }

    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(`Groq API error: ${res.status} ${JSON.stringify(data)}`);

    const text = data?.choices?.[0]?.message?.content || "";
    const parsed = safeJsonParse(text);
    if (parsed) return parsed;

    await sleep(350);
  }

  throw new Error("Groq returned invalid JSON repeatedly");
}


function isMedicationQuestion(userText) {
  const raw = String(userText || "").trim();
  if (!raw) return false;
  const t = normalizeArabic(raw);

  // Units / dosage patterns
  if (/(ุฌุฑุนู|ุฌุฑุนุงุช|mg|ููุบ|mcg|ยตg|g|ุฌุฑุงู|ml|ูู|cc|dose|dosage)/i.test(raw)) return true;

  // Generic medication vocabulary
  if (
    /(ุฏูุงุก|ุงุฏููู|ุงุฏููุฉ|ุญุจูุจ|ุญุจู|ูุฑุต|ุงูุฑุงุต|ูุจุณูู|ูุจุณููู|ุดุฑุงุจ|ุจุฎุงุฎ|ูุฑูู|ูุฑูู|ูุทุฑู|ูุทุฑุฉ|ุญูู|ุญููู|ุงูุณูููู|ูุถุงุฏ|ูุณูู|ูุถุงุฏ ุญููู)/i.test(
      t
    )
  )
    return true;

  // Common drug names (extend as needed)
  if (
    /(paracetamol|panadol|ibuprofen|brufen|diclofenac|voltaren|metformin|insulin|amoxicillin|augmentin|omeprazole|esomeprazole|loratadine|cetirizine)/i.test(
      raw
    )
  )
    return true;

  // Actions tied to meds
  if (
    /(ุงุฎุฐ|ุฎุฐ|ุชูุงูู|ุงุณุชุฎุฏู|ุงุณุชุนูู|ุงุจุฏุง|ุงุจุฏุฃ|ููู|ุงููู|ุฃููู)/i.test(t) &&
    /(ุฏูุงุก|ุญุจูุจ|ูุฑุต|ูุจุณูู|ุดุฑุงุจ|ุจุฎุงุฎ|ูุฑูู|ูุฑูู|ูุทุฑู|ุญูู|ุงูุณูููู|ูุถุงุฏ|ูุณูู)/i.test(t)
  )
    return true;

  return false;
}

/* =========================
   Safety post-filter (โ ุฃูู ุฅุฒุนุงุฌูุง)
========================= */
function postFilterCard(card, userMessage = "") {
  // โ ุชูุจูู ุงูุฃุฏููุฉ ูุธูุฑ ููุท ุฅุฐุง ุณุคุงู ุงููุณุชุฎุฏู ููุณู ุฏูุงุฆู
  const medQ = isMedicationQuestion(userMessage);

  const combined =
    (card?.verdict || "") +
    "\n" +
    (Array.isArray(card?.tips) ? card.tips.join("\n") : "") +
    "\n" +
    (card?.when_to_seek_help || "");

  // 1) ุณูุงู ุฏูุงุฆู
  const hasMedContext =
    /(ุฏูุงุก|ุงุฏููู|ุงุฏููุฉ|ุญุจูุจ|ูุฑุต|ูุจุณูู|ูุจุณููุฉ|ุดุฑุงุจ|ุจุฎุงุฎ|ูุฑูู|ูุฑูู|ูุทุฑู|ูุทุฑุฉ|ุญูู|ุงูุณูููู|ูุถุงุฏ|ูุณูู|antibiotic|metformin|ibuprofen|paracetamol)/i.test(
      combined
    );

  // 2) ุฌุฑุนุงุช/ูุญุฏุงุช
  const hasDoseUnit = /(\b\d{1,4}\b)\s*(mg|ููุบ|mcg|ยตg|g|ุฌุฑุงู|ูู|ml|cc)\b/i.test(combined);
  const hasDailyFrequency = /(ูุฑุฉ|ูุฑุชูู|ุซูุงุซ|ุงุฑุจุน|4)\s*(ููููุง|ูููููุง|ูู ุงูููู)/i.test(combined);

  // 3) ุฃูุนุงู ูุตู ูุจุงุดุฑ
  const hasDirectPrescriptionVerb =
    /(ุฎุฐ|ุฎุฐู|ุชูุงูู|ุชูุงููู|ุงุณุชุฎุฏู|ุงุณุชุฎุฏูู|ุงุจุฏุฃ|ุงุจุฏุง)\s+/i.test(combined) && hasMedContext;

  // ุฅุฐุง ุงูุณุคุงู ููุณ ุฏูุงุฆู โ ูุง ูุนุฑุถ ุชูุจูู ุฃุฏููุฉ ุญุชู ูู ุงูุฑุฏ ุฐูุฑ "ูุณูู" ุจุดูู ุนุงู
  if (medQ && hasMedContext && (hasDoseUnit || hasDailyFrequency || hasDirectPrescriptionVerb)) {
    return makeCard({
      title: "ุชูุจูู",
      category: card?.category || "general",
      verdict:
        "ุฃูุง ููุชุซููู ุงูุตุญู ููุทุ ููุง ุฃูุฏุฑ ุฃูุตู ุฃุฏููุฉ ุฃู ุฃุญุฏุฏ ุฌุฑุนุงุช.\n" +
        "ุฅุฐุง ุณุคุงูู ุนู ุฏูุงุก/ุฌุฑุนุฉ: ุงูุฃูุถู ุชุชูุงุตู ูุน ุทุจูุจ/ุตูุฏูู.",
      tips: ["ุงูุชุจ ููุทุจูุจ: ุงูุฃุนุฑุงุถ + ูุฏุฉ ุงููุดููุฉ + ุงูุฃุฏููุฉ ุงูุญุงููุฉ + ุงูุญุณุงุณูุฉ (ุฅู ูุฌุฏุช)."],
      when_to_seek_help: "ุฅุฐุง ุฃูู ุตุฏุฑ/ุถูู ููุณ/ุฅุบูุงุก/ูุฒูู ุดุฏูุฏ: ุทูุงุฑุฆ ููุฑูุง.",
      next_question: "ุชุจุบู ูุนูููุงุช ุชุซููููุฉ ุนุงูุฉ ุนู ุงูุญุงูุฉ ุจุฏู ุงูุนูุงุฌุ",
      quick_choices: ["ูุนู", "ูุง", "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"],
    });
  }

  // โ ุฃุฎูุฑูุง: ูุธูู ุงูุฃุฒุฑุงุฑ ุงูุนุดูุงุฆูุฉ
  return sanitizeQuickChoices(card);
}

/* =========================
   Routes
========================= */
app.get("/", (req, res) => {
  res.json({
    ok: true,
    service: "Dalil Alafiyah API",
    routes: ["/chat", "/report", "/reset", "/metrics"],
  });
});

app.get("/health", (req, res) => {
  res.json({ ok: true });
});

app.get("/metrics", (req, res) => {
  res.json({ ok: true, data: METRICS });
});

app.post("/reset", (req, res) => {
  const userId = getUserId(req);
  sessions.delete(userId);
  res.json({ ok: true });
});

app.post("/chat", async (req, res) => {
  const t0 = Date.now();
  METRICS.chatRequests++;

  const userId = getUserId(req);
  const session = getSession(userId);

  const message = String(req.body?.message || "").trim();
  if (!message) return res.status(400).json({ ok: false, error: "empty_message" });

  // โ Dedup
  const now = Date.now();
  if (session.lastInText === message && now - (session.lastInAt || 0) < 900) {
    const fallback = session.lastCard || menuCard();
    return res.json({ ok: true, data: fallback, dedup: true });
  }
  session.lastInText = message;
  session.lastInAt = now;

  // ========= Institutional routing from app meta.route =========
  const route = String(req.body?.meta?.route || "").trim();
  if (route) {
    const institutionalRoutes = new Set([
      "medication_general_guidance",
      "lab_preparation",
      "common_conditions_education",
      "prevention_lifestyle",
      "facility_navigation",
      "shifaa_appointments",
    ]);

    if (institutionalRoutes.has(route)) {
      const card = startInstitutionalFlow(session, route);
      session.lastCard = card;
      bumpCategory(card.category);
      METRICS.chatOk++;
      updateAvgLatency(Date.now() - t0);
      return res.json({ ok: true, data: card });
    }
  }

  // ุชุญูุฉ/ุดูุฑ
  if (isGreeting(message)) {
    const card = greetingCard();
    session.lastCard = card;
    bumpCategory("general");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }
  if (isThanks(message)) {
    const card = thanksCard();
    session.lastCard = card;
    bumpCategory("general");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }

  // ูุณุญ/ุฅูุบุงุก
  if (/^(ุฅูุบุงุก|ุงูุบุงุก|cancel|ูุณุญ|ูุณุญ ุงููุญุงุฏุซุฉ|ุงุจุฏุฃ ูู ุฌุฏูุฏ|ุงุจุฏุฃ ุฌุฏูุฏ)$/i.test(message)) {
    resetFlow(session);
    const card = menuCard();
    session.lastCard = card;
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }

  // ุทูุงุฑุฆ
  if (isEmergencyText(message)) {
    METRICS.emergencyTriggers++;
    const card = makeCard({
      title: "โ๏ธ ุชูุจูู ุทุงุฑุฆ",
      category: "emergency",
      verdict:
        "ุงูุฃุนุฑุงุถ ุงููุฐููุฑุฉ ูุฏ ุชููู ุฎุทูุฑุฉ.\n" +
        "ูููุตุญ ุจุงูุชูุฌู ูุฃูุฑุจ ุทูุงุฑุฆ ุฃู ุงูุงุชุตุงู ุจุงูุฅุณุนุงู ููุฑูุง.",
      tips: ["ูุง ุชูุชุธุฑ.", "ุฅุฐุง ูุนู ุดุฎุตุ ุงุทูุจ ูุณุงุนุฏุชู ููุฑูุง."],
      when_to_seek_help: "ุงูุขู.",
      next_question: "ูู ุฃูุช ูู ุฃูุงู ุงูุขูุ",
      quick_choices: ["ูุนู", "ูุง"],
    });
    session.lastCard = card;
    bumpCategory("emergency");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }

  // ููุงุนูุฏ (ุงููุชุงุจุฉ ุงูุญุฑุฉ)
  if (looksLikeAppointments(message)) {
    const card = startInstitutionalFlow(session, "shifaa_appointments");
    session.lastCard = card;
    bumpCategory("appointments");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }

  // ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ
  if (/^(ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ|ุงููุงุฆูู ุงูุฑุฆูุณูู|ูููู|ูุงุฆูุฉ|ุงุจุฏุฃ|ุงุจุฏุก)$/i.test(message)) {
    resetFlow(session);
    const card = menuCard();
    session.lastCard = card;
    bumpCategory("general");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }

  // โโโ FIX: ูุง ูุฎูู "ุชุญุงููู" ูุฎุทู ุฎูุงุฑุงุช ุงููุฎุชุจุฑ
  const isLabOption =
    /^(ุชุญุงููู ุตูุงู|ุชุญุงููู ุจูู|ุชุญุงููู ุจุฑุงุฒ|ุชุญุงููู ุฏููู)$/i.test(message);

  // ุงููู ุชูุฑูุฑู (ูุตูุฑ) โ ููู ุจุฏูู ุชุฎุฑูุจ ูุณุงุฑ ุงููุฎุชุจุฑ ูุฎูุงุฑุงุชู
  if (
    !isLabOption &&
    session.flow !== "lab_preparation" &&
    /(ุงููู\s*ุชูุฑูุฑู|ุชูุฑูุฑ)/i.test(message) &&
    message.length <= 30
  ) {
    const card = makeCard({
      title: "๐ ุงููู ุชูุฑูุฑู",
      category: "report",
      verdict: "ุชูุงู. ุงุฑูุน ุตูุฑุฉ ุฃู PDF ููุชูุฑูุฑ ูู ุฒุฑ ุงููุฑููุ ูุฃูุง ุฃุดุฑุญ ุจุดูู ุนุงู.",
      tips: ["ูุง ุชุฑูุน ุจูุงูุงุช ุดุฎุตูุฉ ุญุณุงุณุฉ ุฅู ุฃููู."],
      when_to_seek_help: "ุฅุฐุง ุฃุนุฑุงุถ ุดุฏูุฏุฉ ูุน ุงูุชูุฑูุฑ: ุฑุงุฌุน ุงูุทุจูุจ/ุงูุทูุงุฑุฆ.",
      next_question: "ุฌุงูุฒ ุชุฑูุน ุงูุชูุฑูุฑุ",
      quick_choices: ["๐ ุฅุถุงูุฉ ูุฑูู", "ุฅูุบุงุก", "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"],
    });
    session.lastCard = card;
    bumpCategory("report");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }

  const inferred = inferCategoryFromMessage(message);

  // โ ูุชุงุจุนุฉ ุงููุณุงุฑ ุฃูููุง
  // 1) institutional flows
  if (
    session.flow &&
    [
      "medication_general_guidance",
      "lab_preparation",
      "common_conditions_education",
      "prevention_lifestyle",
      "facility_navigation",
      "shifaa_appointments",
    ].includes(session.flow)
  ) {
    const card = continueInstitutionalFlow(session, message);
    if (card) {
      session.lastCard = card;
      bumpCategory(card.category);
      METRICS.chatOk++;
      updateAvgLatency(Date.now() - t0);
      return res.json({ ok: true, data: card });
    }
  }

  // 2) existing smart flows
  if (session.flow && session.step > 0 && session.step < 4) {
    const card = continueFlow(session, message);
    if (card) {
      session.lastCard = card;
      METRICS.chatOk++;
      updateAvgLatency(Date.now() - t0);
      return res.json({ ok: true, data: card });
    }
  }

  // ุจุฏุก ุงููุณุงุฑุงุช (ุงููุฏููุฉ)
  const startMap = [
    { key: "sugar", match: /๐ฉธ|ุณูุฑ|ุงูุณูุฑ/i },
    { key: "bp", match: /๐ซ|ุถุบุท|ุงูุถุบุท/i },
    { key: "bmi", match: /โ๏ธ|bmi|BMI|ูุชูุฉ/i },
    { key: "water", match: /๐ง|ูุงุก|ุดุฑุจ ุงููุงุก|ุชุฑุทูุจ/i },
    { key: "calories", match: /๐ฅ|ุณุนุฑุงุช|calories|ุฑุฌูู|ุฏุงูุช/i },
    { key: "mental", match: /๐ง|ูุฒุงุฌ|ููู|ุชูุชุฑ|ุงูุชุฆุงุจ/i },
    { key: "first_aid", match: /๐ฉน|ุงุณุนุงูุงุช|ุฅุณุนุงูุงุช|ุญุฑูู|ุฌุฑุญ/i },
    { key: "general", match: /ูุงุฆูุฉ|ูููู|ุงุจุฏุฃ|ุงุจุฏุก/i },
  ];

  if (!session.flow) {
    const short = message.length <= 40;
    const matched = startMap.find((x) => x.match.test(message));
    if (short && matched) {
      const card = startFlow(session, matched.key);
      session.lastCard = card;
      METRICS.chatOk++;
      updateAvgLatency(Date.now() - t0);
      return res.json({ ok: true, data: card });
    }

    if (
      short &&
      ["sugar", "bp", "bmi", "water", "calories", "mental", "first_aid"].includes(inferred)
    ) {
      const card = startFlow(session, inferred);
      session.lastCard = card;
      METRICS.chatOk++;
      updateAvgLatency(Date.now() - t0);
      return res.json({ ok: true, data: card });
    }
  }

  // YES/NO Router (ุจุนุฏ ุงููุณุงุฑุงุช)
  const yn = yesNoRouter(session, message);
  if (yn) {
    session.lastCard = yn;
    bumpCategory(yn.category);
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: yn });
  }

  // Bare yes/no ููุท ุฅุฐุง ูุง ูู ุณุคุงู ุณุงุจู
  if (!session.flow && isBareYesNo(message) && !session.lastCard?.next_question) {
    const card = makeCard({
      title: "ุฏููู ุงูุนุงููุฉ",
      category: "general",
      verdict: "ูุถุญ ูู ุฃูุซุฑ ๐",
      tips: ["ุงูุชุจ ุณุคุงูู ุจุดูู ุฃูุถุญ ุฃู ุงุฎุชุฑ ูุณุงุฑ ูู ุงููุงุฆูุฉ."],
      when_to_seek_help: "ุฅุฐุง ุฃุนุฑุงุถ ุทุงุฑุฆุฉ: ุทูุงุฑุฆ ููุฑูุง.",
      next_question: "ูุด ุชุจุบู ุชุณุฃูุ",
      quick_choices: menuCard().quick_choices,
    });
    session.lastCard = card;
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }

  // ุฑุณุงูุฉ ูุตูุฑุฉ/ุบุงูุถุฉ
  const inCompletedFlow = session.flow && session.step === 4;
  if (!inCompletedFlow && isTooVague(message, session)) {
    const card = makeCard({
      title: "ุชูุถูุญ ุณุฑูุน",
      category: inferred === "emergency" ? "emergency" : inferred || "general",
      verdict: "ุฃูุฏุฑ ุฃุณุงุนุฏูุ ุจุณ ุฃุญุชุงุฌ ุชูุงุตูู ุจุณูุทุฉ ุนุดุงู ูุง ุฃุนุทูู ุฑุฏ ุนุงู.",
      tips: ["ุงูุชุจ: ุงูุนูุฑ ุงูุชูุฑูุจู + ุงูุฃุนุฑุงุถ + ูุฏุชูุง + ูู ููู ุญุฑุงุฑุฉ/ุฃูู ุดุฏูุฏุ"],
      when_to_seek_help: "ุฅุฐุง ุฃูู ุตุฏุฑ/ุถูู ููุณ/ุฅุบูุงุก/ูุฒูู ุดุฏูุฏ: ุทูุงุฑุฆ ููุฑูุง.",
      next_question: "ูุด ุงูุฃุนุฑุงุถ ุจุงูุถุจุท ููุชู ุจุฏุฃุชุ",
      quick_choices: ["ุฃุนุฑุงุถ ุจุฏุฃุช ุงูููู", "ูู ููููู", "ุฃุณุจูุน+", "ุงููุงุฆูุฉ ุงูุฑุฆูุณูุฉ"],
    });
    session.lastCard = card;
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }

  // ====== LLM fallback ======
  session.history.push({ role: "user", content: message });
  session.history = trimHistory(session.history, 10);

  const last = req.body?.context?.last || session.lastCard || null;
  const lastStr = last ? clampText(JSON.stringify(last), 1200) : "";
  const msgStr = clampText(message, 1200);

  const profileStr =
    session.flow && session.step === 4 ? clampText(JSON.stringify(session.profile), 1200) : "";

  const historyStr = clampText(
    session.history
      .slice(-6)
      .map((x) => `${x.role === "user" ? "ุงููุณุชุฎุฏู" : "ุงููุณุงุนุฏ"}: ${x.content}`)
      .join("\n"),
    1800
  );

  let forcedCategory = null;
  if (session.flow === "sugar" && session.step === 4) forcedCategory = "sugar";
  if (session.flow === "bp" && session.step === 4) forcedCategory = "bp";
  if (session.flow === "bmi" && session.step === 4) forcedCategory = "bmi";
  if (session.flow === "water" && session.step === 4) forcedCategory = "water";
  if (session.flow === "calories" && session.step === 4) forcedCategory = "calories";
  if (session.flow === "mental" && session.step === 4) forcedCategory = "mental";
  if (session.flow === "first_aid" && session.step === 4) forcedCategory = "general";
  if (session.flow === "general" && session.step === 4) forcedCategory = "general";

  const userPrompt =
    (historyStr ? `ุณูุงู ุงููุญุงุฏุซุฉ (ุขุฎุฑ ุฑุณุงุฆู):\n${historyStr}\n\n` : "") +
    (profileStr ? `ุจูุงูุงุช ุชุฎุตูุต (ุงุฎุชูุงุฑุงุช ุงููุณุชุฎุฏู):\n${profileStr}\n\n` : "") +
    (last ? `ุณูุงู ุขุฎุฑ ุจุทุงูุฉ (ูุง ุชูุฑุฑูุง ุญุฑูููุงุ ุงุณุชุฎุฏููุง ููุท ุฅุฐุง ูุฑุชุจุทุฉ):\n${lastStr}\n\n` : "") +
    `ุณุคุงู ุงููุณุชุฎุฏู:\n${msgStr}\n\n` +
    "ุงูุงูุชุฒุงู: ูุง ุชุดุฎูุตุ ูุง ุฃุฏููุฉุ ูุง ุฌุฑุนุงุช.\n" +
    "ูุฏูู ูุตุงุฆุญ ุนุงูุฉ ุนูููุฉ + ูุชู ูุฑุงุฌุน ุงูุทุจูุจ/ุงูุทูุงุฑุฆ.\n" +
    "ููู: ูุง ุชุนูุฏ ููุณ ุงูุจุทุงูุฉ ุงูุณุงุจูุฉ ุฅุฐุง ูุงู ุฌูุงุจ ุงููุณุชุฎุฏู ูุตูุฑูุง.\n" +
    "ููู ุฌุฏูุง: ุฅุฐุง ุฃุถูุช quick_choices ูุงุฒู ุชููู ุฃุฒุฑุงุฑ ูุฑุชุจุทุฉ ูุจุงุดุฑุฉ ุจุณุคุงู next_question ูุจููุณ ุงูููุถูุนุ ูุฅุฐุง ูุง ุนูุฏู ุฎูุงุฑุงุช ุฏูููุฉ ุฎูููุง ูุตูููุฉ ูุงุถูุฉ [].\n";

  try {
    const obj = await callGroqJSON({
      system: chatSystemPrompt(),
      user: userPrompt,
      maxTokens: 1200,
    });

    let finalCategory = obj?.category || inferred || "general";
    if (forcedCategory) {
      finalCategory = forcedCategory;
      METRICS.flows[`${session.flow}Completed`]++;
      resetFlow(session);
    } else {
      if (inferred && finalCategory !== inferred && finalCategory !== "appointments") {
        finalCategory = inferred;
      }
    }

    const card = makeCard({ ...obj, category: finalCategory });
    const safeCard = postFilterCard(card, message);

    session.lastCard = safeCard;
    session.history.push({ role: "assistant", content: JSON.stringify(safeCard) });
    session.history = trimHistory(session.history, 10);

    bumpCategory(safeCard.category);
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);

    return res.json({ ok: true, data: safeCard });
  } catch (err) {
    console.error("[chat] FAILED:", err?.message || err);
    METRICS.chatFail++;
    updateAvgLatency(Date.now() - t0);
    return res.status(502).json({ ok: false, error: "model_error" });
  }
});

app.post("/report", upload.single("file"), async (req, res) => {
  const t0 = Date.now();
  METRICS.reportRequests++;

  const userId = getUserId(req);
  const session = getSession(userId);

  const file = req.file;
  if (!file) return res.status(400).json({ ok: false, error: "missing_file" });

  try {
    let extracted = "";

    if (file.mimetype === "application/pdf") {
      const parsed = await pdfParse(file.buffer).catch(() => null);
      extracted = parsed?.text ? String(parsed.text) : "";
      extracted = extracted.replace(/\s+/g, " ").trim();

      if (extracted.length < 40) {
        METRICS.reportFail++;
        updateAvgLatency(Date.now() - t0);
        return res.json({
          ok: false,
          error: "pdf_no_text",
          message:
            "ูุฐุง PDF ูุจุฏู ููุณูุญ (Scan) ููุง ูุญุชูู ูุตูุง ูุงุจููุง ูููุณุฎ. ุงุฑูุน ุตูุฑุฉ ูุงุถุญุฉ ููุชูุฑูุฑ ุฃู ุงูุตู ุงููุต.",
        });
      }
    } else if (file.mimetype.startsWith("image/")) {
      extracted = await ocrImageBuffer(file.buffer);
      extracted = extracted.replace(/\s+/g, " ").trim();

      if (extracted.length < 25) {
        METRICS.reportFail++;
        updateAvgLatency(Date.now() - t0);
        return res.json({
          ok: false,
          error: "ocr_failed",
          message: "ุงูุตูุฑุฉ ูู ุชููุฑุฃ ุจูุถูุญ. ุญุงูู ุตูุฑุฉ ุฃูุถุญ.",
        });
      }
    } else {
      METRICS.reportFail++;
      updateAvgLatency(Date.now() - t0);
      return res.status(400).json({ ok: false, error: "unsupported_type" });
    }

    const extractedClamped = clampText(extracted, 6000);

    const userPrompt =
      "ูุต ูุณุชุฎุฑุฌ ูู ุชูุฑูุฑ/ุชุญุงููู:\n" +
      extractedClamped +
      "\n\n" +
      "ุงุดุฑุญ ุจุงูุนุฑุจูุฉ ุจุดูู ุนุงู: ูุงุฐุง ูุนูู + ูุตุงุฆุญ ุนุงูุฉ + ูุชู ูุฑุงุฌุน ุงูุทุจูุจ.\n" +
      "ุงูุชุฒู ุจูุง ูุฑุฏ ูู ุงูุชูุฑูุฑ ููุท.\n" +
      "ููููุน ุชุดุฎูุต ูุคูุฏ ุฃู ุฌุฑุนุงุช ุฃู ูุตู ุนูุงุฌ.";

    const obj = await callGroqJSON({
      system: reportSystemPrompt(),
      user: userPrompt,
      maxTokens: 1600,
    });

    const card = postFilterCard(makeCard({ ...obj, category: "report" }), "");
    session.lastCard = card;

    bumpCategory("report");
    METRICS.reportOk++;
    updateAvgLatency(Date.now() - t0);

    return res.json({ ok: true, data: card });
  } catch (err) {
    console.error("[report] FAILED:", err?.message || err);
    METRICS.reportFail++;
    updateAvgLatency(Date.now() - t0);
    return res.status(502).json({
      ok: false,
      error: "report_error",
      message: "ุชุนุฐุฑ ุชุญููู ุงูุชูุฑูุฑ ุงูุขู. ุฌุฑูุจ ุตูุฑุฉ ุฃูุถุญ ุฃู ุงูุตู ุงููุต.",
    });
  }
});

/* =========================
   Start
========================= */
app.listen(PORT, () => {
  console.log(`๐ Dalil Alafiyah API ูุนูู ุนูู http://localhost:${PORT}`);
});
