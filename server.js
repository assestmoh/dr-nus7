// ===============================
// server.js โ Dalil Alafiyah API
// + Institutional Ready Paths (No LLM for key routes)
// ===============================

import "dotenv/config";
import express from "express";
import cors from "cors";
import bodyParser from "body-parser";
import fetch from "node-fetch";
import helmet from "helmet";
import multer from "multer";
import { createRequire } from "module";

const require = createRequire(import.meta.url);
let pdfParse = null;
try { pdfParse = require("pdf-parse"); } catch {}

let createWorker = null;
try { ({ createWorker } = await import("tesseract.js")); } catch {}

const app = express();
const upload = multer({ limits: { fileSize: 10 * 1024 * 1024 } });

// ===============================
// ENV
// ===============================
const GROQ_API_KEY = process.env.GROQ_API_KEY || "";
const MODEL_ID = process.env.GROQ_MODEL || "openai/gpt-oss-120b";
const PORT = process.env.PORT || 3000;

app.use(helmet());
app.use(
  cors({
    origin: true,
    methods: ["GET", "POST", "OPTIONS"],
    allowedHeaders: ["Content-Type","Authorization","x-user-id","X-User-Id","x-api-key","X-Api-Key"],
  })
);
app.use(bodyParser.json({ limit: "2mb" }));

// ===============================
// Card helpers
// ===============================
function card({
  category = "general",
  title = "ุฏููู ุงูุนุงููุฉ",
  verdict = "",
  next_question = "",
  quick_choices = [],
  tips = [],
  when_to_seek_help = "",
}) {
  return {
    category,
    title,
    verdict,
    next_question,
    quick_choices: Array.isArray(quick_choices) ? quick_choices.slice(0, 10) : [],
    tips: Array.isArray(tips) ? tips.slice(0, 10) : [],
    when_to_seek_help,
  };
}

function isCancel(t) {
  return /^(ุฅูุบุงุก|ุงูุบุงุก|cancel|ูุณุญ|ุงุจุฏุฃ ูู ุฌุฏูุฏ|ุงุจุฏุฃ ุฌุฏูุฏ|ุฑุฌูุน|ุนูุฏุฉ|ุงููุงุฆูุฉ)$/i.test(
    String(t || "").trim()
  );
}

function clampNum(n, min, max) {
  if (!Number.isFinite(n)) return null;
  if (n < min || n > max) return null;
  return n;
}

function parseNumber(text) {
  const m = String(text || "").match(/(\d+(\.\d+)?)/);
  return m ? Number(m[1]) : null;
}

function parseBP(text) {
  const m = String(text || "").match(/(\d{2,3})\s*\/\s*(\d{2,3})/);
  if (!m) return null;
  const s = Number(m[1]);
  const d = Number(m[2]);
  if (!clampNum(s, 70, 260) || !clampNum(d, 40, 160)) return null;
  return { s, d };
}

function detectSugarUnit(text) {
  if (/mmol/i.test(String(text || ""))) return "mmol";
  return "mgdl";
}

function sugarToMgdl(value, unit) {
  if (unit === "mmol") return Math.round(value * 18);
  return Math.round(value);
}

// ===============================
// Sessions (in-memory)
// ===============================
const sessions = new Map(); // userId -> { calc:{name,step,data}, ts }

function getUserId(req) {
  return req.header("x-user-id") || "anon";
}

function getSession(userId) {
  if (!sessions.has(userId)) sessions.set(userId, { calc: null, ts: Date.now() });
  const s = sessions.get(userId);
  s.ts = Date.now();
  return s;
}

// ุชูุธูู ุฌูุณุงุช ูุฏููุฉ
setInterval(() => {
  const now = Date.now();
  for (const [k, v] of sessions) {
    if (now - (v.ts || 0) > 24 * 60 * 60 * 1000) sessions.delete(k);
  }
}, 30 * 60 * 1000);

// ===============================
// Report entry card
// ===============================
function reportEntryCard() {
  return card({
    category: "report",
    title: "ุงููู ุชูุฑูุฑู",
    verdict: "ุชูุงู. ุงุฑูุน ุตูุฑุฉ ุฃู PDF ููุชูุฑูุฑ ูู ุฒุฑ ุงููุฑููุ ูุฃูุง ุฃุดุฑุญ ุจุดูู ุนุงู.",
    tips: ["ูุง ุชุฑูุน ุจูุงูุงุช ุดุฎุตูุฉ ุญุณุงุณุฉ ุฅู ุฃููู."],
    when_to_seek_help: "ุฅุฐุง ูุงูุช ุงูุญุงูุฉ ุทุงุฑุฆุฉ ุฃู ุงูุฃุนุฑุงุถ ุดุฏูุฏุฉ: ุฑุงุฌุน ุงูุทูุงุฑุฆ ููุฑูุง.",
    next_question: "ุฌุงูุฒ ุชุฑูุน ุงูุชูุฑูุฑุ",
    quick_choices: ["๐ ุฅุถุงูุฉ ูุฑูู", "ุฅูุบุงุก"],
  });
}

function isReportIntent(text) {
  const t = String(text || "");
  return /(ุงููู\s*ุชูุฑูุฑ|ุชูุฑูุฑ|ุชุญุงููู|ุชุญููู|ูุชูุฌุฉ|lab|report|pdf)/i.test(t);
}

// ===============================
// Institutional Ready Content (No LLM)
// ===============================
const COMMON_TOPICS = [
  "ุงุฑุชูุงุน ุถุบุท ุงูุฏู",
  "ุงูุณูุฑู (ููุน 2)",
  "ุงูุฑุจู",
  "ุงุฑุชุฌุงุน ุงููุฑูุก",
  "ุงูุตุฏุงุน ุงููุตูู/ุงููุชูุฑุฑ",
  "ุขูุงู ุฃุณูู ุงูุธูุฑ",
  "ุงูุญุณุงุณูุฉ ุงูุฃูููุฉ",
  "ุงูุชูุงุจุงุช ุงููุณุงูู ุงูุจูููุฉ",
  "ุงูุณููุฉ ููุชูุงุฒูุฉ ุงูุฃูุถ",
  "ุงูููู ูุงูุงูุชุฆุงุจ",
];

function commonConditionsMenuCard() {
  return card({
    category: "general",
    title: "๐ฉบ ุชุซููู ุนู ุฃูุฑุงุถ ุดุงุฆุนุฉ",
    verdict: "ุงุฎุชุฑ ููุถูุนูุง ููุชุซููู ุงูุนุงู (ุจุฏูู ุชุดุฎูุต ูุจุฏูู ูุตู ุฃุฏููุฉ):",
    next_question: "ุฃู ููุถูุน ุชุฎุชุงุฑุ",
    quick_choices: [...COMMON_TOPICS, "ุฅูุบุงุก"],
    tips: ["ุฅุฐุง ุนูุฏู ุฃุนุฑุงุถ ุดุฏูุฏุฉ ุฃู ููุงุฌุฆุฉ: ูุง ุชูุชุธุฑุ ุฑุงุฌุน ุทุจูุจ/ุทูุงุฑุฆ."],
    when_to_seek_help: "",
  });
}

function topicCard(topic) {
  const t = String(topic || "").trim();

  // 1) HTN
  if (t === "ุงุฑุชูุงุน ุถุบุท ุงูุฏู") {
    return card({
      category: "bp",
      title: "ุงุฑุชูุงุน ุถุบุท ุงูุฏู",
      verdict:
        "ุถุบุท ุงูุฏู ุบุงูุจูุง โุตุงูุชโ. ุงููุทููุจ ูู ููุงุณุงุช ุตุญูุญุฉ ููุชูุฑุฑุฉ + ููุท ุญูุงุฉ + ูุชุงุจุนุฉ ุทุจูุฉ ุฅุฐุง ูุงู ูุฑุชูุนูุง.",
      next_question: "ุชุฑูุฏ ุชุนูููุงุช ููุงุณ ุงูุถุบุท ุจุดูู ุตุญูุญุ",
      quick_choices: ["ูุนู", "ูุง", "๐งฎ ุงูุญุงุณุจุงุช", "ุฅูุบุงุก"],
      tips: [
        "ููุณ ุจุนุฏ ุฑุงุญุฉ 5 ุฏูุงุฆูุ ูุงูุฐุฑุงุน ุจูุณุชูู ุงูููุจ.",
        "ุชุฌูุจ ูููุฉ/ุชุฏุฎูู 30 ุฏูููุฉ ูุจู ุงูููุงุณ.",
        "ูููู ุงูููุญุ ุฒุฏ ุงููุดูุ ููุธูู ุงููุฒู ูุงูููู.",
      ],
      when_to_seek_help:
        "ุฅุฐุง ุงููุฑุงุกุฉ โฅ180/120 ุฃู ูุน ุฃูู ุตุฏุฑ/ุถูู ููุณ/ุตุฏุงุน ุดุฏูุฏ/ุชุดูุด: ุทูุงุฑุฆ ููุฑูุง.",
    });
  }

  // 2) T2DM
  if (t === "ุงูุณูุฑู (ููุน 2)") {
    return card({
      category: "sugar",
      title: "ุงูุณูุฑู (ููุน 2)",
      verdict:
        "ุงูุณูุฑู ูุญุฏุซ ุนูุฏูุง ุชุฑุชูุน ูุณุชููุงุช ุงูุณูุฑ ุจุณุจุจ ููุงููุฉ ุงูุฅูุณูููู. ุงูุชุญูู ูุนุชูุฏ ุนูู ุงูุฃููุ ุงูุญุฑูุฉุ ุงููุฒูุ ูุงููุชุงุจุนุฉ ุงูุฏูุฑูุฉ.",
      next_question: "ุชุฑูุฏ ูุฑู ุงูููุงุณุงุช (ุตุงุฆู/ุจุนุฏ ุงูุฃูู) ููุนูู ุงูุฃุฑูุงูุ",
      quick_choices: ["ูุนู", "ูุง", "๐งฎ ุงูุญุงุณุจุงุช", "ุฅูุบุงุก"],
      tips: [
        "ุงููุดู ุจุนุฏ ุงูุฃูู 10โ20 ุฏูููุฉ ูุณุงุนุฏ ูุซูุฑูุง.",
        "ุฎููุถ ุงููุดุฑูุจุงุช ุงูุณูุฑูุฉ ูุงูุญูููุงุช ูุฏุฑ ุงูุฅููุงู.",
        "ุฑููุฒ ุนูู ุจุฑูุชูู + ุฎุถุงุฑ + ูุฑุจูููุฏุฑุงุช ูุนูููุฉ (ุญุจูุจ ูุงููุฉ).",
      ],
      when_to_seek_help:
        "ุฅุฐุง ุนุทุด ุดุฏูุฏ + ุชุจููู ูุซูุฑ + ุชุนุจ ุดุฏูุฏ/ููุก/ุฏูุฎุฉ ุฃู ูุฑุงุกุฉ ุนุงููุฉ ุฌุฏูุง: ุฑุงุฌุน ุงูุทุจูุจ/ุงูุทูุงุฑุฆ.",
    });
  }

  // 3) Asthma
  if (t === "ุงูุฑุจู") {
    return card({
      category: "general",
      title: "ุงูุฑุจู",
      verdict:
        "ุงูุฑุจู ูู ุงูุชูุงุจ/ุชุถูู ุจุงูุดูุนุจ ุงูููุงุฆูุฉ ูุณุจุจ ุตููุฑุ ูุญุฉุ ูุถูู ููุณ. ุงูุชุญูู ูุนุชูุฏ ุนูู ุชุฌูุจ ุงููุญูุฒุงุช ูุงููุชุงุจุนุฉ.",
      next_question: "ุชุฑูุฏ ูุงุฆูุฉ ูุญูุฒุงุช ุงูุฑุจู ุงูุฃูุซุฑ ุดููุนูุงุ",
      quick_choices: ["ูุนู", "ูุง", "ุฅูุบุงุก"],
      tips: [
        "ูุญูุฒุงุช ุดุงุฆุนุฉ: ุบุจุงุฑุ ุนุทูุฑ ูููุฉุ ุจุฑุฏุ ูุฌููุฏุ ุฏุฎุงู.",
        "ุฑุงูุจ: ูู ุงูุฃุนุฑุงุถ ุชุฒูุฏ ููููุง ุฃู ูุน ุงูุฑูุงุถุฉุ",
        "ุงุณุชุฎุฏู ุฎุทุฉ ุงูุทุจูุจ (ุงูุฏูุงุก ูุญุฏุฏู ุทุจูุจูโุฃูุง ูุง ุฃุตู ุฃุฏููุฉ).",
      ],
      when_to_seek_help:
        "ุฅุฐุง ุถูู ููุณ ุดุฏูุฏุ ุตุนูุจุฉ ููุงูุ ุงุฒุฑูุงูุ ุฃู ูุง ูุชุญุณู: ุทูุงุฑุฆ ููุฑูุง.",
    });
  }

  // 4) GERD
  if (t === "ุงุฑุชุฌุงุน ุงููุฑูุก") {
    return card({
      category: "general",
      title: "ุงุฑุชุฌุงุน ุงููุฑูุก (ุงูุญููุถุฉ)",
      verdict:
        "ุงุฑุชุฌุงุน ุงููุฑูุก ูุณุจุจ ุญุฑูุฉ/ุญููุถุฉุ ุทุนู ูุฑุ ุฃู ุณุนุงู/ุจุญูุฉ. ุบุงูุจูุง ูุชุญุณู ุจุชุนุฏูู ุงูุฃูู ูููุท ุงูุญูุงุฉ.",
      next_question: "ุชุฑูุฏ ุฃูู ุงููุญูุฒุงุช ุงูุบุฐุงุฆูุฉ ููุญููุถุฉุ",
      quick_choices: ["ูุนู", "ูุง", "ุฅูุบุงุก"],
      tips: [
        "ูููู: ุงูููููุงุชุ ุงูุญุงุฑุ ุงููููุฉุ ุงูุดููููุงุ ุงููุนูุงุนุ ุงููุฌุจุงุช ุงููุจูุฑุฉ.",
        "ูุง ุชูู ูุจุงุดุฑุฉ ุจุนุฏ ุงูุฃูู (ุงูุชุธุฑ 2โ3 ุณุงุนุงุช).",
        "ุงุฑูุน ุฑุฃุณ ุงูุณุฑูุฑ ูููููุง ุฅุฐุง ุงูุญููุถุฉ ููููุฉ.",
      ],
      when_to_seek_help:
        "ุฅูุฐุงุฑ: ุฃูู ุตุฏุฑ ุฌุฏูุฏุ ุตุนูุจุฉ ุจูุนุ ูุฒูู ูุฒู ุบูุฑ ูุจุฑุฑุ ููุก ุฏู/ุจุฑุงุฒ ุฃุณูุฏ: ุฑุงุฌุน ุงูุทุจูุจ ููุฑูุง.",
    });
  }

  // 5) Headache / Migraine
  if (t === "ุงูุตุฏุงุน ุงููุตูู/ุงููุชูุฑุฑ") {
    return card({
      category: "general",
      title: "ุงูุตุฏุงุน ุงููุตูู/ุงููุชูุฑุฑ",
      verdict:
        "ุงูุตุฏุงุน ุงููุชูุฑุฑ ูุฏ ูููู ุตุฏุงุน ุชูุชุฑู ุฃู ูุตูู. ุงูุฃูุถู ุชุชุจุน ุงููุญูุฒุงุช ูุชูููุช ุงูุตุฏุงุน ูููุท ุงูููู/ุงููุงูููู.",
      next_question: "ุชุฑูุฏ ุทุฑููุฉ ุจุณูุทุฉ ูุชุณุฌูู ุงูุตุฏุงุน (3 ุฃุณุฆูุฉ)ุ",
      quick_choices: ["ูุนู", "ูุง", "ุฅูุบุงุก"],
      tips: [
        "ูุญูุฒุงุช ุดุงุฆุนุฉ: ููุฉ ุงููููุ ุงูุฌูุงูุ ุชูุชุฑุ ุตูุงู ุทูููุ ูุงูููู ุฒุงุฆุฏ ุฃู ุงููุทุงุนู.",
        "ุงุดุฑุจ ูุงุก ููุงูุฉ ูุญุงูุธ ุนูู ุงูููู.",
        "ุฅุฐุง ุชุณุชุฎุฏู ูุณููุงุช ูุซูุฑูุง ูุฏ ูุฒูุฏ ุงูุตุฏุงุน (ุตุฏุงุน ุงูุฅูุฑุงุท).",
      ],
      when_to_seek_help:
        "ุทุงุฑุฆ ุฅุฐุง: ุตุฏุงุน โุฃุณูุฃ ุตุฏุงุน ุจุญูุงุชูโุ ูุน ุถุนู/ุฎุฏุฑ/ุชุดูุดุ ุจุนุฏ ุถุฑุจุฉ ุฑุฃุณุ ูุน ุญุฑุงุฑุฉ ูุชูุจุณ ุฑูุจุฉ.",
    });
  }

  // 6) Low back pain
  if (t === "ุขูุงู ุฃุณูู ุงูุธูุฑ") {
    return card({
      category: "general",
      title: "ุขูุงู ุฃุณูู ุงูุธูุฑ",
      verdict:
        "ุฃุบูุจ ุขูุงู ุฃุณูู ุงูุธูุฑ ูููุงููููุฉ (ุดุฏ ุนุถูู/ูุถุนูุฉ). ุชุชุญุณู ุจุงูุญุฑูุฉ ุงูุฎูููุฉ ูุชูุงุฑูู ุจุณูุทุฉ ูุชุฌูุจ ุงูุฑุงุญุฉ ุงูุชุงูุฉ ุงูุทูููุฉ.",
      next_question: "ุชุฑูุฏ ุชูุงุฑูู ุฎูููุฉ ุขููุฉ (ุนุงููุฉ)ุ",
      quick_choices: ["ูุนู", "ูุง", "ุฅูุบุงุก"],
      tips: [
        "ุชุฌูุจ ุญูู ุซููู ูุฌุฃุฉุ ูุญุงูุธ ุนูู ูุถุนูุฉ ุฌููุณ ุตุญูุญุฉ.",
        "ุงููุดู ุงูุฎููู ูููููุง ุบุงูุจูุง ุฃูุถู ูู ุงูุฑุงุญุฉ ุงูุชุงูุฉ.",
        "ููุงุฏุงุช ุฏุงูุฆุฉ/ุจุงุฑุฏุฉ ูุฏ ุชุณุงุนุฏ ุญุณุจ ุงูุงุฑุชูุงุญ.",
      ],
      when_to_seek_help:
        "ุฑุงุฌุน ุงูุทุจูุจ ููุฑูุง ุฅุฐุง: ุถุนู ุจุงูุณุงูุ ููุฏุงู ุชุญูู ุจุงูุจูู/ุงูุจุฑุงุฒุ ุฎุฏุฑ ุจููุทูุฉ ุงูุนุฌุงูุ ุฃู ุฃูู ุจุนุฏ ุณููุท ููู.",
    });
  }

  // 7) Allergic rhinitis
  if (t === "ุงูุญุณุงุณูุฉ ุงูุฃูููุฉ") {
    return card({
      category: "general",
      title: "ุงูุญุณุงุณูุฉ ุงูุฃูููุฉ",
      verdict:
        "ุงูุญุณุงุณูุฉ ุงูุฃูููุฉ ุชุณุจุจ ุนุทุงุณ/ุญูุฉ/ุณููุงู ุฃู ุงูุณุฏุงุฏุ ูุชุฒูุฏ ูุน ุงูุบุจุงุฑ ูุงูุนุทูุฑ ูุชุบูุฑ ุงูุฌู. ุงูุชุญูู ูุนุชูุฏ ุนูู ุชูููู ุงูุชุนุฑุถ.",
      next_question: "ุชุฑูุฏ ูุตุงุฆุญ ููุฒููุฉ ูุชูููู ุงูุบุจุงุฑุ",
      quick_choices: ["ูุนู", "ูุง", "ุฅูุบุงุก"],
      tips: [
        "ูุธูู ุงูููุงุชุฑุ ูุงุบุณู ุฃุบุทูุฉ ุงูุณุฑูุฑ ุฃุณุจูุนููุง ุจูุงุก ุฏุงูุฆ.",
        "ูููู ุงูุณุฌุงุฏ ุฅู ุฃูููุ ูุงูุชู ุจุงูุชูููุฉ.",
        "ุชุฌูุจ ุงูุนุทูุฑ ุงููููุฉ ูุงูุจุฎูุฑ ุฅุฐุง ุชุญูุฒ ุงูุฃุนุฑุงุถ.",
      ],
      when_to_seek_help:
        "ุฅุฐุง ุงูุณุฏุงุฏ ุดุฏูุฏ ูุฒููุ ูุฒูู ูุชูุฑุฑุ ุฃู ุฃุนุฑุงุถ ุนูู/ุตุฏุฑ ุดุฏูุฏุฉ: ุฑุงุฌุน ุงูุทุจูุจ.",
    });
  }

  // 8) UTI
  if (t === "ุงูุชูุงุจุงุช ุงููุณุงูู ุงูุจูููุฉ") {
    return card({
      category: "general",
      title: "ุงูุชูุงุจุงุช ุงููุณุงูู ุงูุจูููุฉ",
      verdict:
        "ูุฏ ุชุณุจุจ ุญุฑูุฉ ุจููุ ุชูุฑุงุฑุ ุฃูู ุฃุณูู ุงูุจุทูุ ูุฑุงุฆุญุฉ ูููุฉ. ุชุญุชุงุฌ ุชูููู ุทุจู ุฎุตูุตูุง ูุน ุญุฑุงุฑุฉ/ุฃูู ุจุงูุฎุงุตุฑุฉ.",
      next_question: "ูู ูุฏูู ุญุฑุงุฑุฉ ุฃู ุฃูู ุจุงูุฎุงุตุฑุฉุ",
      quick_choices: ["ูุนู", "ูุง", "ุฅูุบุงุก"],
      tips: [
        "ุงุดุฑุจ ุณูุงุฆู ููุงูุฉ (ุฅู ูู ููุฌุฏ ูุงูุน ุทุจู).",
        "ูุง ุชุญุจุณ ุงูุจูู ููุชุฑุงุช ุทูููุฉ.",
        "ูููุณุงุก: ุชูุธูู ุจุงุชุฌุงู ูุงุญุฏ ูุชุฌูุจ ูููุฌุงุช.",
      ],
      when_to_seek_help:
        "ุทูุงุฑุฆ/ูุฑุงุฌุนุฉ ุนุงุฌูุฉ ุฅุฐุง: ุญุฑุงุฑุฉ ุนุงููุฉุ ุฃูู ุฎุงุตุฑุฉุ ุบุซูุงู/ููุกุ ุญููุ ุฃู ุฏู ูุซูุฑ ุจุงูุจูู.",
    });
  }

  // 9) Obesity / Metabolic syndrome
  if (t === "ุงูุณููุฉ ููุชูุงุฒูุฉ ุงูุฃูุถ") {
    return card({
      category: "general",
      title: "ุงูุณููุฉ ููุชูุงุฒูุฉ ุงูุฃูุถ",
      verdict:
        "ุงูุณููุฉ ุชุฑุชุจุท ุจุงุฑุชูุงุน ุงูุถุบุท ูุงูุณูุฑ ูุงูุฏููู. ุฃูุถู ุงุณุชุฑุงุชูุฌูุฉ: ุชุบููุฑ ุชุฏุฑูุฌู ุซุงุจุช (ุฃูู + ุญุฑูุฉ + ููู) ุจุฏู ุญููู ุณุฑูุนุฉ.",
      next_question: "ุชุฑูุฏ ุฎุทุฉ ุฃุณุจูุน ุจุณูุทุฉ (3 ุฎุทูุงุช)ุ",
      quick_choices: ["ูุนู", "ูุง", "๐งฎ ุงูุญุงุณุจุงุช", "ุฅูุบุงุก"],
      tips: [
        "ุงุจุฏุฃ: ุชูููู ุงููุดุฑูุจุงุช ุงูุณูุฑูุฉ + ุฒูุงุฏุฉ ุจุฑูุชูู/ุฎุถุงุฑ.",
        "ูุดู 20โ30 ุฏูููุฉ 4 ุฃูุงู ุจุงูุฃุณุจูุน ูููุทุฉ ุจุฏุงูุฉ.",
        "ููู 7โ8 ุณุงุนุงุช ูุณุงุนุฏ ุนูู ุงูุดููุฉ ูุงููุฑูููุงุช.",
      ],
      when_to_seek_help:
        "ุฅุฐุง ููุฌุฏ ุดุฎูุฑ ุดุฏูุฏ/ุชููู ุชููุณ ุฃุซูุงุก ุงููููุ ุฃู ุชุนุจ ุดุฏูุฏ ูุฒูู: ุฑุงุฌุน ุงูุทุจูุจ ูุชูููู ุฅุถุงูู.",
    });
  }

  // 10) Anxiety/Depression
  if (t === "ุงูููู ูุงูุงูุชุฆุงุจ") {
    return card({
      category: "mental",
      title: "ุงูููู ูุงูุงูุชุฆุงุจ (ุชุซููู ุนุงู)",
      verdict:
        "ุงูููู ูุงูุงูุชุฆุงุจ ุดุงุฆุนุงูุ ููุฏ ูุธูุฑุงู ูุฃููุงุฑ ุณูุจูุฉ + ุชูุชุฑ + ุงุถุทุฑุงุจ ููู/ุดููุฉ. ุงูุฏุนู ุงููุจูุฑ ููุฑู ูุซูุฑูุง.",
      next_question: "ูู ุชุฑูุฏ ุฎุทูุงุช ููููุฉ ุจุณูุทุฉ ูุชุฎููู ุงูุชูุชุฑุ",
      quick_choices: ["ูุนู", "ูุง", "ุฅูุบุงุก"],
      tips: [
        "ุชููุณ ุจุทูุก 4-4-6 ููุฏุฉ 3 ุฏูุงุฆู.",
        "ุชุนุฑุถ ููุดูุณ 10 ุฏูุงุฆู + ูุดู ุฎููู.",
        "ูููู ุงููุงูููู ุฎุตูุตูุง ุจุนุฏ ุงูุนุตุฑ.",
      ],
      when_to_seek_help:
        "ุฅุฐุง ุฃููุงุฑ ุฅูุฐุงุก ุงูููุณ/ุงูุชุญุงุฑุ ุฃู ุงูููุงุฑ ุดุฏูุฏุ ุฃู ุนุฌุฒ ุนู ุฃุฏุงุก ุงูููุงู: ุงุทูุจ ูุณุงุนุฏุฉ ููุฑูุง (ุทูุงุฑุฆ/ุฎุท ุฏุนู).",
    });
  }

  // default
  return card({
    category: "general",
    title: "ุชุซููู ุนุงู",
    verdict: "ุงุฎุชุฑ ููุถูุนูุง ูู ุงููุงุฆูุฉ.",
    next_question: "",
    quick_choices: [...COMMON_TOPICS, "ุฅูุบุงุก"],
    tips: [],
    when_to_seek_help: "",
  });
}

function lifestyleMenuCard() {
  return card({
    category: "general",
    title: "๐ฟ ููุท ุงูุญูุงุฉ",
    verdict: "ุงุฎุชุฑ ูุญูุฑูุง ููุตุงุฆุญ ููุท ุงูุญูุงุฉ (ุฌุงูุฒ ุจุฏูู LLM):",
    next_question: "ูุจุฏุฃ ุจุฃู ูุญูุฑุ",
    quick_choices: ["๐ฝ๏ธ ุชุบุฐูุฉ", "๐ ูุดุงุท ุจุฏูู", "๐ด ููู", "๐ง ุถุบุท ููุณู", "๐ญ ุฅููุงุน ุนู ุงูุชุฏุฎูู", "ุฅูุบุงุก"],
    tips: ["ูุตุงุฆุญ ุนูููุฉ ูุตูุฑุฉ ูุงุจูุฉ ููุชุทุจูู."],
    when_to_seek_help: "",
  });
}

function lifestyleCard(axis) {
  const a = String(axis || "").trim();

  if (a === "๐ฝ๏ธ ุชุบุฐูุฉ") {
    return card({
      category: "general",
      title: "๐ฝ๏ธ ุชุบุฐูุฉ",
      verdict: "3 ููุงุนุฏ ุณููุฉ: ุจุฑูุชูู ููุงูุฉ + ุฎุถุงุฑ ูููููุง + ุชูููู ุงูุณูุฑ ุงูุณุงุฆู.",
      next_question: "ูุฏูู ุงูุขูุ",
      quick_choices: ["ุชูุญูู", "ุชุซุจูุช", "ุฒูุงุฏุฉ ุตุญูุฉ", "ุฅูุบุงุก"],
      tips: [
        "ุงุจุฏุฃ ุจุตุญู: ูุตูู ุฎุถุงุฑุ ุฑุจุน ุจุฑูุชููุ ุฑุจุน ูุฑุจูููุฏุฑุงุช.",
        "ุงุณุชุจุฏู ุงูุนุตุงุฆุฑ/ุงููุดุฑูุจุงุช ุงูุบุงุฒูุฉ ุจูุงุก ุฃู ุดุงู ุจุฏูู ุณูุฑ.",
      ],
      when_to_seek_help: "ุฅุฐุง ูุฏูู ูุฑุถ ูุฒูู/ุญูู/ุฃุฏููุฉ ูุชุนุฏุฏุฉ: ุงุณุชุดุฑ ูุฎุชุต ุชุบุฐูุฉ.",
    });
  }

  if (a === "๐ ูุดุงุท ุจุฏูู") {
    return card({
      category: "general",
      title: "๐ ูุดุงุท ุจุฏูู",
      verdict: "ุงุจุฏุฃ ุจุฃูู ุดูุก ูุณุชูุฑ: ูุดู 20 ุฏูููุฉ ร 4 ุฃูุงู/ุฃุณุจูุน.",
      next_question: "ูุณุชูุงู ุงูุญุงููุ",
      quick_choices: ["ูุจุชุฏุฆ ุฌุฏูุง", "ูุชูุณุท", "ูุดุท", "ุฅูุบุงุก"],
      tips: ["ุงูุซุจุงุช ุฃูู ูู ุงูุดุฏุฉ.", "ุฒุฏ 10% ุฃุณุจูุนููุง ูุชุฌูุจ ุงูุฅุตุงุจุงุช."],
      when_to_seek_help: "ุฅุฐุง ุฃูู ุตุฏุฑ/ุฏูุฎุฉ ุดุฏูุฏุฉ ูุน ุงูุฌูุฏ: ุฑุงุฌุน ุงูุทุจูุจ.",
    });
  }

  if (a === "๐ด ููู") {
    return card({
      category: "general",
      title: "๐ด ููู",
      verdict: "ุฃูุถู ุชุญุณูู ููููู: ููุช ุซุงุจุช ููููู ูุงูุงุณุชููุงุธ + ุชูููู ุงูุดุงุดุฉ ูุจู ุงูููู ุจุณุงุนุฉ.",
      next_question: "ูุดููุชู ุงูุฃุณุงุณูุฉุ",
      quick_choices: ["ุชุฃุฎุฑ ุงูููู", "ุงุณุชููุงุธ ูุชูุฑุฑ", "ูุนุงุณ ููุงุฑูุง", "ุฅูุบุงุก"],
      tips: [
        "ูููุฉ: ุงุฌุนู ุขุฎุฑ ููุจ ูุจู 6โ8 ุณุงุนุงุช ูู ุงูููู.",
        "ุบุฑูุฉ ูุธููุฉ ูุจุงุฑุฏุฉ ูุณุจููุง ุชุณุงุนุฏ.",
      ],
      when_to_seek_help: "ุดุฎูุฑ ุดุฏูุฏ/ุชููู ุชููุณ/ูุนุงุณ ุฎุทูุฑ: ุฑุงุฌุน ุงูุทุจูุจ ูุงุญุชูุงู ุงููุทุงุน ุงูููุณ.",
    });
  }

  if (a === "๐ง ุถุบุท ููุณู") {
    return card({
      category: "mental",
      title: "๐ง ุถุบุท ููุณู",
      verdict: "ุฌุฑูุจ ุจุฑูุชูููู 5 ุฏูุงุฆู: ุชููุณ + ุญุฑูุฉ ุจุณูุทุฉ + ูุชุงุจุฉ ูู ูุงุญุฏ ูุฎุทูุฉ ูุงุญุฏุฉ.",
      next_question: "ุชุฑูุฏ ุชูุฑูู ุชููุณ ุณุฑูุนุ",
      quick_choices: ["ูุนู", "ูุง", "ุฅูุบุงุก"],
      tips: ["ูุณูู ุงูููุงู ุฅูู ุฎุทูุงุช ุตุบูุฑุฉ (10 ุฏูุงุฆู ููุท)."],
      when_to_seek_help: "ุฅุฐุง ุงูููู ูููุนู ูู ุงูุนูู/ุงูููู ุจุงุณุชูุฑุงุฑ: ุฑุงุฌุน ูุฎุชุต.",
    });
  }

  if (a === "๐ญ ุฅููุงุน ุนู ุงูุชุฏุฎูู") {
    return card({
      category: "general",
      title: "๐ญ ุฅููุงุน ุนู ุงูุชุฏุฎูู",
      verdict: "ุฃูุถู ุฎุทุฉ: ุชุญุฏูุฏ ููู ุฅููุงุน + ุชูููู ุงููุญูุฒุงุช + ุฏุนู ุงุฌุชูุงุนู/ุทุจู ุนูุฏ ุงูุญุงุฌุฉ.",
      next_question: "ูุชู ุชููุฑ ุชุจุฏุฃุ",
      quick_choices: ["ูุฐุง ุงูุฃุณุจูุน", "ูุฐุง ุงูุดูุฑ", "ุบูุฑ ุฌุงูุฒ", "ุฅูุบุงุก"],
      tips: [
        "ุบููุฑ ุงูุฑูุชูู ุงููุฑุชุจุท ุจุงูุชุฏุฎูู (ูููุฉ/ุฌูุณุฉ).",
        "ุฅุฐุง ุงูุชูุณุชุ ูุง ุชุนุชุจุฑูุง ูุดูโุงุฑุฌุน ููุฎุทุฉ ููุฑูุง.",
      ],
      when_to_seek_help: "ุงุทูุจ ุฏุนููุง ุทุจููุง ุฅุฐุง ุงูุฃุนุฑุงุถ ุงูุงูุณุญุงุจูุฉ ูููุฉ ุฃู ูุฏูู ูุฑุถ ูุฒูู.",
    });
  }

  return lifestyleMenuCard();
}

// ===============================
// First Aid (Ready)
// ===============================
function firstAidMenuCard() {
  return card({
    category: "first_aid",
    title: "๐ฉน ุฅุณุนุงูุงุช ุฃูููุฉ",
    verdict: "ุงุฎุชุฑ ุงูุญุงูุฉ ููุญุตูู ุนูู ุฎุทูุงุช ุฅุณุนุงู ุฃููู ุนุงูุฉ:",
    next_question: "ุฃู ุญุงูุฉุ",
    quick_choices: ["๐ฅ ุญุฑูู ุจุณูุทุฉ", "๐ฉธ ูุฒูู/ุฌุฑุญ", "๐ค ุงูุชูุงุก/ูุฏูุฉ", "๐ต ุฅุบูุงุก", "๐ง ุงุฎุชูุงู", "ุฅูุบุงุก"],
    tips: ["ุฅุฐุง ุงูุญุงูุฉ ุฎุทูุฑุฉ ุฃู ุชุชุฏููุฑ: ุงุทูุจ ุทูุงุฑุฆ ููุฑูุง."],
    when_to_seek_help: "ุถูู ููุณ/ุฃูู ุตุฏุฑ/ูุฒูู ุดุฏูุฏ/ููุฏุงู ูุนู ุทููู: ุทูุงุฑุฆ ููุฑูุง.",
  });
}

function firstAidCard(key) {
  if (/^๐ฅ\s*ุญุฑูู ุจุณูุทุฉ$/i.test(key)) {
    return card({
      category: "first_aid",
      title: "๐ฅ ุญุฑูู ุจุณูุทุฉ",
      verdict:
        "1) ุจุฑูุฏ ููุงู ุงูุญุฑู ุจูุงุก ุฌุงุฑู ูุงุชุฑ/ุจุงุฑุฏ 10โ20 ุฏูููุฉ.\n2) ุงูุฒุน ุงูุฅูุณุณูุงุฑุงุช ุงููุฑูุจุฉ ูุจู ุงูุชูุฑูู.\n3) ุบุทูู ุงูุญุฑู ุจุถูุงุฏ/ุดุงุด ูุธูู ุบูุฑ ูุงุตู.\n4) ูุง ุชุถุน ูุนุฌูู/ุฒููุช/ุซูุฌ ูุจุงุดุฑ.\n5) ูุง ุชููุน ุงูููุงุนุงุช.",
      next_question: "ูู ุงูุญุฑู ูุจูุฑ ุฃู ูู ุงููุฌู/ุงููุฏ/ุงูุฃุนุถุงุก ุงูุชูุงุณููุฉุ",
      quick_choices: ["ูุนู", "ูุง", "๐ฉน ุฅุณุนุงูุงุช ุฃูููุฉ", "ุฅูุบุงุก"],
      tips: ["ุฅุฐุง ุงูุฃูู ุดุฏูุฏ ุฃู ูุฒูุฏ: ุงุทูุจ ุชูููู ุทุจู."],
      when_to_seek_help:
        "ุฅุฐุง ุงูุญุฑู ูุจูุฑุ ุฃู ููููุงุฆู/ููุฑุจุงุฆูุ ุฃู ูุน ููุงุนุงุช ูุงุณุนุฉุ ุฃู ุนูู ุงููุฌู/ุงูููุงุตู/ุงููุฏูู: ุทูุงุฑุฆ/ุชูููู ุนุงุฌู.",
    });
  }

  if (/^๐ฉธ\s*ูุฒูู\/ุฌุฑุญ$/i.test(key)) {
    return card({
      category: "first_aid",
      title: "๐ฉธ ูุฒูู/ุฌุฑุญ",
      verdict:
        "1) ุงุถุบุท ุจุดุงุด/ููุงุด ูุธูู ูุจุงุดุฑุฉ 10 ุฏูุงุฆู ุฏูู ุฑูุน.\n2) ุงุฑูุน ุงูุทุฑู ุฅู ุฃููู.\n3) ุฅุฐุง ุชุดุจูุน ุงูุดุงุด: ุฃุถู ุทุจูุฉ ูููู ููุง ุชูุฒุน ุงูุฃููู.\n4) ุจุนุฏ ุชููู ุงููุฒูู: ูุธูู ุญูู ุงูุฌุฑุญ ูุบุทูู.",
      next_question: "ูู ุงููุฒูู ุบุฒูุฑ ุฃู ูุง ูุชููู ุจุนุฏ 10 ุฏูุงุฆู ุถุบุทุ",
      quick_choices: ["ูุนู", "ูุง", "๐ฉน ุฅุณุนุงูุงุช ุฃูููุฉ", "ุฅูุบุงุก"],
      tips: ["ููุฌุฑูุญ ุงูุนูููุฉ/ุงููุชุณุฎุฉ ูุฏ ุชุญุชุงุฌ ุชุทุนูู ูุฒุงุฒ."],
      when_to_seek_help: "ูุฒูู ุบุฒูุฑ/ุฌุฑุญ ุนููู/ุฏูุฎุฉ ุดุฏูุฏุฉ: ุทูุงุฑุฆ ููุฑูุง.",
    });
  }

  if (/^๐ค\s*ุงูุชูุงุก\/ูุฏูุฉ$/i.test(key)) {
    return card({
      category: "first_aid",
      title: "๐ค ุงูุชูุงุก/ูุฏูุฉ",
      verdict:
        "ูุงุนุฏุฉ RICE ุฎูุงู 24โ48 ุณุงุนุฉ:\n- Rest: ุฑุงุญุฉ\n- Ice: ููุงุฏุงุช ุจุงุฑุฏุฉ 15โ20 ุฏูููุฉ\n- Compression: ุฑุจุงุท ุถุงุบุท ุฎููู\n- Elevation: ุฑูุน ุงูุทุฑู\nุชุฌูุจ ุงูุชุฏููู ุงูููู ุฃูู ููู.",
      next_question: "ูู ููุฌุฏ ุชุดููู ุฃู ุนุฏู ูุฏุฑุฉ ุนูู ุงุณุชุฎุฏุงู ุงูุทุฑูุ",
      quick_choices: ["ูุนู", "ูุง", "๐ฉน ุฅุณุนุงูุงุช ุฃูููุฉ", "ุฅูุบุงุก"],
      tips: ["ุงูุฃูู ุงูุฐู ูุฒูุฏ ููููุง ุจุนุฏ ููู ูุญุชุงุฌ ุชูููู."],
      when_to_seek_help: "ุชุดูู/ุฎุฏุฑ/ุฃูู ุดุฏูุฏ ุฌุฏูุง/ุงุดุชุจุงู ูุณุฑ: ุทูุงุฑุฆ ุฃู ุฃุดุนุฉ.",
    });
  }

  if (/^๐ต\s*ุฅุบูุงุก$/i.test(key)) {
    return card({
      category: "first_aid",
      title: "๐ต ุฅุบูุงุก",
      verdict:
        "1) ูุฏุฏ ุงูุดุฎุต ูุงุฑูุน ูุฏููู ูููููุง.\n2) ููู ุงูููุงุจุณ ุงูุถููุฉ ูุชุฃูุฏ ูู ุงูุชูููุฉ.\n3) ุฅุฐุง ุงุณุชุนุงุฏ ูุนูู: ุงุฌุนูู ูุฌูุณ ุชุฏุฑูุฌููุง.\n4) ุฅุฐุง ูุง ูุณุชุฌูุจ ุฃู ูุง ูุชููุณ: ุงุชุตู ุจุงูุทูุงุฑุฆ ูุงุจุฏุฃ ุฅูุนุงุด ุฅู ููุช ูุฏุฑูุจูุง.",
      next_question: "ูู ููุฏ ุงููุนู ุฃูุซุฑ ูู ุฏูููุฉ ุฃู ุญุฏุซ ูุน ุฃูู ุตุฏุฑ/ุถูู ููุณุ",
      quick_choices: ["ูุนู", "ูุง", "๐ฉน ุฅุณุนุงูุงุช ุฃูููุฉ", "ุฅูุบุงุก"],
      tips: ["ูุง ุชุนุทู ุดูุฆูุง ุจุงููู ุฅุฐุง ุบูุฑ ูุงุนู."],
      when_to_seek_help: "ููุฏุงู ูุนู ูุทููู/ุชุดูุฌุงุช/ุฃูู ุตุฏุฑ/ุถูู ููุณ/ุฅุตุงุจุฉ ุฑุฃุณ: ุทูุงุฑุฆ ููุฑูุง.",
    });
  }

  if (/^๐ง\s*ุงุฎุชูุงู$/i.test(key)) {
    return card({
      category: "first_aid",
      title: "๐ง ุงุฎุชูุงู",
      verdict:
        "ุฅุฐุง ูุณุนู ุจููุฉ: ุดุฌูุนู ุนูู ุงูุณุนุงู.\nุฅุฐุง ูุง ูุณุชุทูุน ุงูููุงู/ุงูุชููุณ: ุงุทูุจ ุทูุงุฑุฆ ููุฑูุง ูุงุจุฏุฃ ููุงูุฑุฉ ููุงุณุจุฉ (ูููููู ููุจุงูุบูู/ุถุฑุจุงุช ุธูุฑ ููุฑุถุน ุญุณุจ ุงูุชุฏุฑูุจ).",
      next_question: "ุงูุนูุฑ: ุฑุถูุน ุฃู ุทูู/ุจุงูุบุ",
      quick_choices: ["ุฑุถูุน", "ุทูู/ุจุงูุบ", "๐ฉน ุฅุณุนุงูุงุช ุฃูููุฉ", "ุฅูุบุงุก"],
      tips: ["ุงูุชุฏุฑูุจ ุงูุนููู ุนูู ุงูุฅุณุนุงูุงุช ููู ุฌุฏูุง."],
      when_to_seek_help: "ุงุฎุชูุงู ุดุฏูุฏ ุฏุงุฆููุง ุญุงูุฉ ุทุงุฑุฆุฉ.",
    });
  }

  return firstAidMenuCard();
}

// ===============================
// Calculators Path (No LLM tokens)
// ===============================
function calculatorsMenuCard() {
  return card({
    category: "calculators",
    title: "๐งฎ ุงูุญุงุณุจุงุช",
    verdict: "ุงุฎุชุฑ ุงูุญุงุณุจุฉ ุงูุชู ุชุฑูุฏูุง (ูููุง ุฑุฏูุฏ ุฌุงูุฒุฉ):",
    next_question: "ุฃู ุญุงุณุจุฉ ูุจุฏุฃุ",
    quick_choices: [
      "๐ฅ ุญุงุณุจุฉ ุงูุณุนุฑุงุช",
      "โ๏ธ ุญุงุณุจุฉ ูุชูุฉ ุงูุฌุณู BMI",
      "๐ง ุญุงุณุจุฉ ุงููุงุก",
      "๐ ุญุงุณุจุฉ ุงูุถุบุท",
      "๐ฉธ ุญุงุณุจุฉ ุงูุณูุฑ",
      "๐ง ุญุงุณุจุฉ ุงููุฒุงุฌ",
      "ุฅูุบุงุก",
    ],
    tips: ["ุงููุชุงุฆุฌ ุชูุฏูุฑูุฉ ููุชุซููู ุงูุนุงู ููุท."],
    when_to_seek_help: "",
  });
}

function startCalc(session, name) {
  session.calc = { name, step: 1, data: {} };

  if (name === "bmi") {
    return card({
      category: "calculators",
      title: "โ๏ธ ุญุงุณุจุฉ BMI",
      verdict: "ุฃุนุทูู ูุฒูู ุจุงููููู:",
      next_question: "ูู ูุฒููุ",
      quick_choices: ["ุฅูุบุงุก"],
      tips: ["ูุซุงู: 70"],
      when_to_seek_help: "",
    });
  }

  if (name === "calories") {
    return card({
      category: "calculators",
      title: "๐ฅ ุญุงุณุจุฉ ุงูุณุนุฑุงุช",
      verdict: "ุงุฎุชุฑ ุงูุฌูุณ:",
      next_question: "ุฐูุฑ ุฃู ุฃูุซูุ",
      quick_choices: ["ุฐูุฑ", "ุฃูุซู", "ุฅูุบุงุก"],
      tips: ["ุงูุญุณุงุจ ุชูุฏูุฑู (Mifflin-St Jeor)."],
      when_to_seek_help: "",
    });
  }

  if (name === "water") {
    return card({
      category: "calculators",
      title: "๐ง ุญุงุณุจุฉ ุงููุงุก",
      verdict: "ุงูุชุจ ูุฒูู ุจุงููููู:",
      next_question: "ูู ูุฒููุ",
      quick_choices: ["ุฅูุบุงุก"],
      tips: ["ูุซุงู: 70"],
      when_to_seek_help: "",
    });
  }

  if (name === "bp") {
    return card({
      category: "calculators",
      title: "๐ ุญุงุณุจุฉ ุงูุถุบุท",
      verdict: "ุงูุชุจ ูุฑุงุกุฉ ุงูุถุบุท ุจุงูุดูู 120/80:",
      next_question: "ูุง ูู ุงููุฑุงุกุฉุ",
      quick_choices: ["ุฅูุบุงุก"],
      tips: ["ุฅุฐุง ุนูุฏู ุฏูุฎุฉ ุดุฏูุฏุฉ/ุฃูู ุตุฏุฑ/ุถูู ููุณ: ุทูุงุฑุฆ ููุฑูุง."],
      when_to_seek_help: "",
    });
  }

  if (name === "sugar") {
    return card({
      category: "calculators",
      title: "๐ฉธ ุญุงุณุจุฉ ุงูุณูุฑ",
      verdict: "ุงุฎุชุฑ ููุน ุงูููุงุณ:",
      next_question: "ุงูููุงุณ ูุงู ูุชูุ",
      quick_choices: ["ุตุงุฆู", "ุจุนุฏ ุงูุฃูู ุจุณุงุนุชูู", "ุนุดูุงุฆู", "ุฅูุบุงุก"],
      tips: ["ุงูุชุจ ุงููููุฉ ูุงุญููุง (mg/dL ุฃู mmol/L)."],
      when_to_seek_help: "",
    });
  }

  if (name === "mood") {
    return card({
      category: "calculators",
      title: "๐ง ุญุงุณุจุฉ ุงููุฒุงุฌ",
      verdict: "ูููู ูุฒุงุฌู ุขุฎุฑ 7 ุฃูุงู:",
      next_question: "ุงุฎุชูุงุฑ ูุงุญุฏ:",
      quick_choices: ["ููุชุงุฒ", "ุฌูุฏ", "ูุชูุณุท", "ุณูุฆ", "ุณูุฆ ุฌุฏูุง", "ุฅูุบุงุก"],
      tips: ["ูุฐุง ูุญุต ุฐุงุชู ุจุณูุท ูููุณ ุชุดุฎูุตูุง."],
      when_to_seek_help: "",
    });
  }

  session.calc = null;
  return calculatorsMenuCard();
}

function continueCalc(session, message) {
  const c = session.calc;
  const m = String(message || "").trim();
  if (!c) return null;

  if (isCancel(m)) {
    session.calc = null;
    return calculatorsMenuCard();
  }

  // BMI
  if (c.name === "bmi") {
    if (c.step === 1) {
      const w = clampNum(parseNumber(m), 25, 250);
      if (!w) return card({
        category: "calculators",
        title: "โ๏ธ ุญุงุณุจุฉ BMI",
        verdict: "ูุง ูููุช ุงููุฒู. ุงูุชุจ ุฑูู ุจุงููููู (ูุซุงู 70).",
        next_question: "ูู ูุฒููุ",
        quick_choices: ["ุฅูุบุงุก"],
      });
      c.data.w = w;
      c.step = 2;
      return card({
        category: "calculators",
        title: "โ๏ธ ุญุงุณุจุฉ BMI",
        verdict: "ุงูุขู ุงูุชุจ ุทููู ุจุงูุณูุชููุชุฑ:",
        next_question: "ูู ุทูููุ",
        quick_choices: ["ุฅูุบุงุก"],
        tips: ["ูุซุงู: 170"],
      });
    }
    if (c.step === 2) {
      const h = clampNum(parseNumber(m), 120, 220);
      if (!h) return card({
        category: "calculators",
        title: "โ๏ธ ุญุงุณุจุฉ BMI",
        verdict: "ูุง ูููุช ุงูุทูู. ุงูุชุจ ุฑูู ุจุงูุณูุชููุชุฑ (ูุซุงู 170).",
        next_question: "ูู ุทูููุ",
        quick_choices: ["ุฅูุบุงุก"],
      });

      const bmi = Math.round((c.data.w / Math.pow(h / 100, 2)) * 10) / 10;
      let label = "ุทุจูุนู";
      if (bmi < 18.5) label = "ูุญุงูุฉ";
      else if (bmi < 25) label = "ุทุจูุนู";
      else if (bmi < 30) label = "ุฒูุงุฏุฉ ูุฒู";
      else label = "ุณููุฉ";

      session.calc = null;
      return card({
        category: "calculators",
        title: "โ๏ธ ูุชูุฌุฉ BMI",
        verdict: `BMI = **${bmi}** (${label})`,
        next_question: "ุชุฑูุฏ ูุตุงุฆุญ ูููุท ุงูุญูุงุฉ ุญุณุจ ุงููุชูุฌุฉุ",
        quick_choices: ["ูุนู", "ูุง", "๐งฎ ุงูุญุงุณุจุงุช"],
        tips: [
          "ุงููุชูุฌุฉ ุชูุฏูุฑูุฉ ููุง ุชููู ูุญุฏูุง ูุชูููู ุงูุตุญุฉ.",
          "ุชูุงุฒู ุงูุบุฐุงุก + ูุดุงุท ุจุฏูู ููุชุธู ูุณุงุนุฏ.",
        ],
        when_to_seek_help: "ุฅุฐุง ููุฏุงู ูุฒู ุดุฏูุฏ/ุชุนุจ ูุณุชูุฑ: ุฑุงุฌุน ุงูุทุจูุจ.",
      });
    }
  }

  // Calories
  if (c.name === "calories") {
    if (c.step === 1) {
      if (!/^(ุฐูุฑ|ุฃูุซู)$/i.test(m)) return card({
        category: "calculators",
        title: "๐ฅ ุญุงุณุจุฉ ุงูุณุนุฑุงุช",
        verdict: "ุงุฎุชุฑ (ุฐูุฑ) ุฃู (ุฃูุซู).",
        next_question: "ุงูุฌูุณุ",
        quick_choices: ["ุฐูุฑ", "ุฃูุซู", "ุฅูุบุงุก"],
      });
      c.data.sex = m;
      c.step = 2;
      return card({
        category: "calculators",
        title: "๐ฅ ุญุงุณุจุฉ ุงูุณุนุฑุงุช",
        verdict: "ุงูุชุจ ุนูุฑู ุจุงูุณููุงุช:",
        next_question: "ูู ุนูุฑูุ",
        quick_choices: ["ุฅูุบุงุก"],
        tips: ["ูุซุงู: 28"],
      });
    }
    if (c.step === 2) {
      const age = clampNum(parseNumber(m), 10, 90);
      if (!age) return card({
        category: "calculators",
        title: "๐ฅ ุญุงุณุจุฉ ุงูุณุนุฑุงุช",
        verdict: "ุงูุชุจ ุงูุนูุฑ ุฑูู (ูุซุงู 28).",
        next_question: "ูู ุนูุฑูุ",
        quick_choices: ["ุฅูุบุงุก"],
      });
      c.data.age = age;
      c.step = 3;
      return card({
        category: "calculators",
        title: "๐ฅ ุญุงุณุจุฉ ุงูุณุนุฑุงุช",
        verdict: "ุงูุชุจ ุทููู ุจุงูุณูุชููุชุฑ:",
        next_question: "ูู ุทูููุ",
        quick_choices: ["ุฅูุบุงุก"],
        tips: ["ูุซุงู: 170"],
      });
    }
    if (c.step === 3) {
      const h = clampNum(parseNumber(m), 120, 220);
      if (!h) return card({
        category: "calculators",
        title: "๐ฅ ุญุงุณุจุฉ ุงูุณุนุฑุงุช",
        verdict: "ุงูุชุจ ุงูุทูู ุฑูู (ูุซุงู 170).",
        next_question: "ูู ุทูููุ",
        quick_choices: ["ุฅูุบุงุก"],
      });
      c.data.h = h;
      c.step = 4;
      return card({
        category: "calculators",
        title: "๐ฅ ุญุงุณุจุฉ ุงูุณุนุฑุงุช",
        verdict: "ุงูุชุจ ูุฒูู ุจุงููููู:",
        next_question: "ูู ูุฒููุ",
        quick_choices: ["ุฅูุบุงุก"],
        tips: ["ูุซุงู: 70"],
      });
    }
    if (c.step === 4) {
      const w = clampNum(parseNumber(m), 25, 250);
      if (!w) return card({
        category: "calculators",
        title: "๐ฅ ุญุงุณุจุฉ ุงูุณุนุฑุงุช",
        verdict: "ุงูุชุจ ุงููุฒู ุฑูู (ูุซุงู 70).",
        next_question: "ูู ูุฒููุ",
        quick_choices: ["ุฅูุบุงุก"],
      });
      c.data.w = w;
      c.step = 5;
      return card({
        category: "calculators",
        title: "๐ฅ ุญุงุณุจุฉ ุงูุณุนุฑุงุช",
        verdict: "ุงุฎุชุฑ ูุดุงุทู ุงููููู:",
        next_question: "",
        quick_choices: ["ุฎููู", "ูุชูุณุท", "ุนุงูู", "ุฅูุบุงุก"],
        tips: ["ุฎููู: ุนูู ููุชุจู", "ูุชูุณุท: ูุดู/ุฑูุงุถุฉ 3 ุฃูุงู", "ุนุงูู: ูุดุงุท ูููู ููู"],
      });
    }
    if (c.step === 5) {
      const actMap = { ุฎููู: 1.2, ูุชูุณุท: 1.55, ุนุงูู: 1.725 };
      if (!actMap[m]) return card({
        category: "calculators",
        title: "๐ฅ ุญุงุณุจุฉ ุงูุณุนุฑุงุช",
        verdict: "ุงุฎุชุฑ: ุฎููู / ูุชูุณุท / ุนุงูู",
        next_question: "",
        quick_choices: ["ุฎููู", "ูุชูุณุท", "ุนุงูู", "ุฅูุบุงุก"],
      });
      c.data.act = actMap[m];
      c.step = 6;
      return card({
        category: "calculators",
        title: "๐ฅ ุญุงุณุจุฉ ุงูุณุนุฑุงุช",
        verdict: "ุงุฎุชุฑ ูุฏูู:",
        next_question: "",
        quick_choices: ["ุชุซุจูุช", "ุชูุญูู", "ุฒูุงุฏุฉ", "ุฅูุบุงุก"],
      });
    }
    if (c.step === 6) {
      if (!/^(ุชุซุจูุช|ุชูุญูู|ุฒูุงุฏุฉ)$/i.test(m)) return card({
        category: "calculators",
        title: "๐ฅ ุญุงุณุจุฉ ุงูุณุนุฑุงุช",
        verdict: "ุงุฎุชุฑ: ุชุซุจูุช / ุชูุญูู / ุฒูุงุฏุฉ",
        next_question: "",
        quick_choices: ["ุชุซุจูุช", "ุชูุญูู", "ุฒูุงุฏุฉ", "ุฅูุบุงุก"],
      });

      const sex = c.data.sex;
      const age = c.data.age;
      const h = c.data.h;
      const w = c.data.w;
      const act = c.data.act;

      let bmr = 10 * w + 6.25 * h - 5 * age;
      bmr += /ุฃูุซู/i.test(sex) ? -161 : 5;

      const tdee = Math.round(bmr * act);
      let target = tdee;
      let note = "ุชุซุจูุช ุงููุฒู";
      if (/ุชูุญูู/i.test(m)) { target = tdee - 400; note = "ุชูุญูู (ุชูุฑูุจูุง -400)"; }
      if (/ุฒูุงุฏุฉ/i.test(m)) { target = tdee + 300; note = "ุฒูุงุฏุฉ (ุชูุฑูุจูุง +300)"; }

      session.calc = null;
      return card({
        category: "calculators",
        title: "๐ฅ ูุชูุฌุฉ ุงูุณุนุฑุงุช",
        verdict: `ุงุญุชูุงุฌู ุงููููู ุงูุชูุฑูุจู = **${tdee}** ุณุนุฑุฉ/ููู.\nุงููุฏู (${note}) โ **${target}** ุณุนุฑุฉ/ููู.`,
        next_question: "ุชุฑูุฏ ูุตุงุฆุญ ุณุฑูุนุฉ ููุฃููุ",
        quick_choices: ["ูุนู", "ูุง", "๐งฎ ุงูุญุงุณุจุงุช"],
        tips: ["ุงูุฃุฑูุงู ุชูุฏูุฑูุฉ ููุฏ ุชุฎุชูู ุญุณุจ ุงูุญุงูุฉ ุงูุตุญูุฉ."],
        when_to_seek_help: "ุฅุฐุง ูุฏูู ูุฑุถ ูุฒูู: ุงุณุชุดุฑ ูุฎุชุต ูุจู ุชุบููุฑ ูุจูุฑ.",
      });
    }
  }

  // Water
  if (c.name === "water") {
    if (c.step === 1) {
      const w = clampNum(parseNumber(m), 25, 250);
      if (!w) return card({
        category: "calculators",
        title: "๐ง ุญุงุณุจุฉ ุงููุงุก",
        verdict: "ุงูุชุจ ุงููุฒู ุฑูู ุจุงููููู (ูุซุงู 70).",
        next_question: "ูู ูุฒููุ",
        quick_choices: ["ุฅูุบุงุก"],
      });
      c.data.w = w;
      c.step = 2;
      return card({
        category: "calculators",
        title: "๐ง ุญุงุณุจุฉ ุงููุงุก",
        verdict: "ูุดุงุทู ุงูููููุ",
        next_question: "",
        quick_choices: ["ุฎููู", "ูุชูุณุท", "ุนุงูู", "ุฅูุบุงุก"],
      });
    }
    if (c.step === 2) {
      if (!/^(ุฎููู|ูุชูุณุท|ุนุงูู)$/i.test(m)) return card({
        category: "calculators",
        title: "๐ง ุญุงุณุจุฉ ุงููุงุก",
        verdict: "ุงุฎุชุฑ: ุฎููู / ูุชูุณุท / ุนุงูู",
        next_question: "",
        quick_choices: ["ุฎููู", "ูุชูุณุท", "ุนุงูู", "ุฅูุบุงุก"],
      });
      c.data.act = m;
      c.step = 3;
      return card({
        category: "calculators",
        title: "๐ง ุญุงุณุจุฉ ุงููุงุก",
        verdict: "ููู ุงูุฌู ุบุงูุจูุงุ",
        next_question: "",
        quick_choices: ["ูุนุชุฏู", "ุญุงุฑ", "ูููู ุฃุบูุจ ุงูููุช", "ุฅูุบุงุก"],
      });
    }
    if (c.step === 3) {
      if (!/^(ูุนุชุฏู|ุญุงุฑ|ูููู ุฃุบูุจ ุงูููุช)$/i.test(m)) return card({
        category: "calculators",
        title: "๐ง ุญุงุณุจุฉ ุงููุงุก",
        verdict: "ุงุฎุชุฑ: ูุนุชุฏู / ุญุงุฑ / ูููู ุฃุบูุจ ุงูููุช",
        next_question: "",
        quick_choices: ["ูุนุชุฏู", "ุญุงุฑ", "ูููู ุฃุบูุจ ุงูููุช", "ุฅูุบุงุก"],
      });

      const w = c.data.w;
      let ml = w * 35;
      if (/ูุชูุณุท/i.test(c.data.act)) ml += 300;
      if (/ุนุงูู/i.test(c.data.act)) ml += 600;
      if (/ุญุงุฑ/i.test(m)) ml += 500;
      if (/ูููู/i.test(m)) ml -= 200;

      const liters = Math.max(1.5, Math.round((ml / 1000) * 10) / 10);
      session.calc = null;

      return card({
        category: "calculators",
        title: "๐ง ูุชูุฌุฉ ุงููุงุก",
        verdict: `ุงุญุชูุงุฌู ุงูุชูุฑูุจู ูู ุงููุงุก โ **${liters} ูุชุฑ/ููู**.`,
        next_question: "ุชุฑูุฏ ุทุฑููุฉ ุชูุฒูุนูุง ุฎูุงู ุงููููุ",
        quick_choices: ["ูุนู", "ูุง", "๐งฎ ุงูุญุงุณุจุงุช"],
        tips: ["ููู ุงูุจูู ุงููุงุชุญ ุบุงูุจูุง ุนูุงูุฉ ุชุฑุทูุจ ุฌูุฏ."],
        when_to_seek_help: "ุฅู ูุฏูู ูุดู ูููู/ูุตูุฑ ููุจ: ุงุณุชุดุฑ ุทุจูุจู ูุจู ุฒูุงุฏุฉ ุงูุณูุงุฆู.",
      });
    }
  }

  // BP
  if (c.name === "bp") {
    if (c.step === 1) {
      const bp = parseBP(m);
      if (!bp) return card({
        category: "calculators",
        title: "๐ ุญุงุณุจุฉ ุงูุถุบุท",
        verdict: "ุงูุชุจูุง ูุซู: 120/80",
        next_question: "ูุง ูู ุงููุฑุงุกุฉุ",
        quick_choices: ["ุฅูุบุงุก"],
      });

      const { s, d } = bp;
      let cls = "ุทุจูุนู";
      let seek = "";
      if (s >= 180 || d >= 120) { cls = "ุฃุฒูุฉ ุถุบุท (ุทุงุฑุฆ)"; seek = "ุฅุฐุง ูุน ุฃุนุฑุงุถ: ุทูุงุฑุฆ ููุฑูุง."; }
      else if (s >= 140 || d >= 90) cls = "ูุฑุญูุฉ ุซุงููุฉ";
      else if (s >= 130 || d >= 80) cls = "ูุฑุญูุฉ ุฃููู";
      else if (s >= 120 && d < 80) cls = "ูุฑุชูุน";
      else cls = "ุทุจูุนู";

      session.calc = null;
      return card({
        category: (s >= 180 || d >= 120) ? "emergency" : "calculators",
        title: "๐ ูุชูุฌุฉ ุงูุถุบุท",
        verdict: `ูุฑุงุกุชู **${s}/${d}** ูุชุตููููุง: **${cls}**.`,
        next_question: "ุชุฑูุฏ ูุตุงุฆุญ ููุงุณ ุงูุถุบุทุ",
        quick_choices: ["ูุนู", "ูุง", "๐งฎ ุงูุญุงุณุจุงุช"],
        tips: ["ููุณ ุจุนุฏ ุฑุงุญุฉ 5 ุฏูุงุฆู.", "ุชุฌูุจ ุงููููุฉ/ุงูุชุฏุฎูู ูุจู ุงูููุงุณ."],
        when_to_seek_help: seek || "ุฅุฐุง ุชูุฑุฑ โฅ140/90 ุฃู ูุน ุฃุนุฑุงุถ ูุฒุนุฌุฉ: ุฑุงุฌุน ุงูุทุจูุจ.",
      });
    }
  }

  // Sugar
  if (c.name === "sugar") {
    if (c.step === 1) {
      if (!/^(ุตุงุฆู|ุจุนุฏ ุงูุฃูู ุจุณุงุนุชูู|ุนุดูุงุฆู)$/i.test(m)) {
        return card({
          category: "calculators",
          title: "๐ฉธ ุญุงุณุจุฉ ุงูุณูุฑ",
          verdict: "ุงุฎุชุฑ ููุน ุงูููุงุณ:",
          next_question: "",
          quick_choices: ["ุตุงุฆู", "ุจุนุฏ ุงูุฃูู ุจุณุงุนุชูู", "ุนุดูุงุฆู", "ุฅูุบุงุก"],
        });
      }
      c.data.type = m;
      c.step = 2;
      return card({
        category: "calculators",
        title: "๐ฉธ ุญุงุณุจุฉ ุงูุณูุฑ",
        verdict: "ุงูุชุจ ูููุฉ ุงูุณูุฑ:",
        next_question: "ูุซุงู: 95 ุฃู 7.2 mmol",
        quick_choices: ["ุฅูุบุงุก"],
        tips: ["ุฅุฐุง ุชูุชุจ mmol ุงูุชุจ ูุนูุง mmol ููุชุญูู ุชููุงุฆููุง."],
      });
    }
    if (c.step === 2) {
      const v = parseNumber(m);
      if (!v) return card({
        category: "calculators",
        title: "๐ฉธ ุญุงุณุจุฉ ุงูุณูุฑ",
        verdict: "ุงูุชุจ ุฑูู ูุงุถุญ.",
        next_question: "ูู ุงููุฑุงุกุฉุ",
        quick_choices: ["ุฅูุบุงุก"],
      });

      const unit = detectSugarUnit(m);
      const mg = sugarToMgdl(v, unit);
      const type = c.data.type;

      let cls = "ุถูู ุงูุทุจูุนู";
      let note = "";

      if (/ุตุงุฆู/i.test(type)) {
        if (mg < 70) { cls = "ููุฎูุถ"; note = "ุฅุฐุง ุฃุนุฑุงุถ ูุจูุท: ุงุทูุจ ูุณุงุนุฏุฉ."; }
        else if (mg <= 99) cls = "ุทุจูุนู";
        else if (mg <= 125) cls = "ูุฑุชูุน (ูุง ูุจู ุงูุณูุฑู)";
        else cls = "ูุฑุชูุน ุฌุฏูุง (ูุญุชุงุฌ ุชุฃููุฏ ุทุจู)";
      } else if (/ุจุนุฏ ุงูุฃูู/i.test(type)) {
        if (mg < 70) { cls = "ููุฎูุถ"; note = "ุฅุฐุง ุฃุนุฑุงุถ ูุจูุท: ุงุทูุจ ูุณุงุนุฏุฉ."; }
        else if (mg < 140) cls = "ุทุจูุนู";
        else if (mg <= 199) cls = "ูุฑุชูุน";
        else cls = "ูุฑุชูุน ุฌุฏูุง";
      } else {
        if (mg < 70) { cls = "ููุฎูุถ"; note = "ุฅุฐุง ุฃุนุฑุงุถ ูุจูุท: ุงุทูุจ ูุณุงุนุฏุฉ."; }
        else if (mg < 200) cls = "ูุฏ ูููู ุทุจูุนู/ูุฑุชูุน ุญุณุจ ุงูุฃูู";
        else cls = "ูุฑุชูุน ุฌุฏูุง";
      }

      session.calc = null;
      return card({
        category: "calculators",
        title: "๐ฉธ ูุชูุฌุฉ ุงูุณูุฑ",
        verdict: `ูุฑุงุกุฉ ุงูุณูุฑ โ **${mg} mg/dL** (${cls}).`,
        next_question: "ุชุฑูุฏ ูุตุงุฆุญ ุบุฐุงุฆูุฉ ูุตูุฑุฉุ",
        quick_choices: ["ูุนู", "ูุง", "๐งฎ ุงูุญุงุณุจุงุช"],
        tips: [
          "ุงููุฑุงุกุฉ ุงููุงุญุฏุฉ ูุง ุชููู ููุชุดุฎูุต.",
          note || "ูููู ุงูุณูุฑูุงุช ุงูุณุฑูุนุฉ ูุฒุฏ ุงูุฃููุงู ูุงููุดู.",
        ].filter(Boolean),
        when_to_seek_help:
          "ุฅุฐุง ุงููุฑุงุกุฉ ุนุงููุฉ ุฌุฏูุง ูุน ุนุทุด ุดุฏูุฏ/ุชุจููู ูุซูุฑ/ุชููุค/ุฏูุฎุฉ: ุฑุงุฌุน ุงูุทูุงุฑุฆ.",
      });
    }
  }

  // Mood
  if (c.name === "mood") {
    if (c.step === 1) {
      if (!/^(ููุชุงุฒ|ุฌูุฏ|ูุชูุณุท|ุณูุฆ|ุณูุฆ ุฌุฏูุง)$/i.test(m)) return card({
        category: "calculators",
        title: "๐ง ุญุงุณุจุฉ ุงููุฒุงุฌ",
        verdict: "ุงุฎุชุฑ ุฎูุงุฑ ูุงุญุฏ:",
        next_question: "",
        quick_choices: ["ููุชุงุฒ", "ุฌูุฏ", "ูุชูุณุท", "ุณูุฆ", "ุณูุฆ ุฌุฏูุง", "ุฅูุบุงุก"],
      });
      c.data.mood = m;
      c.step = 2;
      return card({
        category: "calculators",
        title: "๐ง ุญุงุณุจุฉ ุงููุฒุงุฌ",
        verdict: "ูู ุณุงุนุฉ ุชูุงู ุบุงูุจูุงุ",
        next_question: "ุงูุชุจ ุฑูู (ูุซุงู 7)",
        quick_choices: ["ุฅูุบุงุก"],
      });
    }
    if (c.step === 2) {
      const hrs = clampNum(parseNumber(m), 0, 14);
      if (hrs === null) return card({
        category: "calculators",
        title: "๐ง ุญุงุณุจุฉ ุงููุฒุงุฌ",
        verdict: "ุงูุชุจ ุฑูู ููุณุงุนุงุช (ูุซุงู 7).",
        next_question: "",
        quick_choices: ["ุฅูุบุงุก"],
      });

      const mood = c.data.mood;
      session.calc = null;

      const tips = [];
      if (hrs < 6) tips.push("ุญุงูู ุชุซุจูุช ููุนุฏ ุงูููู ูุชูููู ุงูุดุงุดุฉ ูุจู ุงูููู ุจุณุงุนุฉ.");
      if (/ุณูุฆ|ุณูุฆ ุฌุฏูุง/i.test(mood)) tips.push("ุชูุงุตู ูุน ุดุฎุต ุชุซู ุจู + ุงูุดู 10 ุฏูุงุฆู ูููููุง.");
      if (!tips.length) tips.push("ูุงุก/ุฃูู ููุชุธู + ุญุฑูุฉ ุจุณูุทุฉ ูููููุง.");

      return card({
        category: "calculators",
        title: "๐ง ูุชูุฌุฉ ุงููุฒุงุฌ",
        verdict: `ูุฒุงุฌู: **${mood}** โ ูููู: **${hrs} ุณุงุนุฉ**.`,
        next_question: "ุชุฑูุฏ ุฎุทุฉ ุจุณูุทุฉ ูููููุ",
        quick_choices: ["ูุนู", "ูุง", "๐งฎ ุงูุญุงุณุจุงุช"],
        tips,
        when_to_seek_help:
          "ุฅุฐุง ุฃููุงุฑ ุฅูุฐุงุก ุงูููุณ/ุงูุชุญุงุฑ ุฃู ุงูููุงุฑ ุดุฏูุฏ: ุงุทูุจ ูุณุงุนุฏุฉ ููุฑูุง (ุทูุงุฑุฆ/ุฎุท ุฏุนู).",
      });
    }
  }

  session.calc = null;
  return calculatorsMenuCard();
}

function pickCalcFromChoice(text) {
  const t = String(text || "");
  if (/BMI|ูุชูุฉ ุงูุฌุณู|โ๏ธ/i.test(t)) return "bmi";
  if (/ุณุนุฑุงุช|๐ฅ/i.test(t)) return "calories";
  if (/ูุงุก|๐ง/i.test(t)) return "water";
  if (/ุถุบุท|๐/i.test(t)) return "bp";
  if (/ุณูุฑ|๐ฉธ/i.test(t)) return "sugar";
  if (/ูุฒุงุฌ|๐ง/i.test(t)) return "mood";
  return null;
}

function isCalculatorsIntent(text) {
  return /ุญุงุณุจุงุช|ุงูุญุงุณุจุงุช|๐งฎ/i.test(String(text || ""));
}

// ===============================
// LLM (fallback only)
// ===============================
function buildSystemPrompt() {
  return `
ุฃูุช "ุฏููู ุงูุนุงููุฉ" โ ูุฑุงูู ุนุฑุจู ููุชุซููู ุงูุตุญู ููุท.
ุฃุฎุฑุฌ JSON ููุท:
{
 "category":"general|sugar|bp|nutrition|sleep|activity|mental|first_aid|report|emergency",
 "title":"ุนููุงู ูุตูุฑ",
 "verdict":"ุฌููุฉ ูุงุญุฏุฉ",
 "next_question":"ุณุคุงู ูุงุญุฏ ุฃู \"\"",
 "quick_choices":["..."],
 "tips":["..."],
 "when_to_seek_help":"..."
}
ููุงุนุฏ: ูุง ุชุดุฎูุตุ ูุง ุฃุฏููุฉุ ูุง ุฌุฑุนุงุช. ูุบุฉ ุจุณูุทุฉ.
`.trim();
}

async function callGroq(messages) {
  if (!GROQ_API_KEY) throw new Error("Missing GROQ_API_KEY");

  const payload = {
    model: MODEL_ID,
    temperature: 0.35,
    max_tokens: 450,
    messages,
    response_format: { type: "json_object" },
  };

  let res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
    method: "POST",
    headers: { Authorization: `Bearer ${GROQ_API_KEY}`, "Content-Type": "application/json" },
    body: JSON.stringify(payload),
  });

  if (!res.ok) {
    const payload2 = { ...payload };
    delete payload2.response_format;
    res = await fetch("https://api.groq.com/openai/v1/chat/completions", {
      method: "POST",
      headers: { Authorization: `Bearer ${GROQ_API_KEY}`, "Content-Type": "application/json" },
      body: JSON.stringify(payload2),
    });
  }

  const data = await res.json();
  return data?.choices?.[0]?.message?.content || "";
}

function extractJson(text) {
  try { return JSON.parse(text); } catch {}
  const m = String(text || "").match(/\{[\s\S]*\}/);
  if (!m) return null;
  try { return JSON.parse(m[0]); } catch {}
  return null;
}

function normalize(x) {
  const v = x || {};
  return card({
    category: v.category || "general",
    title: v.title || "ุฏููู ุงูุนุงููุฉ",
    verdict: v.verdict || "",
    next_question: v.next_question || "",
    quick_choices: Array.isArray(v.quick_choices) ? v.quick_choices : [],
    tips: Array.isArray(v.tips) ? v.tips : [],
    when_to_seek_help: v.when_to_seek_help || "",
  });
}

function fallbackCard() {
  return card({
    category: "general",
    title: "ุฏููู ุงูุนุงููุฉ",
    verdict: "ุชุนุฐุฑ ุงูุญุตูู ุนูู ุฑุฏ ูุงุถุญ ุงูุขู. ุงูุชุจ ุณุคุงูู ุจุตูุบุฉ ุฃุจุณุท.",
    next_question: "ูุง ูู ุณุคุงููุ",
    quick_choices: ["๐งฎ ุงูุญุงุณุจุงุช", "๐ ุงููู ุชูุฑูุฑู", "๐ฉน ุฅุณุนุงูุงุช ุฃูููุฉ"],
    tips: ["ุงุฐูุฑ ุงูุนูุฑ/ุงูุฃุนุฑุงุถ/ุงููุฏุฉ ุจุฏูู ูุนูููุงุช ุญุณุงุณุฉ."],
    when_to_seek_help: "ุฅุฐุง ูุงูุช ุฃุนุฑุงุถู ุดุฏูุฏุฉ ุฃู ููุงุฌุฆุฉ: ุฑุงุฌุน ุงูุทุจูุจ/ุงูุทูุงุฑุฆ.",
  });
}

// ===============================
// Routes
// ===============================
app.get("/", (_req, res) => res.send("OK"));

app.post("/reset", (req, res) => {
  const userId = getUserId(req);
  sessions.delete(userId);
  return res.json({ ok: true });
});

app.post("/chat", async (req, res) => {
  const userId = getUserId(req);
  const session = getSession(userId);

  const msg = String(req.body?.message || "").trim();
  if (!msg) return res.status(400).json({ ok: false, error: "empty_message" });

  const metaRoute = String(req.body?.meta?.route || "").trim();

  // ========= (A) Institutional routes (no LLM) =========
  if (metaRoute === "medication_general_guidance") {
    session.calc = null;
    return res.json({
      ok: true,
      data: card({
        category: "general",
        title: "๐ ุชุซููู ุฃุฏููุฉ ุนุงู",
        verdict:
          "ูุจู ุงุณุชุฎุฏุงู ุฃู ุฏูุงุก: ุงูุฑุฃ ุงููุดุฑุฉุ ุงูุชุฒู ุจุงูุฌุฑุนุฉ ุงูููุตููุฉุ ููุง ุชุฌูุน ุฃุฏููุฉ ูุชุนุฏุฏุฉ ูููุณ ุงูุนุฑุถ ุจุฏูู ุงุณุชุดุงุฑุฉ ูุฎุชุต.",
        next_question: "ุชุฑูุฏ ุฃู ูุญูุฑุ",
        quick_choices: ["โ ุงุณุชุฎุฏุงู ุขูู", "โ๏ธ ุขุซุงุฑ ุฌุงูุจูุฉ ุดุงุฆุนุฉ", "๐ ุชุฏุงุฎูุงุช ุฏูุงุฆูุฉ", "โ ูุชู ุฃุชุฌูุจ ุงูุฏูุงุกุ", "ุฅูุบุงุก"],
        tips: [
          "ูุง ุฃูุฏูู ุฌุฑุนุงุช ุฃู ูุตูุงุช ุนูุงุฌ.",
          "ููุญุงูู/ุงููุฑุถุน/ุงูุฃุทูุงู/ุงูุฃูุฑุงุถ ุงููุฒููุฉ: ุงุณุฃู ุงูุทุจูุจ/ุงูุตูุฏูู ูุจู ุฃู ุฏูุงุก.",
        ],
        when_to_seek_help: "ุฅุฐุง ุธูุฑุช ุญุณุงุณูุฉ ุดุฏูุฏุฉ (ุชูุฑูู/ุถูู ููุณ/ุทูุญ ููุชุดุฑ): ุทูุงุฑุฆ ููุฑูุง.",
      }),
    });
  }

  if (metaRoute === "common_conditions_education") {
    session.calc = null;
    return res.json({ ok: true, data: commonConditionsMenuCard() });
  }

  if (metaRoute === "prevention_lifestyle") {
    session.calc = null;
    return res.json({ ok: true, data: lifestyleMenuCard() });
  }

  // ========= (B) Topic selection by message (no LLM) =========
  // ุฅุฐุง ุงููุณุชุฎุฏู ุถุบุท ุฃุญุฏ ููุงุถูุน ุงูุฃูุฑุงุถ ุงูุดุงุฆุนุฉ
  if (COMMON_TOPICS.includes(msg)) {
    session.calc = null;
    return res.json({ ok: true, data: topicCard(msg) });
  }

  // ููุท ุงูุญูุงุฉ: ุฅุฐุง ุงููุณุชุฎุฏู ุถุบุท ูุญูุฑ
  if (["๐ฝ๏ธ ุชุบุฐูุฉ","๐ ูุดุงุท ุจุฏูู","๐ด ููู","๐ง ุถุบุท ููุณู","๐ญ ุฅููุงุน ุนู ุงูุชุฏุฎูู"].includes(msg)) {
    session.calc = null;
    return res.json({ ok: true, data: lifestyleCard(msg) });
  }

  // ========= (C) First aid ready path (no LLM) =========
  if (/ุฅุณุนุงูุงุช\s*ุฃูููุฉ|๐ฉน/i.test(msg)) {
    session.calc = null;
    return res.json({ ok: true, data: firstAidMenuCard() });
  }
  if (/^(๐ฅ ุญุฑูู ุจุณูุทุฉ|๐ฉธ ูุฒูู\/ุฌุฑุญ|๐ค ุงูุชูุงุก\/ูุฏูุฉ|๐ต ุฅุบูุงุก|๐ง ุงุฎุชูุงู)$/i.test(msg)) {
    session.calc = null;
    return res.json({ ok: true, data: firstAidCard(msg) });
  }

  // ========= (D) Report entry (no LLM) =========
  if (isReportIntent(msg) && msg.length <= 40) {
    session.calc = null;
    return res.json({ ok: true, data: reportEntryCard() });
  }

  // ========= (E) Calculators (no LLM) =========
  if (session.calc) {
    const out = continueCalc(session, msg);
    return res.json({ ok: true, data: out || calculatorsMenuCard() });
  }

  if (isCalculatorsIntent(msg)) {
    return res.json({ ok: true, data: calculatorsMenuCard() });
  }

  const picked = pickCalcFromChoice(msg);
  if (picked) {
    return res.json({ ok: true, data: startCalc(session, picked) });
  }

  // ========= (F) LLM fallback (only if needed) =========
  try {
    if (!GROQ_API_KEY) {
      // ุฅุฐุง ูุง ุนูุฏู ููุชุงุญุ ุฑุฌุน ุจุทุงูุฉ ูุงุถุญุฉ ุจุฏู โุฎุฑุจุทุฉโ
      return res.json({ ok: true, data: fallbackCard() });
    }

    const raw = await callGroq([
      { role: "system", content: buildSystemPrompt() },
      { role: "user", content: msg },
    ]);
    const parsed = extractJson(raw);
    const data = parsed ? normalize(parsed) : fallbackCard();
    return res.json({ ok: true, data });
  } catch (e) {
    console.error(e);
    return res.status(500).json({ ok: false, error: "server_error", data: fallbackCard() });
  }
});

app.post("/report", upload.single("file"), async (req, res) => {
  try {
    const file = req.file;
    if (!file) return res.status(400).json({ ok: false, error: "no_file" });

    let text = "";

    const isPdf = /pdf/i.test(file.mimetype) || /\.pdf$/i.test(file.originalname);
    if (isPdf && pdfParse) {
      const pdf = await pdfParse(file.buffer);
      text = String(pdf?.text || "").trim();
    }

    if (!text) {
      if (!createWorker) throw new Error("OCR_unavailable");
      const worker = await createWorker("eng");
      const out = await worker.recognize(file.buffer);
      await worker.terminate();
      text = String(out?.data?.text || "").trim();
    }

    if (!text) {
      return res.json({
        ok: true,
        data: card({
          category: "report",
          title: "ุงููู ุชูุฑูุฑู",
          verdict: "ูู ุฃุชููู ูู ูุฑุงุกุฉ ูุญุชูู ูุงุถุญ ูู ุงูููู.",
          next_question: "ุฌุฑูุจ ุตูุฑุฉ ุฃูุถุญ ุฃู PDF ูุตูู ูุงุจู ูููุณุฎ.",
          quick_choices: ["๐ ุฅุถุงูุฉ ูุฑูู", "ุฅูุบุงุก"],
          tips: ["ุชุตููุฑ ูุจุงุดุฑ ุจุฅุถุงุกุฉ ุฌูุฏุฉ ูุณุงุนุฏ ูุซูุฑูุง."],
          when_to_seek_help: "ุฅุฐุง ุฃุนุฑุงุถ ุดุฏูุฏุฉ: ุฑุงุฌุน ุงูุทุจูุจ/ุงูุทูุงุฑุฆ.",
        }),
      });
    }

    return res.json({
      ok: true,
      data: card({
        category: "report",
        title: "ุงููู ุชูุฑูุฑู",
        verdict:
          "ุชู ุงุณุชุฎุฑุงุฌ ูุต ูู ุงูุชูุฑูุฑ. (ุดุฑุญ ุนุงู)\nุงูุชุจ ุงุณู ุงูุชุญููู ุงูุฐู ุชุฑูุฏ ูููู ูุซู: HbA1c ุฃู Cholesterol ุฃู CBC.",
        next_question: "ูุง ุงุณู ุงูุชุญููู ุงูุฐู ุชุฑูุฏ ุดุฑุญูุ",
        quick_choices: ["ุฅูุบุงุก"],
        tips: ["ููุฏูุฉ: ุงุฐูุฑ ุงูููู + ุงููุญุฏุฉ + ุงููุฑุฌุน ุฅู ูุฌุฏ."],
        when_to_seek_help: "ุฅุฐุง ุงูููู ุนุงููุฉ ุฌุฏูุง ูุน ุฃุนุฑุงุถ: ุฑุงุฌุน ุงูุทุจูุจ.",
      }),
    });
  } catch (e) {
    console.error(e);
    return res.status(500).json({
      ok: false,
      error: "report_error",
      data: card({
        category: "report",
        title: "ุงููู ุชูุฑูุฑู",
        verdict: "ุชุนุฐุฑ ุชุญููู ุงูุชูุฑูุฑ ุงูุขู.",
        next_question: "ุฌุฑูุจ ุตูุฑุฉ ุฃูุถุญ ุฃู ุงูุตู ุงููุต.",
        quick_choices: ["๐ ุฅุถุงูุฉ ูุฑูู", "ุฅูุบุงุก"],
        when_to_seek_help: "ุฅุฐุง ุฃุนุฑุงุถ ุดุฏูุฏุฉ: ุฑุงุฌุน ุงูุทุจูุจ/ุงูุทูุงุฑุฆ.",
      }),
    });
  }
});

app.listen(PORT, "0.0.0.0", () => {
  console.log(`๐ Dalil Alafiyah API ูุนูู ุนูู ${PORT}`);
});
