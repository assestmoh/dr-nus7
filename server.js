import "dotenv/config";
import express from "express";
import cors from "cors";
import helmet from "helmet";
import multer from "multer";
import rateLimit from "express-rate-limit";
import { createRequire } from "module";
import { createWorker } from "tesseract.js";

const require = createRequire(import.meta.url);
const pdfParse = require("pdf-parse");

const app = express();
const upload = multer({ limits: { fileSize: 8 * 1024 * 1024 } });

/* =========================
   Config
========================= */
const PORT = process.env.PORT || 8000;
const GROQ_API_KEY = process.env.GROQ_API_KEY || "";
const GROQ_MODEL = process.env.GROQ_MODEL || "openai/gpt-oss-120b";
const INTERNAL_API_KEY = process.env.INTERNAL_API_KEY || "";

/* Official Shifaa links */
const SHIFAA_ANDROID =
  "https://play.google.com/store/apps/details?id=om.gov.moh.phr&pcampaignid=web_share";
const SHIFAA_IOS =
  "https://apps.apple.com/us/app/%D8%B4-%D9%81-%D8%A7%D8%A1/id1455936672?l=ar";

/* =========================
   Middleware
========================= */
app.use(helmet({ crossOriginResourcePolicy: false }));

app.use(
  rateLimit({
    windowMs: 60 * 1000,
    max: 90,
    standardHeaders: true,
    legacyHeaders: false,
  })
);

function requireApiKey(req, res, next) {
  if (!INTERNAL_API_KEY) return next();
  const key = req.header("x-api-key");
  if (key !== INTERNAL_API_KEY)
    return res.status(401).json({ ok: false, error: "unauthorized" });
  next();
}
app.use(requireApiKey);

// Ø¹Ø¯Ù‘Ù„Ù‡Ø§ Ø­Ø³Ø¨ Ù†Ø·Ø§Ù‚Ùƒ
const ALLOWED_ORIGINS = new Set([
  "https://alafya.netlify.app",
  "http://localhost:5173",
  "http://localhost:3000",
  "http://localhost:8000",
]);

function isAllowedOrigin(origin) {
  try {
    const u = new URL(origin);
    if (ALLOWED_ORIGINS.has(origin)) return true;
    if (u.hostname === "localhost") return true;
    if (u.hostname.endsWith(".netlify.app")) return true;
    return false;
  } catch {
    return false;
  }
}

app.use(
  cors({
    origin: (origin, cb) => {
      if (!origin) return cb(null, true);
      if (isAllowedOrigin(origin)) return cb(null, true);
      return cb(new Error("CORS blocked: " + origin));
    },
    methods: ["GET", "POST", "OPTIONS"],
    allowedHeaders: ["Content-Type", "Authorization", "x-user-id", "x-api-key"],
  })
);

app.use(express.json({ limit: "2mb" }));
app.use(express.urlencoded({ extended: true, limit: "2mb" }));

/* =========================
   Metrics
========================= */
const METRICS = {
  startedAt: new Date().toISOString(),
  chatRequests: 0,
  chatOk: 0,
  chatFail: 0,
  reportRequests: 0,
  reportOk: 0,
  reportFail: 0,
  emergencyTriggers: 0,
  avgLatencyMs: 0,
  categoryCount: Object.create(null),
  flows: Object.fromEntries(
    [
      "sugar",
      "bp",
      "bmi",
      "water",
      "calories",
      "mental",
      "first_aid",
      "general",
      // âœ… Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ù„Ù„Ù…Ø¤Ø´Ø±Ø§Øª ÙÙ‚Ø·)
      "med_guide",
      "lab_prep",
      "common_disease",
      "prevention",
      "facility",
      "shifaa",
    ].flatMap((k) => [
      [`${k}Started`, 0],
      [`${k}Completed`, 0],
    ])
  ),
};

function bumpCategory(cat) {
  if (!cat) return;
  METRICS.categoryCount[cat] = (METRICS.categoryCount[cat] || 0) + 1;
}

function updateAvgLatency(ms) {
  const alpha = 0.2;
  METRICS.avgLatencyMs =
    METRICS.avgLatencyMs === 0
      ? ms
      : Math.round(alpha * ms + (1 - alpha) * METRICS.avgLatencyMs);
}

/* =========================
   Sessions (in-memory) + TTL
========================= */
const sessions = new Map(); // userId -> { history, lastCard, flow, step, profile, ts, lastInText, lastInAt }

function getUserId(req) {
  const headerId = req.header("x-user-id");
  if (headerId) return headerId;
  const ua = req.header("user-agent") || "na";
  return `anon:${req.ip}:${ua.slice(0, 60)}`;
}

function getSession(userId) {
  const id = userId || "anon";
  if (!sessions.has(id)) {
    sessions.set(id, {
      history: [],
      lastCard: null,
      flow: null,
      step: 0,
      profile: {},
      ts: Date.now(),
      // âœ… Ù…Ù†Ø¹ Ø§Ù„Ø§Ø²Ø¯ÙˆØ§Ø¬ (double submit)
      lastInText: "",
      lastInAt: 0,
    });
  }
  const s = sessions.get(id);
  s.ts = Date.now();
  return s;
}

setInterval(() => {
  const now = Date.now();
  for (const [k, v] of sessions) {
    if (now - (v.ts || 0) > 24 * 60 * 60 * 1000) sessions.delete(k);
  }
}, 30 * 60 * 1000);

function trimHistory(history, max = 10) {
  if (history.length <= max) return history;
  return history.slice(history.length - max);
}

function resetFlow(session) {
  session.flow = null;
  session.step = 0;
  session.profile = {};
}

/* =========================
   OCR (tesseract.js)
========================= */
let ocrWorkerPromise = null;

async function getOcrWorker() {
  if (!ocrWorkerPromise) {
    ocrWorkerPromise = (async () => {
      const worker = await createWorker("eng+ara");
      return worker;
    })();
  }
  return ocrWorkerPromise;
}

async function ocrImageBuffer(buffer) {
  const worker = await getOcrWorker();
  const { data } = await worker.recognize(buffer);
  return data?.text ? String(data.text) : "";
}

/* =========================
   Helpers
========================= */
function safeJsonParse(s) {
  try {
    return JSON.parse(s);
  } catch {
    return null;
  }
}

function sleep(ms) {
  return new Promise((r) => setTimeout(r, ms));
}

function clampText(s, maxChars) {
  const t = String(s || "").trim();
  if (t.length <= maxChars) return t;
  return t.slice(0, maxChars) + "\n...[ØªÙ… Ù‚Øµ Ø§Ù„Ù†Øµ Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡]";
}

function normalizeArabic(s) {
  return String(s || "")
    .trim()
    .toLowerCase()
    .replace(/[\u064B-\u0652\u0670]/g, "")
    .replace(/[Ø£Ø¥Ø¢]/g, "Ø§")
    .replace(/Ù‰/g, "ÙŠ")
    .replace(/Ø©/g, "Ù‡")
    .replace(/\s+/g, " ");
}

function isGreeting(text) {
  const t = normalizeArabic(text);
  return /^(Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…|Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…|Ø§Ù„Ø³Ù„Ø§Ù…|Ø³Ù„Ø§Ù…|Ù…Ø±Ø­Ø¨Ø§|Ø§Ù‡Ù„Ø§|Ù‡Ù„Ø§|ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±|Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±)([!ØŸ. ]*)$/.test(
    t
  );
}

function isThanks(text) {
  const t = normalizeArabic(text);
  return /^(Ø´ÙƒØ±Ø§|Ø´ÙƒØ±Ù‹Ø§|Ù…Ø´ÙƒÙˆØ±|ÙŠØ¹Ø·ÙŠÙƒ Ø§Ù„Ø¹Ø§ÙÙŠÙ‡|Ø¬Ø²Ø§Ùƒ Ø§Ù„Ù„Ù‡ Ø®ÙŠØ±)([!ØŸ. ]*)$/.test(t);
}

function looksLikeAppointments(text) {
  const t = String(text || "");
  return /Ù…ÙˆØ¹Ø¯|Ù…ÙˆØ§Ø¹ÙŠØ¯|Ø­Ø¬Ø²|Ø§Ø­Ø¬Ø²|Ø­Ø¬ÙˆØ²Ø§Øª|Ø­Ø¬Ø²Øª|Ø­Ø¬Ø²ÙŠ|appointment|booking|Ø´ÙØ§Ø¡/i.test(t);
}

function isEmergencyText(text) {
  return /(Ø£Ù„Ù… ØµØ¯Ø±|Ø§Ù„Ù… ØµØ¯Ø±|Ø¶ÙŠÙ‚ Ù†ÙØ³|ØµØ¹ÙˆØ¨Ø© ØªÙ†ÙØ³|Ø§Ø®ØªÙ†Ø§Ù‚|Ø¥ØºÙ…Ø§Ø¡|Ø§ØºÙ…Ø§Ø¡|Ø´Ù„Ù„|Ø¶Ø¹Ù Ù…ÙØ§Ø¬Ø¦|Ù†Ø²ÙŠÙ Ø´Ø¯ÙŠØ¯|ØªØ´Ù†Ø¬|Ù†ÙˆØ¨Ø©|Ø§ÙÙƒØ§Ø± Ø§Ù†ØªØ­Ø§Ø±ÙŠØ©|Ø£ÙÙƒØ§Ø± Ø§Ù†ØªØ­Ø§Ø±ÙŠØ©|Ø§Ù†ØªØ­Ø§Ø±|Ø§ÙŠØ°Ø§Ø¡ Ø§Ù„Ù†ÙØ³|Ø¥ÙŠØ°Ø§Ø¡ Ø§Ù„Ù†ÙØ³)/i.test(
    String(text || "")
  );
}

function inferCategoryFromMessage(message) {
  const t = String(message || "");

  if (isEmergencyText(t)) return "emergency";
  if (looksLikeAppointments(t)) return "appointments";
  if (/(ØªÙ‚Ø±ÙŠØ±|ØªØ­Ø§Ù„ÙŠÙ„|ØªØ­Ù„ÙŠÙ„|Ù†ØªÙŠØ¬Ø©|cbc|hba1c|cholesterol|vitamin|lab|report|pdf|ØµÙˆØ±Ø©)/i.test(t))
    return "report";
  if (/(Ù‚Ù„Ù‚|ØªÙˆØªØ±|Ø§ÙƒØªØ¦Ø§Ø¨|Ù…Ø²Ø§Ø¬|Ù†ÙˆÙ…|Ø£Ø±Ù‚|panic|anxiety|depress)/i.test(t)) return "mental";
  if (/(bmi|ÙƒØªÙ„Ø© Ø§Ù„Ø¬Ø³Ù…|Ù…Ø¤Ø´Ø± ÙƒØªÙ„Ø©|ÙˆØ²Ù†ÙŠ|Ø·ÙˆÙ„ÙŠ)/i.test(t)) return "bmi";
  if (/(Ø¶ØºØ·|Ø¶ØºØ· Ø§Ù„Ø¯Ù…|systolic|diastolic|mmhg|Ù…Ù„Ù… Ø²Ø¦Ø¨Ù‚ÙŠ)/i.test(t)) return "bp";
  if (/(Ø³ÙƒØ±|Ø³ÙƒØ±ÙŠ|glucose|mg\/dl|ØµØ§Ø¦Ù…|Ø¨Ø¹Ø¯ Ø§Ù„Ø£ÙƒÙ„|Ø¨Ø¹Ø¯ Ø§Ù„Ø§ÙƒÙ„|hba1c)/i.test(t)) return "sugar";
  if (/(Ù…Ø§Ø¡|Ø³ÙˆØ§Ø¦Ù„|Ø´Ø±Ø¨|ØªØ±Ø·ÙŠØ¨|hydration)/i.test(t)) return "water";
  if (/(Ø³Ø¹Ø±Ø§Øª|calories|Ø¯Ø§ÙŠØª|Ø±Ø¬ÙŠÙ…|ØªØ®Ø³ÙŠØ³|ØªÙ†Ø­ÙŠÙ|Ø²ÙŠØ§Ø¯Ø© ÙˆØ²Ù†|Ù†Ø¸Ø§Ù… ØºØ°Ø§Ø¦ÙŠ)/i.test(t)) return "calories";
  if (/(Ø§Ø³Ø¹Ø§ÙØ§Øª|Ø¥Ø³Ø¹Ø§ÙØ§Øª|Ø­Ø±ÙˆÙ‚|Ø¬Ø±Ø­|Ø§Ø®ØªÙ†Ø§Ù‚|Ø¥ØºÙ…Ø§Ø¡|Ù†Ø²ÙŠÙ|ÙƒØ³Ø±|first aid)/i.test(t))
    return "first_aid";
  return "general";
}

/** âœ… Ù…Ù‡Ù…: Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ù…Ù† "ØºØ§Ù…Ø¶" */
function isTooVague(text, session) {
  const t = String(text || "").trim();

  // âœ… Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¥Ø¬Ø§Ø¨Ø© Ù†Ø¹Ù…/Ù„Ø§ Ø¹Ù„Ù‰ Ø³Ø¤Ø§Ù„ Ø³Ø§Ø¨Ù‚ (next_question)ØŒ Ù„Ø§ ØªØ¹ØªØ¨Ø±Ù‡Ø§ ØºØ§Ù…Ø¶Ø©
  const hasPendingQ = !!session?.lastCard?.next_question;
  if (hasPendingQ && /^(Ù†Ø¹Ù…|Ù„Ø§)$/i.test(t)) return false;

  // Ø±Ù…ÙˆØ² Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
  if (/(ğŸ©¸|ğŸ«€|âš–ï¸|ğŸ’§|ğŸ”¥|ğŸ§ |ğŸ©¹|ğŸ“„|ğŸ“…|ğŸ’Š|ğŸ§ª|ğŸ©º|ğŸŒ¿|ğŸ¥)/.test(t)) return false;

  // ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© + Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  if (
    /^(Ø§Ù„Ø³ÙƒØ±|Ø³ÙƒØ±|ğŸ©¸ Ø§Ù„Ø³ÙƒØ±|ğŸ©¸|Ø§Ù„Ø¶ØºØ·|Ø¶ØºØ·|ğŸ«€ Ø§Ù„Ø¶ØºØ·|ğŸ«€|bmi|BMI|âš–ï¸ BMI|âš–ï¸|Ù…Ø§Ø¡|Ø´Ø±Ø¨ Ø§Ù„Ù…Ø§Ø¡|ğŸ’§ Ø´Ø±Ø¨ Ø§Ù„Ù…Ø§Ø¡|ğŸ’§|Ø³Ø¹Ø±Ø§Øª|calories|ğŸ”¥ Ø§Ù„Ø³Ø¹Ø±Ø§Øª|ğŸ”¥|Ù…Ø²Ø§Ø¬|ğŸ§  Ø·Ù…Ù‘Ù†Ø§ Ø¹Ù„Ù‰ Ù…Ø²Ø§Ø¬Ùƒ|ğŸ§ |Ø§Ø³Ø¹Ø§ÙØ§Øª|Ø¥Ø³Ø¹Ø§ÙØ§Øª|ğŸ©¹ Ø¥Ø³Ø¹Ø§ÙØ§Øª Ø£ÙˆÙ„ÙŠØ©|ğŸ©¹|Ø§ÙÙ‡Ù… ØªÙ‚Ø±ÙŠØ±Ùƒ|ğŸ“„ Ø§ÙÙ‡Ù… ØªÙ‚Ø±ÙŠØ±Ùƒ|ğŸ“„|Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø´ÙØ§Ø¡|ğŸ“… Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø´ÙØ§Ø¡|ğŸ“…|Ø¥Ø±Ø´Ø§Ø¯ Ø¯ÙˆØ§Ø¦ÙŠ Ø¹Ø§Ù…|ğŸ’Š Ø¥Ø±Ø´Ø§Ø¯ Ø¯ÙˆØ§Ø¦ÙŠ Ø¹Ø§Ù…|ğŸ’Š|Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù„Ù…Ø®ØªØ¨Ø± ÙˆØ§Ù„ØªØ­Ø§Ù„ÙŠÙ„|ğŸ§ª Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù„Ù…Ø®ØªØ¨Ø± ÙˆØ§Ù„ØªØ­Ø§Ù„ÙŠÙ„|ğŸ§ª|ØªØ«Ù‚ÙŠÙ Ø¹Ù† Ù…Ø±Ø¶ Ø´Ø§Ø¦Ø¹|ğŸ©º ØªØ«Ù‚ÙŠÙ Ø¹Ù† Ù…Ø±Ø¶ Ø´Ø§Ø¦Ø¹|ğŸ©º|Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© ÙˆÙ†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø©|ğŸŒ¿ Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© ÙˆÙ†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø©|ğŸŒ¿|Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù†Ø´Ø£Ø©|ğŸ¥ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù†Ø´Ø£Ø©|ğŸ¥)$/i.test(
      t
    )
  )
    return false;

  // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  if (/^(Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©|Ø§Ù„Ù‚Ø§Ø¦Ù…Ù‡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠÙ‡|Ù…Ù†ÙŠÙˆ|Ù‚Ø§Ø¦Ù…Ø©|Ø§Ø¨Ø¯Ø£|Ø§Ø¨Ø¯Ø¡)$/i.test(t)) return false;

  // Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØºÙ…ÙˆØ¶
  if (t.length < 6) return true;
  if (t.length < 12 && !/[ØŸ?]/.test(t)) return true;
  return false;
}

function isBareYesNo(text) {
  return /^(Ù†Ø¹Ù…|Ù„Ø§|ok|okay)$/i.test(String(text || "").trim());
}

/* =========================
   Card builder
========================= */
function makeCard({
  title,
  category,
  verdict,
  tips,
  when_to_seek_help,
  next_question,
  quick_choices,
}) {
  return {
    title: title || "Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø§ÙÙŠØ©",
    category: category || "general",
    verdict: verdict || "",
    tips: Array.isArray(tips) ? tips : [],
    when_to_seek_help: when_to_seek_help || "",
    next_question: next_question || "",
    quick_choices: Array.isArray(quick_choices) ? quick_choices : [],
  };
}

/* =========================
   Main Menu (Ø®ÙÙŠÙ)
   âœ… Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ: Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„ØµØ­ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ØªØ¸Ù‡Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© ÙˆÙ†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© (Ø¨Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª)
========================= */
function menuCard() {
  return makeCard({
    title: "Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø§ÙÙŠØ©",
    category: "general",
    verdict: "Ø§Ø®ØªØ± Ù…Ø³Ø§Ø±Ù‹Ø§ ğŸ‘‡",
    tips: [],
    when_to_seek_help: "Ø¥Ø°Ø§ Ø£Ø¹Ø±Ø§Ø¶ Ø®Ø·ÙŠØ±Ø© (Ø£Ù„Ù… ØµØ¯Ø±/Ø¶ÙŠÙ‚ Ù†ÙØ³/Ø¥ØºÙ…Ø§Ø¡/Ù†Ø²ÙŠÙ Ø´Ø¯ÙŠØ¯): Ø·ÙˆØ§Ø±Ø¦ ÙÙˆØ±Ù‹Ø§.",
    next_question: "ÙˆØ´ ØªØ­Ø¨ ØªØ¨Ø¯Ø£ØŸ",
    quick_choices: [
      "ğŸ’Š Ø¥Ø±Ø´Ø§Ø¯ Ø¯ÙˆØ§Ø¦ÙŠ Ø¹Ø§Ù…",
      "ğŸ§ª Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù„Ù…Ø®ØªØ¨Ø± ÙˆØ§Ù„ØªØ­Ø§Ù„ÙŠÙ„",
      "ğŸ©º ØªØ«Ù‚ÙŠÙ Ø¹Ù† Ù…Ø±Ø¶ Ø´Ø§Ø¦Ø¹",
      "ğŸŒ¿ Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© ÙˆÙ†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø©",
      "ğŸ¥ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù†Ø´Ø£Ø©",
      "ğŸ“… Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø´ÙØ§Ø¡",
      "ğŸ“„ Ø§ÙÙ‡Ù… ØªÙ‚Ø±ÙŠØ±Ùƒ",
      "ğŸ©¹ Ø¥Ø³Ø¹Ø§ÙØ§Øª Ø£ÙˆÙ„ÙŠØ© (Ù…Ø­ÙƒÙˆÙ…Ø©)",
    ],
  });
}

function greetingCard() {
  return makeCard({
    title: "Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø§ÙÙŠØ©",
    category: "general",
    verdict: "ÙˆØ¹Ù„ÙŠÙƒÙ… Ø§Ù„Ø³Ù„Ø§Ù… ÙˆØ±Ø­Ù…Ø© Ø§Ù„Ù„Ù‡ ÙˆØ¨Ø±ÙƒØ§ØªÙ‡ ğŸŒ¿\nØ£Ù†Ø§ Ù‡Ù†Ø§ Ù„Ù„ØªØ«Ù‚ÙŠÙ Ø§Ù„ØµØ­ÙŠ ÙˆØ§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù†Ø´Ø£Ø©.",
    tips: ["Ø§Ø®ØªØ± Ù…Ø³Ø§Ø±Ù‹Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø£Ùˆ Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©."],
    when_to_seek_help: "Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ Ø£Ù„Ù… ØµØ¯Ø±/Ø¶ÙŠÙ‚ Ù†ÙØ³/Ø¥ØºÙ…Ø§Ø¡/Ù†Ø²ÙŠÙ Ø´Ø¯ÙŠØ¯: Ø·ÙˆØ§Ø±Ø¦ ÙÙˆØ±Ù‹Ø§.",
    next_question: "ÙˆØ´ ØªØ¨ØºÙ‰ ØªØ¨Ø¯Ø£ ÙÙŠÙ‡ØŸ",
    quick_choices: menuCard().quick_choices,
  });
}

function thanksCard() {
  return makeCard({
    title: "Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø§ÙÙŠØ©",
    category: "general",
    verdict: "Ø§Ù„Ø¹ÙÙˆ ğŸŒ¿",
    tips: [],
    when_to_seek_help: "Ø¥Ø°Ø§ Ø£Ø¹Ø±Ø§Ø¶ Ø·Ø§Ø±Ø¦Ø©: Ø·ÙˆØ§Ø±Ø¦ ÙÙˆØ±Ù‹Ø§.",
    next_question: "ÙˆØ´ ØªØ­Ø¨ ØªØ³Ø£Ù„ØŸ",
    quick_choices: menuCard().quick_choices,
  });
}

/* =========================
   âœ… Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¤Ø³Ø³Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Hardcoded) â€” Ø¨Ø¯ÙˆÙ† LLM
   Ø§Ù„Ù‡Ø¯Ù: Ù…Ø§ ÙŠØ·Ù„Ø¹ ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø²Ø¹Ø¬ + Ù…Ø§ ÙŠØµÙŠØ± Ø±Ø¯ÙˆØ¯ ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨Ø©
========================= */

/** 1) ğŸ’Š Ø¥Ø±Ø´Ø§Ø¯ Ø¯ÙˆØ§Ø¦ÙŠ Ø¹Ø§Ù… */
function medGuideMenuCard() {
  METRICS.flows.med_guideStarted++;
  return makeCard({
    title: "ğŸ’Š Ø¥Ø±Ø´Ø§Ø¯ Ø¯ÙˆØ§Ø¦ÙŠ Ø¹Ø§Ù…",
    category: "general",
    verdict:
      "Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… **ØªØ«Ù‚ÙŠÙ Ø¹Ø§Ù…** Ø¹Ù† ÙØ¦Ø§Øª Ø£Ø¯ÙˆÙŠØ© Ø´Ø§Ø¦Ø¹Ø© (Ø¨Ø¯ÙˆÙ† ÙˆØµÙ Ø¹Ù„Ø§Ø¬/Ø¬Ø±Ø¹Ø§Øª).\nØ§Ø®ØªØ± Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù„ÙŠ ØªØ¨ÙŠ ØªÙ‚Ø±Ø£ Ø¹Ù†Ù‡Ø§:",
    tips: ["Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ Ø­Ø§Ù„Ø© Ø®Ø§ØµØ©/Ø­Ù…Ù„/Ø£Ù…Ø±Ø§Ø¶ Ù…Ø²Ù…Ù†Ø©: Ø§Ø³Ø£Ù„ Ø·Ø¨ÙŠØ¨/ØµÙŠØ¯Ù„ÙŠ."],
    when_to_seek_help: "ØªØ­Ø³Ø³ Ø´Ø¯ÙŠØ¯/Ø¶ÙŠÙ‚ Ù†ÙØ³/ØªÙˆØ±Ù… Ø¨Ø§Ù„ÙˆØ¬Ù‡ Ø£Ùˆ Ø¥ØºÙ…Ø§Ø¡: Ø·ÙˆØ§Ø±Ø¦ ÙÙˆØ±Ù‹Ø§.",
    next_question: "Ø£ÙŠ ÙØ¦Ø© ØªØ®ØªØ§Ø±ØŸ",
    quick_choices: ["Ù…Ø¶Ø§Ø¯ Ø­ÙŠÙˆÙŠ", "Ù…Ø³ÙƒÙ†Ø§Øª", "Ø£Ø¯ÙˆÙŠØ© Ø­Ø³Ø§Ø³ÙŠØ©", "Ø£Ø¯ÙˆÙŠØ© Ø³Ø¹Ø§Ù„/Ø²ÙƒØ§Ù…", "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"],
  });
}

function medGuideDetailsCard(kind) {
  const base = {
    title: "ğŸ’Š Ø¥Ø±Ø´Ø§Ø¯ Ø¯ÙˆØ§Ø¦ÙŠ Ø¹Ø§Ù…",
    category: "general",
    when_to_seek_help: "ØªØ­Ø³Ø³ Ø´Ø¯ÙŠØ¯/Ø¶ÙŠÙ‚ Ù†ÙØ³/ØªÙˆØ±Ù…/Ø¯ÙˆØ®Ø© Ø´Ø¯ÙŠØ¯Ø©: Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦.",
    next_question: "ØªØ­Ø¨ ØªØ®ØªØ§Ø± ÙØ¦Ø© Ø«Ø§Ù†ÙŠØ©ØŸ",
    quick_choices: ["Ù…Ø¶Ø§Ø¯ Ø­ÙŠÙˆÙŠ", "Ù…Ø³ÙƒÙ†Ø§Øª", "Ø£Ø¯ÙˆÙŠØ© Ø­Ø³Ø§Ø³ÙŠØ©", "Ø£Ø¯ÙˆÙŠØ© Ø³Ø¹Ø§Ù„/Ø²ÙƒØ§Ù…", "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"],
  };

  if (kind === "Ù…Ø¶Ø§Ø¯ Ø­ÙŠÙˆÙŠ") {
    return makeCard({
      ...base,
      verdict:
        "**Ø§Ù„Ù…Ø¶Ø§Ø¯Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©** ØªØ¹Ø§Ù„Ø¬ **Ø§Ù„Ø§Ù„ØªÙ‡Ø§Ø¨Ø§Øª Ø§Ù„Ø¨ÙƒØªÙŠØ±ÙŠØ©** (Ù…Ùˆ Ø§Ù„ÙÙŠØ±ÙˆØ³ÙŠØ© Ù…Ø«Ù„ Ø£ØºÙ„Ø¨ Ù†Ø²Ù„Ø§Øª Ø§Ù„Ø¨Ø±Ø¯).\n" +
        "Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¹ÙŠ ÙŠØ³Ø¨Ø¨ **Ù…Ù‚Ø§ÙˆÙ…Ø© Ø¨ÙƒØªÙŠØ±ÙŠØ©** ÙˆÙ…Ø´Ø§ÙƒÙ„ Ù…Ø³ØªÙ‚Ø¨Ù„Ù‹Ø§.",
      tips: [
        "Ø£Ø­ÙŠØ§Ù†Ù‹Ø§ ØªØ³Ø¨Ø¨ Ø§Ø¶Ø·Ø±Ø§Ø¨ Ù…Ø¹Ø¯Ø©/Ø¥Ø³Ù‡Ø§Ù„ Ø£Ùˆ Ø·ÙØ­ Ø¬Ù„Ø¯ÙŠ.",
        "Ø£Ø®Ø¨Ø± Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø¹Ù† Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ø¦ÙŠØ© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©.",
        "Ù„Ø§ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¶Ø§Ø¯ Ù„Ù†Ø²Ù„Ø© Ø¨Ø±Ø¯ Ø¹Ø§Ø¯ÙŠØ© Ø¥Ù„Ø§ Ø¨ØªÙ‚ÙŠÙŠÙ… Ø·Ø¨ÙŠ.",
      ],
    });
  }

  if (kind === "Ù…Ø³ÙƒÙ†Ø§Øª") {
    return makeCard({
      ...base,
      verdict:
        "**Ø§Ù„Ù…Ø³ÙƒÙ†Ø§Øª** ØªÙØ³ØªØ®Ø¯Ù… Ù„ØªØ®ÙÙŠÙ Ø§Ù„Ø£Ù„Ù…/Ø§Ù„Ø­Ø±Ø§Ø±Ø©.\n" +
        "ÙÙŠÙ‡ Ø£Ù†ÙˆØ§Ø¹ ØªØ®ØªÙ„Ù Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© (Ø£Ù„Ù… Ø¹Ø¶Ù„Ø§ØªØŒ ØµØ¯Ø§Ø¹ØŒ Ø£Ù„Ù… Ø§Ù„ØªÙ‡Ø§Ø¨ÙŠ...).",
      tips: [
        "Ø§Ù†ØªØ¨Ù‡ Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ù‚Ø±Ø­Ø©/Ù…Ø´Ø§ÙƒÙ„ ÙƒÙ„Ù‰/Ø³ÙŠÙˆÙ„Ø© â€” Ø§Ø³Ø£Ù„ Ø·Ø¨ÙŠØ¨/ØµÙŠØ¯Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….",
        "ØªØ¬Ù†Ø¨ ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„Ù…Ø§Ø¯Ø© Ù…Ù† Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ù†ØªØ¬ (Ø®ØµÙˆØµÙ‹Ø§ Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø¨Ø±Ø¯ Ø§Ù„Ù…Ø±ÙƒØ¨Ø©).",
        "Ø¥Ø°Ø§ Ø§Ù„Ø£Ù„Ù… Ø´Ø¯ÙŠØ¯ Ø£Ùˆ Ù…Ø³ØªÙ…Ø± Ø£Ùˆ Ù…Ø¹Ù‡ Ø£Ø¹Ø±Ø§Ø¶ ØºÙŠØ± Ø·Ø¨ÙŠØ¹ÙŠØ©: Ø±Ø§Ø¬Ø¹ Ø·Ø¨ÙŠØ¨.",
      ],
    });
  }

  if (kind === "Ø£Ø¯ÙˆÙŠØ© Ø­Ø³Ø§Ø³ÙŠØ©") {
    return makeCard({
      ...base,
      verdict:
        "**Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©** ØªØ³Ø§Ø¹Ø¯ ÙÙŠ Ø§Ù„Ø¹Ø·Ø§Ø³/Ø§Ù„Ø­ÙƒØ©/Ø³ÙŠÙ„Ø§Ù† Ø§Ù„Ø£Ù†Ù/Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø¬Ù„Ø¯.\n" +
        "Ø¨Ø¹Ø¶Ù‡Ø§ Ù‚Ø¯ ÙŠØ³Ø¨Ø¨ **Ù†Ø¹Ø§Ø³** Ø¹Ù†Ø¯ Ø¨Ø¹Ø¶ Ø§Ù„Ù†Ø§Ø³.",
      tips: [
        "Ù„Ùˆ ØªØ³ÙˆÙ‚/ØªØ´ØªØºÙ„ Ø¹Ù„Ù‰ Ø¢Ù„Ø§Øª: Ø§Ù†ØªØ¨Ù‡ Ù„Ù„Ù†Ø¹Ø§Ø³.",
        "Ø­Ø³Ø§Ø³ÙŠØ© Ø´Ø¯ÙŠØ¯Ø© Ù…Ø¹ ØªÙˆØ±Ù… Ø£Ùˆ ØµØ¹ÙˆØ¨Ø© ØªÙ†ÙØ³ = Ø­Ø§Ù„Ø© Ø·Ø§Ø±Ø¦Ø©.",
        "ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¨Ø¨ (ØºØ¨Ø§Ø±/Ø±ÙˆØ§Ø¦Ø­/Ø·Ø¹Ø§Ù…) ÙŠØ³Ø§Ø¹Ø¯ ÙƒØ«ÙŠØ±Ù‹Ø§ ÙÙŠ Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©.",
      ],
    });
  }

  // Ø³Ø¹Ø§Ù„/Ø²ÙƒØ§Ù…
  return makeCard({
    ...base,
    verdict:
      "**Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø³Ø¹Ø§Ù„/Ø§Ù„Ø²ÙƒØ§Ù…** ØºØ§Ù„Ø¨Ù‹Ø§ ØªØ®ÙÙ Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ ÙÙ‚Ø· (Ø§Ø­ØªÙ‚Ø§Ù†/Ø³Ø¹Ø§Ù„/Ø±Ø´Ø­).\n" +
      "Ù†Ø²Ù„Ø§Øª Ø§Ù„Ø¨Ø±Ø¯ Ø¹Ø§Ø¯Ø© ÙÙŠØ±ÙˆØ³ÙŠØ© ÙˆØªØªØ­Ø³Ù† ØªØ¯Ø±ÙŠØ¬ÙŠÙ‹Ø§ Ù…Ø¹ Ø§Ù„Ø±Ø§Ø­Ø©.",
    tips: [
      "Ø§Ù‚Ø±Ø£ Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ù„ØªØ¬Ù†Ø¨ ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„Ù…Ø§Ø¯Ø© Ù…Ø¹ Ø£Ø¯ÙˆÙŠØ© Ø£Ø®Ø±Ù‰.",
      "Ø§Ù„Ø³ÙˆØ§Ø¦Ù„ Ø§Ù„Ø¯Ø§ÙØ¦Ø©ØŒ Ø§Ù„Ø±Ø§Ø­Ø©ØŒ ÙˆØªØ±Ø·ÙŠØ¨ Ø§Ù„Ø£Ù†Ù Ø¨Ù…Ø­Ù„ÙˆÙ„ Ù…Ù„Ø­ÙŠ ÙŠÙÙŠØ¯ ÙƒØ«ÙŠØ±.",
      "Ø¥Ø°Ø§ Ø­Ø±Ø§Ø±Ø© Ø¹Ø§Ù„ÙŠØ© Ù…Ø³ØªÙ…Ø±Ø©/Ø¶ÙŠÙ‚ Ù†ÙØ³/Ø£Ù„Ù… ØµØ¯Ø±/ØªØ¯Ù‡ÙˆØ± Ø³Ø±ÙŠØ¹: Ø±Ø§Ø¬Ø¹ Ø·Ø¨ÙŠØ¨.",
    ],
    when_to_seek_help: "Ø­Ø±Ø§Ø±Ø© ÙÙˆÙ‚ 39 Ù…Ø³ØªÙ…Ø±Ø©ØŒ Ø¶ÙŠÙ‚ Ù†ÙØ³ØŒ Ø£Ù„Ù… ØµØ¯Ø±ØŒ Ø£Ùˆ ØªØ¯Ù‡ÙˆØ± ÙˆØ§Ø¶Ø­: Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨/Ø§Ù„Ø·ÙˆØ§Ø±Ø¦.",
    next_question: "ØªØ­Ø¨ ØªØ®ØªØ§Ø± ÙØ¦Ø© Ø«Ø§Ù†ÙŠØ©ØŸ",
    quick_choices: ["Ù…Ø¶Ø§Ø¯ Ø­ÙŠÙˆÙŠ", "Ù…Ø³ÙƒÙ†Ø§Øª", "Ø£Ø¯ÙˆÙŠØ© Ø­Ø³Ø§Ø³ÙŠØ©", "Ø£Ø¯ÙˆÙŠØ© Ø³Ø¹Ø§Ù„/Ø²ÙƒØ§Ù…", "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"],
  });
}

/** 2) ğŸ§ª Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù„Ù…Ø®ØªØ¨Ø± ÙˆØ§Ù„ØªØ­Ø§Ù„ÙŠÙ„ */
function labPrepMenuCard() {
  METRICS.flows.lab_prepStarted++;
  return makeCard({
    title: "ğŸ§ª Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù„Ù…Ø®ØªØ¨Ø± ÙˆØ§Ù„ØªØ­Ø§Ù„ÙŠÙ„",
    category: "report",
    verdict: "Ø§Ø®ØªØ± Ø§Ù„Ù„ÙŠ ØªØ¨ÙŠÙ‡:",
    tips: ["Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ ØªØ­Ù„ÙŠÙ„ Ù…Ø­Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø·Ø¨ÙŠØ¨: Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ù‡ ÙˆØ£Ù†Ø§ Ø£Ø¹Ø·ÙŠÙƒ ØªØ­Ø¶ÙŠØ± Ø¹Ø§Ù…."],
    when_to_seek_help: "Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ Ø£Ø¹Ø±Ø§Ø¶ Ø´Ø¯ÙŠØ¯Ø©: Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨/Ø§Ù„Ø·ÙˆØ§Ø±Ø¦.",
    next_question: "ÙˆØ´ ØªØ®ØªØ§Ø±ØŸ",
    quick_choices: ["ğŸ“„ Ø§ÙÙ‡Ù… ØªÙ‚Ø±ÙŠØ±Ùƒ", "ğŸ§ª Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù„Ù…Ø®ØªØ¨Ø±", "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"],
  });
}

function labPrepDetailsCard() {
  return makeCard({
    title: "ğŸ§ª Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù„Ù…Ø®ØªØ¨Ø±",
    category: "report",
    verdict:
      "**ØªØ­Ø¶ÙŠØ± Ø¹Ø§Ù… Ù„Ù„Ù…Ø®ØªØ¨Ø± (Ù…Ø®ØªØµØ± ÙˆÙˆØ§Ø¶Ø­):**\n" +
      "â€¢ Ø¨Ø¹Ø¶ Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„ ØªØ­ØªØ§Ø¬ **ØµÙŠØ§Ù…** (Ø¹Ø§Ø¯Ø© 8â€“12 Ø³Ø§Ø¹Ø©) Ù…Ø«Ù„: Ø³ÙƒØ± ØµØ§Ø¦Ù…/Ø¯Ù‡ÙˆÙ†.\n" +
      "â€¢ Ø§Ø´Ø±Ø¨ **Ù…Ø§Ø¡** Ø¹Ø§Ø¯ÙŠ (Ù…Ø³Ù…ÙˆØ­ ØºØ§Ù„Ø¨Ù‹Ø§) Ù„ØªØ³Ù‡ÙŠÙ„ Ø³Ø­Ø¨ Ø§Ù„Ø¯Ù….\n" +
      "â€¢ ØªØ¬Ù†Ø¨ Ù…Ø¬Ù‡ÙˆØ¯ Ø±ÙŠØ§Ø¶ÙŠ Ø´Ø¯ÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ø³Ø§Ø¹Ø§Øª.\n" +
      "â€¢ Ø£Ø®Ø¨Ø± Ø§Ù„Ù…Ø®ØªØ¨Ø± Ø¨Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…Ø²Ù…Ù†Ø© Ø§Ù„Ù„ÙŠ ØªØ³ØªØ®Ø¯Ù…Ù‡Ø§ (Ø¨Ø¯ÙˆÙ† ØªÙØ§ØµÙŠÙ„ Ø¬Ø±Ø¹Ø§Øª Ù‡Ù†Ø§).\n\n" +
      "**ØªØ­Ù„ÙŠÙ„ Ø¨ÙˆÙ„ (Ø¹Ø§Ù…):**\n" +
      "â€¢ Ø£ÙØ¶Ù„ Ø¹ÙŠÙ†Ø© ØºØ§Ù„Ø¨Ù‹Ø§: **Ø¨ÙˆÙ„ ØµØ¨Ø§Ø­ÙŠ**.\n" +
      "â€¢ ØªÙ†Ø¸ÙŠÙ Ø¨Ø³ÙŠØ· Ù‚Ø¨Ù„ Ø§Ù„Ø¹ÙŠÙ†Ø© + Ø¬Ù…Ø¹ â€œÙ…Ù†ØªØµÙ Ø§Ù„Ø¨ÙˆÙ„â€ ÙŠÙ‚Ù„Ù„ Ø§Ù„ØªÙ„ÙˆØ«.\n\n" +
      "**ØªØ­Ù„ÙŠÙ„ Ø¨Ø±Ø§Ø² (Ø¹Ø§Ù…):**\n" +
      "â€¢ Ø¹ÙŠÙ†Ø© Ù†Ø¸ÙŠÙØ© Ø¨Ø¯ÙˆÙ† Ø§Ø®ØªÙ„Ø§Ø· Ù…Ø§Ø¡/Ø¨ÙˆÙ„.\n" +
      "â€¢ ØªØ³Ù„ÙŠÙ…Ù‡Ø§ Ù„Ù„Ù…Ø®ØªØ¨Ø± Ø¨Ø³Ø±Ø¹Ø© Ø­Ø³Ø¨ ØªØ¹Ù„ÙŠÙ…Ø§ØªÙ‡Ù….",
    tips: ["Ø¥Ø°Ø§ ØªØ¨ÙŠ: Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ¯ (Ù…Ø«Ù„: Ø¯Ù‡ÙˆÙ†/Ø³ÙƒØ± ØµØ§Ø¦Ù…/ÙÙŠØªØ§Ù…ÙŠÙ† Ø¯) ÙˆØ£Ø±ØªØ¨ Ù„Ùƒ Ø§Ù„ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨."],
    when_to_seek_help: "Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ Ø¯ÙˆØ®Ø© Ø´Ø¯ÙŠØ¯Ø©/Ø¥ØºÙ…Ø§Ø¡ Ø£Ø«Ù†Ø§Ø¡ Ø³Ø­Ø¨ Ø§Ù„Ø¯Ù…: Ø§Ø·Ù„Ø¨ Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙˆØ±Ù‹Ø§.",
    next_question: "ØªØ¨ØºÙ‰ ØªØ±ÙØ¹ ØªÙ‚Ø±ÙŠØ± Ø¹Ø´Ø§Ù† Ø£ÙÙ‡Ù…Ù‡ØŸ",
    quick_choices: ["ğŸ“„ Ø§ÙÙ‡Ù… ØªÙ‚Ø±ÙŠØ±Ùƒ", "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"],
  });
}

/** 3) ğŸ©º ØªØ«Ù‚ÙŠÙ Ø¹Ù† Ù…Ø±Ø¶ Ø´Ø§Ø¦Ø¹ */
function commonDiseaseMenuCard() {
  METRICS.flows.common_diseaseStarted++;
  return makeCard({
    title: "ğŸ©º ØªØ«Ù‚ÙŠÙ Ø¹Ù† Ù…Ø±Ø¶ Ø´Ø§Ø¦Ø¹",
    category: "general",
    verdict: "Ø§Ø®ØªØ± Ù…Ø±Ø¶/Ø­Ø§Ù„Ø© Ø´Ø§Ø¦Ø¹Ø© ØªÙ‚Ø±Ø£ Ø¹Ù†Ù‡Ø§:",
    tips: ["Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ù„ØªØ«Ù‚ÙŠÙ Ø§Ù„Ø¹Ø§Ù… â€” Ù…Ùˆ ØªØ´Ø®ÙŠØµ."],
    when_to_seek_help: "Ø£ÙŠ Ø¶ÙŠÙ‚ Ù†ÙØ³ Ø´Ø¯ÙŠØ¯/Ø£Ù„Ù… ØµØ¯Ø±/Ø¥ØºÙ…Ø§Ø¡: Ø·ÙˆØ§Ø±Ø¦ ÙÙˆØ±Ù‹Ø§.",
    next_question: "ÙˆØ´ ØªØ®ØªØ§Ø±ØŸ",
    quick_choices: ["Ø§Ù„Ø³ÙƒØ±ÙŠ", "Ø§Ù„Ø¶ØºØ·", "Ø§Ù„Ø±Ø¨Ùˆ", "Ø§Ù„Ù‚ÙˆÙ„ÙˆÙ† Ø§Ù„Ø¹ØµØ¨ÙŠ", "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"],
  });
}

function commonDiseaseDetailsCard(name) {
  const base = {
    title: `ğŸ©º ØªØ«Ù‚ÙŠÙ Ù…Ø®ØªØµØ± â€” ${name}`,
    category: "general",
    when_to_seek_help: "Ø£Ø¹Ø±Ø§Ø¶ Ø´Ø¯ÙŠØ¯Ø© Ø£Ùˆ ØªØ¯Ù‡ÙˆØ± Ø³Ø±ÙŠØ¹: Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨/Ø§Ù„Ø·ÙˆØ§Ø±Ø¦.",
    next_question: "ØªØ­Ø¨ ØªÙ‚Ø±Ø£ Ø¹Ù† Ø­Ø§Ù„Ø© Ø«Ø§Ù†ÙŠØ©ØŸ",
    quick_choices: ["Ø§Ù„Ø³ÙƒØ±ÙŠ", "Ø§Ù„Ø¶ØºØ·", "Ø§Ù„Ø±Ø¨Ùˆ", "Ø§Ù„Ù‚ÙˆÙ„ÙˆÙ† Ø§Ù„Ø¹ØµØ¨ÙŠ", "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"],
  };

  if (name === "Ø§Ù„Ø³ÙƒØ±ÙŠ") {
    return makeCard({
      ...base,
      verdict:
        "Ø§Ù„Ø³ÙƒØ±ÙŠ ÙŠØ¹Ù†ÙŠ Ø§Ø±ØªÙØ§Ø¹ Ø³ÙƒØ± Ø§Ù„Ø¯Ù… Ø¨Ø³Ø¨Ø¨ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø¥Ù†Ø³ÙˆÙ„ÙŠÙ†/Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø¬Ø³Ù… Ù„Ù‡.\n" +
        "**Ø£Ø¹Ø±Ø§Ø¶ Ù…Ø­ØªÙ…Ù„Ø©:** Ø¹Ø·Ø´ ÙˆÙƒØ«Ø±Ø© ØªØ¨ÙˆÙ„ØŒ ØªØ¹Ø¨ØŒ ØªØ´ÙˆØ´ Ù†Ø¸Ø±.\n" +
        "**Ø§Ù„Ø£Ù‡Ù…:** Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© + Ø§Ù„Ø­Ø±ÙƒØ© + Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ø¨ÙŠØ©.",
      tips: [
        "Ù‚Ù„Ù„ Ø§Ù„Ø³ÙƒØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø§Ù„Ù…Ø­Ù„Ø§Ø©.",
        "ÙˆØ¬Ø¨Ø§Øª Ù…ØªÙˆØ§Ø²Ù†Ø© (Ø®Ø¶Ø§Ø± + Ø¨Ø±ÙˆØªÙŠÙ† + ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª Ù…Ø¹Ù‚Ø¯Ø©).",
        "Ù…Ø´ÙŠ 30 Ø¯Ù‚ÙŠÙ‚Ø© Ø£ØºÙ„Ø¨ Ø§Ù„Ø£ÙŠØ§Ù… ÙŠØ³Ø§Ø¹Ø¯ ÙƒØ«ÙŠØ±Ù‹Ø§.",
      ],
      when_to_seek_help:
        "Ø§Ø±ØªÙØ§Ø¹Ø§Øª Ø´Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ù‚ÙŠØ¡/Ø¯ÙˆØ®Ø©/ØªØ¹Ø¨ Ø´Ø¯ÙŠØ¯ Ø£Ùˆ Ø¹Ù„Ø§Ù…Ø§Øª Ø¬ÙØ§Ù: Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙÙˆØ±Ù‹Ø§.",
    });
  }

  if (name === "Ø§Ù„Ø¶ØºØ·") {
    return makeCard({
      ...base,
      verdict:
        "Ø§Ø±ØªÙØ§Ø¹ Ø¶ØºØ· Ø§Ù„Ø¯Ù… Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø¨Ø¯ÙˆÙ† Ø£Ø¹Ø±Ø§Ø¶ Ù„ÙØªØ±Ø© Ø·ÙˆÙŠÙ„Ø©.\n" +
        "**Ø§Ù„Ù‡Ø¯Ù:** ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø®Ø§Ø·Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ù„Ø¨ ÙˆØ§Ù„ÙƒÙ„Ù‰ ÙˆØ§Ù„Ø¯Ù…Ø§Øº Ø¹Ø¨Ø± Ù†Ù…Ø· Ø­ÙŠØ§Ø© ÙˆÙ…ØªØ§Ø¨Ø¹Ø©.",
      tips: [
        "Ù‚Ù„Ù„ Ø§Ù„Ù…Ù„Ø­ ÙˆØ§Ù„Ø£Ø·Ø¹Ù…Ø© Ø§Ù„Ù…ØµÙ†Ø¹Ø©.",
        "Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ ÙˆØ²Ù† ØµØ­ÙŠ ÙˆÙ†Ø´Ø§Ø· Ø¨Ø¯Ù†ÙŠ Ù…Ù†ØªØ¸Ù….",
        "Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø¶ØºØ· Ø¯ÙˆØ±ÙŠÙ‹Ø§ Ø®ØµÙˆØµÙ‹Ø§ Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ ØªØ§Ø±ÙŠØ® Ø¹Ø§Ø¦Ù„ÙŠ.",
      ],
      when_to_seek_help: "ØµØ¯Ø§Ø¹ Ø´Ø¯ÙŠØ¯ Ù…ÙØ§Ø¬Ø¦/Ø£Ù„Ù… ØµØ¯Ø±/Ø¶Ø¹Ù Ù…ÙØ§Ø¬Ø¦/ØªØ´ÙˆØ´ Ø±Ø¤ÙŠØ©: Ø·ÙˆØ§Ø±Ø¦ ÙÙˆØ±Ù‹Ø§.",
    });
  }

  if (name === "Ø§Ù„Ø±Ø¨Ùˆ") {
    return makeCard({
      ...base,
      verdict:
        "Ø§Ù„Ø±Ø¨Ùˆ ÙŠØ³Ø¨Ø¨ Ø¶ÙŠÙ‚ Ù†ÙØ³/ØµÙÙŠØ± ÙˆÙŠØªØ£Ø«Ø± Ø¨Ù…Ù‡ÙŠØ¬Ø§Øª Ù…Ø«Ù„ Ø§Ù„ØºØ¨Ø§Ø± ÙˆØ§Ù„Ø±ÙˆØ§Ø¦Ø­ ÙˆØ§Ù„Ø¯Ø®Ø§Ù†.\n" +
        "Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ø·Ø¨ÙŠØ© ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ØªØ³Ø§Ø¹Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ·Ø±Ø© ÙˆØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù†ÙˆØ¨Ø§Øª.",
      tips: [
        "ØªØ¬Ù†Ø¨ Ø§Ù„Ù…Ù‡ÙŠØ¬Ø§Øª Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù† (Ø¯Ø®Ø§Ù†/Ø¹Ø·ÙˆØ± Ù‚ÙˆÙŠØ©/ØºØ¨Ø§Ø±).",
        "Ø§Ù„ØªØ²Ù… Ø¨Ø®Ø·Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙˆØ§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø®Ø§Ø®Ø§Øª ÙƒÙ…Ø§ ÙˆØµÙÙ‡Ø§ Ø§Ù„Ø·Ø¨ÙŠØ¨ (Ø¨Ø¯ÙˆÙ† Ø¬Ø±Ø¹Ø§Øª Ù‡Ù†Ø§).",
        "ØªØ§Ø¨Ø¹ Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ ÙˆØ¥Ø°Ø§ ØªØ²ÙŠØ¯ Ø¨Ø³Ø±Ø¹Ø© Ù„Ø§ ØªÙ†ØªØ¸Ø±.",
      ],
      when_to_seek_help: "Ø¶ÙŠÙ‚ Ù†ÙØ³ Ø´Ø¯ÙŠØ¯/Ø§Ø²Ø±Ù‚Ø§Ù‚/Ø¹Ø¯Ù… ØªØ­Ø³Ù† Ø³Ø±ÙŠØ¹: Ø·ÙˆØ§Ø±Ø¦ ÙÙˆØ±Ù‹Ø§.",
    });
  }

  // Ø§Ù„Ù‚ÙˆÙ„ÙˆÙ† Ø§Ù„Ø¹ØµØ¨ÙŠ
  return makeCard({
    ...base,
    verdict:
      "Ø§Ù„Ù‚ÙˆÙ„ÙˆÙ† Ø§Ù„Ø¹ØµØ¨ÙŠ Ù…Ø±ØªØ¨Ø· Ø¨Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ø£Ù…Ø¹Ø§Ø¡ ÙˆØ§Ù„ØªÙˆØªØ±ØŒ ÙˆÙŠØ³Ø¨Ø¨ Ø£Ù„Ù… Ø¨Ø·Ù†/Ø§Ù†ØªÙØ§Ø®/ØªØºÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬.\n" +
      "Ù‡Ùˆ Ù…Ø²Ø¹Ø¬ Ù„ÙƒÙ†Ù‡ ØºØ§Ù„Ø¨Ù‹Ø§ ØºÙŠØ± Ø®Ø·ÙŠØ± â€” Ù„ÙƒÙ† Ù„Ø§Ø²Ù… ØªØ³ØªØ¨Ø¹Ø¯ Ø§Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø£Ø®Ø±Ù‰ Ù…Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø¥Ø°Ø§ Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ Ø´Ø¯ÙŠØ¯Ø©.",
    tips: [
      "Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø£Ø·Ø¹Ù…Ø© Ø§Ù„Ù…Ø­ÙØ²Ø© (Ø¯Ù‡ÙˆÙ† Ø¹Ø§Ù„ÙŠØ©/Ø¨Ø¹Ø¶ Ø§Ù„Ø¨Ù‚ÙˆÙ„/Ù…Ø´Ø±ÙˆØ¨Ø§Øª ØºØ§Ø²ÙŠØ©).",
      "ÙˆØ¬Ø¨Ø§Øª Ø£ØµØºØ± ÙˆØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ØªÙˆØªØ± ÙŠØ³Ø§Ø¹Ø¯.",
      "Ù†ÙˆÙ… Ù…Ù†ØªØ¸Ù… ÙˆÙ…Ø´ÙŠ Ø®ÙÙŠÙ ÙŠÙˆÙ…ÙŠÙ‹Ø§ Ù…ÙÙŠØ¯.",
    ],
    when_to_seek_help:
      "Ù†Ø²ÙˆÙ„ ÙˆØ²Ù† ØºÙŠØ± Ù…Ø¨Ø±Ø±/Ø¯Ù… Ø¨Ø§Ù„Ø¨Ø±Ø§Ø²/Ø­Ù…Ù‰/Ø£Ù„Ù… Ø´Ø¯ÙŠØ¯ Ù…Ø³ØªÙ…Ø±: Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙÙˆØ±Ù‹Ø§.",
  });
}

/** 4) ğŸŒ¿ Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© ÙˆÙ†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© + Ø¥Ø¶Ø§ÙØ© Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù†Ø¸Ø§ÙØ©/ØºØ³Ù„ Ø§Ù„ÙŠØ¯ÙŠÙ† */
function preventionMenuCard() {
  METRICS.flows.preventionStarted++;
  return makeCard({
    title: "ğŸŒ¿ Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© ÙˆÙ†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø©",
    category: "general",
    verdict:
      "Ù‡Ù†Ø§ Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© ÙˆØ§Ù„Ø¹Ø§Ø¯Ø§Øª Ø§Ù„ØµØ­ÙŠØ©.\n" +
      "âœ… ÙˆØ¨Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ: Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø³ÙƒØ±/Ø¶ØºØ·/BMI/Ù…Ø§Ø¡/Ø³Ø¹Ø±Ø§Øª/Ù…Ø²Ø§Ø¬) Ù…ÙˆØ¬ÙˆØ¯Ø© Ù‡Ù†Ø§ ÙƒØ§Ø®ØªÙŠØ§Ø±Ø§Øª.",
    tips: ["Ø§Ø¨Ø¯Ø£ Ø¨Ø®Ø·ÙˆØ© ØµØºÙŠØ±Ø© ÙˆØ§Ø³ØªÙ…Ø±."],
    when_to_seek_help: "Ø¥Ø°Ø§ Ø£Ø¹Ø±Ø§Ø¶ Ø·Ø§Ø±Ø¦Ø©: Ø·ÙˆØ§Ø±Ø¦ ÙÙˆØ±Ù‹Ø§.",
    next_question: "Ø§Ø®ØªØ± Ø¨Ø·Ø§Ù‚Ø©:",
    quick_choices: [
      "ğŸ§¼ ØºØ³Ù„ Ø§Ù„ÙŠØ¯ÙŠÙ† ÙˆØ§Ù„Ù†Ø¸Ø§ÙØ©",
      "Ù†ØµØ§Ø¦Ø­ ÙŠÙˆÙ…ÙŠØ©",
      "Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© Ù…Ù† Ø§Ù„ØªÙ‚Ù„Ø¨Ø§Øª",
      "ğŸ©¸ Ø§Ù„Ø³ÙƒØ±",
      "ğŸ«€ Ø§Ù„Ø¶ØºØ·",
      "âš–ï¸ BMI",
      "ğŸ’§ Ø´Ø±Ø¨ Ø§Ù„Ù…Ø§Ø¡",
      "ğŸ”¥ Ø§Ù„Ø³Ø¹Ø±Ø§Øª",
      "ğŸ§  Ø·Ù…Ù‘Ù†Ø§ Ø¹Ù„Ù‰ Ù…Ø²Ø§Ø¬Ùƒ",
      "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©",
    ],
  });
}

function handHygieneCard() {
  return makeCard({
    title: "ğŸ§¼ ØºØ³Ù„ Ø§Ù„ÙŠØ¯ÙŠÙ† ÙˆØ§Ù„Ù†Ø¸Ø§ÙØ©",
    category: "general",
    verdict: "Ù‡Ø°Ù‡ Ù†Ù‚Ø§Ø· Ø¹Ù…Ù„ÙŠØ© ÙˆÙ…Ø®ØªØµØ±Ø© ØªÙ‚Ù„Ù„ Ø§Ù„Ø¹Ø¯ÙˆÙ‰ Ø¨Ø´ÙƒÙ„ ÙƒØ¨ÙŠØ±:",
    tips: [
      "Ø§ØºØ³Ù„ ÙŠØ¯ÙŠÙƒ 20 Ø«Ø§Ù†ÙŠØ© Ø¨Ø§Ù„Ù…Ø§Ø¡ ÙˆØ§Ù„ØµØ§Ø¨ÙˆÙ† Ø®ØµÙˆØµÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ù…Ø§Ù… ÙˆÙ‚Ø¨Ù„ Ø§Ù„Ø£ÙƒÙ„ ÙˆØ¨Ø¹Ø¯ Ø§Ù„Ø³Ø¹Ø§Ù„/Ø§Ù„Ø¹Ø·Ø§Ø³.",
      "Ù„Ùˆ Ù…Ø§ ÙÙŠÙ‡ Ù…Ø§Ø¡: Ù…Ø¹Ù‚Ù… ÙƒØ­ÙˆÙ„ÙŠ (Ø¥Ø°Ø§ Ù…ØªÙˆÙØ±) ÙˆØ§ÙØ±Ùƒ Ø­ØªÙ‰ ÙŠØ¬Ù.",
      "ØªØ¬Ù†Ø¨ Ù„Ù…Ø³ Ø§Ù„ÙˆØ¬Ù‡ (Ø§Ù„Ø¹ÙŠÙ†/Ø§Ù„Ø£Ù†Ù/Ø§Ù„ÙÙ…) Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù† Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¨ÙŠØª.",
      "Ù†Ø¸Ù‘Ù Ø§Ù„Ø¬ÙˆØ§Ù„ ÙˆÙ…Ù‚Ø§Ø¨Ø¶ Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨ Ø¨Ø´ÙƒÙ„ Ø¯ÙˆØ±ÙŠ.",
      "ØºØ·Ù‘Ù Ø§Ù„Ø³Ø¹Ø§Ù„/Ø§Ù„Ø¹Ø·Ø§Ø³ Ø¨Ø§Ù„Ù…Ø±ÙÙ‚ Ø£Ùˆ Ù…Ù†Ø¯ÙŠÙ„ ÙˆØªØ®Ù„Øµ Ù…Ù†Ù‡ ÙÙˆØ±Ù‹Ø§.",
    ],
    when_to_seek_help: "Ø¥Ø°Ø§ Ø¸Ù‡Ø±Øª Ø­Ø±Ø§Ø±Ø© Ø¹Ø§Ù„ÙŠØ© Ù…Ø³ØªÙ…Ø±Ø© Ø£Ùˆ Ø£Ø¹Ø±Ø§Ø¶ ØªÙ†ÙØ³ Ø´Ø¯ÙŠØ¯Ø©: Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨.",
    next_question: "ØªØ­Ø¨ Ø¨Ø·Ø§Ù‚Ø© Ø«Ø§Ù†ÙŠØ© Ù…Ù† Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©ØŸ",
    quick_choices: ["ğŸŒ¿ Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© ÙˆÙ†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø©", "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"],
  });
}

/** 5) ğŸ¥ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù†Ø´Ø£Ø© */
function facilityGuidanceCard() {
  METRICS.flows.facilityStarted++;
  return makeCard({
    title: "ğŸ¥ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù†Ø´Ø£Ø©",
    category: "general",
    verdict:
      "Ù„Ù„Ø¯Ø®ÙˆÙ„/Ø§Ù„ØªØ³Ø¬ÙŠÙ„:\n" +
      "â€¢ Ø£Ø­Ø¶Ø± **Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø®ØµÙŠØ©** Ùˆ **Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¨Ù†ÙƒÙŠØ©**.\n" +
      "â€¢ Ø±Ø³ÙˆÙ… Ø³Ù†ÙˆÙŠØ© ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§: **Ø±ÙŠØ§Ù„ Ùˆ200 Ø¨ÙŠØ³Ø©** (Ø¹Ø¯Ù‘Ù„Ù‡Ø§ Ø¥Ø°Ø§ ÙˆØ¯Ùƒ).\n\n" +
      "**Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø© (Ø¨Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯):**\n" +
      "â€¢ Ø£Ø·ÙØ§Ù„\nâ€¢ Ø¬Ù„Ø¯ÙŠØ©\nâ€¢ Ø£Ù†Ù ÙˆØ£Ø°Ù† ÙˆØ­Ù†Ø¬Ø±Ø©\nâ€¢ Ø¹ÙŠÙˆÙ†\nâ€¢ ÙØ§Ø­Øµ Ø¨ØµØ±ÙŠØ§Øª\nâ€¢ ØªØºØ°ÙŠØ©\nâ€¢ Ø¹Ø¸Ø§Ù…\nâ€¢ Ø¬Ø±Ø§Ø­Ø©\nâ€¢ Ø¨Ø§Ø·Ù†ÙŠØ©\nâ€¢ Ø£Ø´Ø¹Ø© Ø³ÙŠÙ†ÙŠØ©\n\n" +
      "Ø¨Ø¹Ø¶ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª Ù‚Ø¯ ØªØªØ·Ù„Ø¨ **ØªØ­ÙˆÙŠÙ„ Ù…Ù† Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„ØµØ­ÙŠ**ØŒ ÙˆÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© Ù‚Ø¯ ÙŠÙØ³Ù…Ø­ Ø¨Ø§Ù„Ø­Ø¶ÙˆØ± Ø­Ø³Ø¨ Ø§Ù„ØªÙ‚ÙŠÙŠÙ….\n\n" +
      "ğŸ“± Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯: **9880 9901**",
    tips: ["Ø¥Ø°Ø§ Ù…Ø§ ØªØ¹Ø±Ù Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©ØŒ Ø§ÙƒØªØ¨ Ù„ÙŠ Ø¹Ø±Ø¶ Ù…Ø®ØªØµØ± ÙˆØ£Ù†Ø§ Ø£ÙˆÙ‘Ø¬Ù‡Ùƒ."],
    when_to_seek_help: "Ø£Ø¹Ø±Ø§Ø¶ Ø·Ø§Ø±Ø¦Ø©: Ø·ÙˆØ§Ø±Ø¦ ÙÙˆØ±Ù‹Ø§.",
    next_question: "ÙˆØ´ ØªØ­Ø¨ ØªØ³ÙˆÙŠ Ø§Ù„Ø¢Ù†ØŸ",
    quick_choices: ["Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª", "Ø­Ø¬Ø² Ù…ÙˆØ§Ø¹ÙŠØ¯ (ÙˆØ§ØªØ³Ø§Ø¨)", "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"],
  });
}

function facilityClinicsCard() {
  return makeCard({
    title: "ğŸ¥ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©",
    category: "general",
    verdict:
      "Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© Ø¹Ù†Ø¯Ù†Ø§:\n" +
      "â€¢ Ø£Ø·ÙØ§Ù„ â€¢ Ø¬Ù„Ø¯ÙŠØ© â€¢ Ø£Ù†Ù ÙˆØ£Ø°Ù† ÙˆØ­Ù†Ø¬Ø±Ø© â€¢ Ø¹ÙŠÙˆÙ† â€¢ ÙØ§Ø­Øµ Ø¨ØµØ±ÙŠØ§Øª\n" +
      "â€¢ ØªØºØ°ÙŠØ© â€¢ Ø¹Ø¸Ø§Ù… â€¢ Ø¬Ø±Ø§Ø­Ø© â€¢ Ø¨Ø§Ø·Ù†ÙŠØ© â€¢ Ø£Ø´Ø¹Ø© Ø³ÙŠÙ†ÙŠØ©\n\n" +
      "ÙƒÙ„Ù‡Ø§ Ø¨Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ØŒ ÙˆØ¨Ø¹Ø¶Ù‡Ø§ Ù‚Ø¯ ÙŠØªØ·Ù„Ø¨ ØªØ­ÙˆÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©.",
    tips: ["Ø¥Ø°Ø§ ØªÙƒØªØ¨ Ø´ÙƒÙˆØ§Ùƒ Ø¨Ø§Ø®ØªØµØ§Ø±ØŒ Ø£Ù‚ÙˆÙ„ Ù„Ùƒ Ø£Ù‚Ø±Ø¨ Ø¹ÙŠØ§Ø¯Ø© Ù…Ù†Ø§Ø³Ø¨Ø©."],
    when_to_seek_help: "Ø£Ø¹Ø±Ø§Ø¶ Ø·Ø§Ø±Ø¦Ø©: Ø·ÙˆØ§Ø±Ø¦ ÙÙˆØ±Ù‹Ø§.",
    next_question: "ØªØ¨ØºÙ‰ Ø­Ø¬Ø² Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ØŸ",
    quick_choices: ["Ø­Ø¬Ø² Ù…ÙˆØ§Ø¹ÙŠØ¯ (ÙˆØ§ØªØ³Ø§Ø¨)", "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"],
  });
}

function facilityWhatsAppCard() {
  return makeCard({
    title: "ğŸ“± Ø­Ø¬Ø² Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨",
    category: "general",
    verdict:
      "ØªÙˆØ§ØµÙ„ Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨: **9880 9901**\n\n" +
      "Ù…Ø³ØªØ­Ø³Ù† ØªØ±Ø³Ù„:\n" +
      "â€¢ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ\nâ€¢ Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù (Ø¥Ù† ÙˆØ¬Ø¯)\nâ€¢ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©\nâ€¢ Ø³Ø¨Ø¨ Ù…Ø®ØªØµØ±\nâ€¢ Ø£ÙˆÙ‚Ø§Øª Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ùƒ",
    tips: ["Ø¥Ø°Ø§ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© ØªØªØ·Ù„Ø¨ ØªØ­ÙˆÙŠÙ„ØŒ Ø¬Ù‡Ù‘Ø² Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù† ÙˆØ¬Ø¯Øª."],
    when_to_seek_help: "Ø£Ø¹Ø±Ø§Ø¶ Ø·Ø§Ø±Ø¦Ø©: Ø·ÙˆØ§Ø±Ø¦ ÙÙˆØ±Ù‹Ø§.",
    next_question: "ØªØ±Ø¬Ø¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©ØŸ",
    quick_choices: ["Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"],
  });
}

/** 6) ğŸ“… Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø´ÙØ§Ø¡ */
function shifaaMenuCard() {
  METRICS.flows.shifaaStarted++;
  return makeCard({
    title: "ğŸ“… Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø´ÙØ§Ø¡",
    category: "appointments",
    verdict:
      "Ø´ÙØ§Ø¡ Ø¨Ø±Ù†Ø§Ù…Ø¬/ØªØ·Ø¨ÙŠÙ‚ ØªØ§Ø¨Ø¹ Ù„ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØµØ­Ø© ÙÙŠ Ø³Ù„Ø·Ù†Ø© Ø¹ÙÙ…Ø§Ù† Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµØ­ÙŠ ÙˆØ§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯.\nØ§Ø®ØªØ± Ø§Ù„Ù„ÙŠ ØªØ¨ÙŠÙ‡:",
    tips: ["Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø±Ø³Ù…ÙŠØ©."],
    when_to_seek_help: "Ø¥Ø°Ø§ Ø­Ø§Ù„Ø© Ø·Ø§Ø±Ø¦Ø©: Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø£ÙˆÙ„Ù‹Ø§.",
    next_question: "ÙˆØ´ ØªØ¨ØºÙ‰ØŸ",
    quick_choices: ["Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„", "Ø®Ø·ÙˆØ§Øª Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯", "Ù…Ù…ÙŠØ²Ø§Øª Ø´ÙØ§Ø¡", "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"],
  });
}

function shifaaLinksCard() {
  return makeCard({
    title: "ğŸ“¥ Ø±ÙˆØ§Ø¨Ø· ØªØ­Ù…ÙŠÙ„ Ø´ÙØ§Ø¡",
    category: "appointments",
    verdict: "Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ù…ÙŠØ©:",
    tips: [`Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯: ${SHIFAA_ANDROID}`, `Ø¢ÙŠÙÙˆÙ†: ${SHIFAA_IOS}`],
    when_to_seek_help: "Ø¥Ø°Ø§ Ø­Ø§Ù„Ø© Ø·Ø§Ø±Ø¦Ø©: Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø£ÙˆÙ„Ù‹Ø§.",
    next_question: "ØªØ¨ØºÙ‰ Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ø¬Ø²ØŸ",
    quick_choices: ["Ø®Ø·ÙˆØ§Øª Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯", "Ù…Ù…ÙŠØ²Ø§Øª Ø´ÙØ§Ø¡", "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"],
  });
}

function shifaaBookingStepsCard() {
  return makeCard({
    title: "ğŸ§¾ Ø®Ø·ÙˆØ§Øª Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ ÙÙŠ Ø´ÙØ§Ø¡",
    category: "appointments",
    verdict:
      "Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ù…Ø®ØªØµØ±Ø©:\n" +
      "1) Ø§ÙØªØ­ ØªØ·Ø¨ÙŠÙ‚ Ø´ÙØ§Ø¡\n" +
      "2) Ø§Ø¶ØºØ· **Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯**\n" +
      "3) Ø§Ø®ØªØ± **Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯** / **Ø¢Ø®Ø± Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯** (Ø­Ø³Ø¨ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©)\n" +
      "4) Ø§Ø®ØªØ± **Ø§Ù„Ù…Ø¤Ø³Ø³Ø©**\n" +
      "5) Ø§Ø®ØªØ± **Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ù…ØªÙˆÙØ±Ø©**\n" +
      "6) Ø£ÙƒÙ‘Ø¯ Ø§Ù„Ù…ÙˆØ¹Ø¯",
    tips: ["Ø¥Ø°Ø§ Ù…Ø§ Ø¹Ù†Ø¯Ùƒ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŒ Ø§Ø³ØªØ®Ø¯Ù… (Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„)."],
    when_to_seek_help: "Ø¥Ø°Ø§ Ø£Ø¹Ø±Ø§Ø¶ Ø´Ø¯ÙŠØ¯Ø©: Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨/Ø§Ù„Ø·ÙˆØ§Ø±Ø¦.",
    next_question: "ØªØ¨ØºÙ‰ ØªØ¹Ø±Ù Ù…Ù…ÙŠØ²Ø§Øª Ø´ÙØ§Ø¡ØŸ",
    quick_choices: ["Ù…Ù…ÙŠØ²Ø§Øª Ø´ÙØ§Ø¡", "Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„", "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"],
  });
}

function shifaaFeaturesCard() {
  return makeCard({
    title: "âœ¨ Ù…Ù…ÙŠØ²Ø§Øª Ø´ÙØ§Ø¡",
    category: "appointments",
    verdict:
      "Ø´ÙØ§Ø¡ ÙŠÙˆÙØ± Ø¹Ø¯Ø© Ø®ÙŠØ§Ø±Ø§Øª Ù…Ù‡Ù…Ø©ØŒ Ù…Ù†Ù‡Ø§:\n" +
      "â€¢ **Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©:** ØªØ¹Ø±Ø¶ Ø²ÙŠØ§Ø±Ø§ØªÙƒ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨ÙŠ (Ù…Ø«Ù„ Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø­Ø³Ø¨ Ù…Ø§ Ù‡Ùˆ Ù…Ø³Ø¬Ù„).\n" +
      "â€¢ **Ø£ÙØ±Ø§Ø¯ Ø§Ù„Ø¹Ø§Ø¦Ù„Ø©:** ØªÙ‚Ø¯Ø± ØªØ´ÙˆÙ Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙØ±Ø§Ø¯ Ø¹Ø§Ø¦Ù„ØªÙƒ Ø¨Ø´Ø±Ø· Ø£Ø¹Ù…Ø§Ø±Ù‡Ù… **Ø£Ù‚Ù„ Ù…Ù† 18**. Ø§Ù„Ù„ÙŠ ÙÙˆÙ‚ 18 ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø­Ø³Ø§Ø¨Ù‡.\n" +
      "â€¢ **Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù…Ø®Ø¨Ø±ÙŠØ©:** ØªÙ‚Ø¯Ø± ØªØ´ÙˆÙ Ø§Ù„Ù†ØªØ§Ø¦Ø¬.\n" +
      "  ÙˆØ¥Ø°Ø§ ØªØ­ØªØ§Ø¬ Ø´Ø±Ø­ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ØµÙˆÙ‘Ø± Ø§Ù„Ø´Ø§Ø´Ø©/Ø§Ø±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙˆØ§Ø³ØªØ®Ø¯Ù… **Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø§ÙÙŠØ©** Ù„Ù…Ø³Ø§Ø± (Ø§ÙÙ‡Ù… ØªÙ‚Ø±ÙŠØ±Ùƒ).\n" +
      "â€¢ **Ø§Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª:** Ù…Ø«Ù„ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª (Ø¥Ø°Ø§ Ù…ØªØ§Ø­ ÙÙŠ Ø­Ø³Ø§Ø¨Ùƒ).\n" +
      "â€¢ Ø®ÙŠØ§Ø±Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù‚Ø¯ ØªØ¸Ù‡Ø± Ø­Ø³Ø¨ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª (Ù…Ø«Ù„ Ø§Ù„ØªØ¨Ø±Ø¹ Ø¨Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ù‹Ø§).",
    tips: ["Ù„Ùˆ ØªØ¨ØºÙ‰ØŒ Ù‚Ù„ Ù„ÙŠ: ØªØ¨ÙŠ (Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯) ÙˆÙ„Ø§ (Ø§Ù„Ø³Ø¬Ù„Ø§Øª) ÙˆØ£Ù†Ø§ Ø£Ø´Ø±Ø­Ù‡Ø§ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©."],
    when_to_seek_help: "Ø¥Ø°Ø§ Ø­Ø§Ù„Ø© Ø·Ø§Ø±Ø¦Ø©: Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø£ÙˆÙ„Ù‹Ø§.",
    next_question: "ÙˆØ´ ØªØ¨ØºÙ‰ Ø§Ù„Ø¢Ù†ØŸ",
    quick_choices: ["Ø®Ø·ÙˆØ§Øª Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯", "ğŸ“„ Ø§ÙÙ‡Ù… ØªÙ‚Ø±ÙŠØ±Ùƒ", "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"],
  });
}

/** ğŸ“„ Ø§ÙÙ‡Ù… ØªÙ‚Ø±ÙŠØ±Ùƒ (ØªÙˆØ¬ÙŠÙ‡) */
function understandReportCard() {
  return makeCard({
    title: "ğŸ“„ Ø§ÙÙ‡Ù… ØªÙ‚Ø±ÙŠØ±Ùƒ",
    category: "report",
    verdict: "ØªÙ…Ø§Ù…. Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ø£Ùˆ PDF Ù„Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ Ø²Ø± Ø§Ù„Ù…Ø±ÙÙ‚ØŒ ÙˆØ£Ù†Ø§ Ø£Ø´Ø±Ø­ Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù….",
    tips: ["ÙŠÙØ¶Ù‘Ù„ Ø¥Ø®ÙØ§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø´Ø®ØµÙŠØ© Ø­Ø³Ø§Ø³Ø© Ø¥Ù† Ø£Ù…ÙƒÙ†."],
    when_to_seek_help: "Ø¥Ø°Ø§ Ø£Ø¹Ø±Ø§Ø¶ Ø´Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±: Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨/Ø§Ù„Ø·ÙˆØ§Ø±Ø¦.",
    next_question: "Ø¬Ø§Ù‡Ø² ØªØ±ÙØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŸ",
    quick_choices: ["ğŸ“ Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙÙ‚", "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"],
  });
}

/** ğŸ©¹ Ø¥Ø³Ø¹Ø§ÙØ§Øª Ø£ÙˆÙ„ÙŠØ© (Ù…Ø­ÙƒÙˆÙ…Ø©) */
function firstAidGuardedCard() {
  return makeCard({
    title: "ğŸ©¹ Ø¥Ø³Ø¹Ø§ÙØ§Øª Ø£ÙˆÙ„ÙŠØ© (Ù…Ø­ÙƒÙˆÙ…Ø©)",
    category: "general",
    verdict:
      "Ø£Ù‚Ø¯Ù‘Ù… Ø¥Ø±Ø´Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© ÙˆØ¨Ø³ÙŠØ·Ø© ÙÙ‚Ø·.\n" +
      "ğŸš¨ Ø¹Ù„Ø§Ù…Ø§Øª Ø®Ø·Ø± ØªØ³ØªØ¯Ø¹ÙŠ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ ÙÙˆØ±Ù‹Ø§: Ø£Ù„Ù… ØµØ¯Ø± Ø´Ø¯ÙŠØ¯/Ø¶ÙŠÙ‚ Ù†ÙØ³ Ø´Ø¯ÙŠØ¯/Ù†Ø²ÙŠÙ Ø´Ø¯ÙŠØ¯/ÙÙ‚Ø¯Ø§Ù† ÙˆØ¹ÙŠ/ØªØ´Ù†Ø¬Ø§Øª/Ø­Ø³Ø§Ø³ÙŠØ© Ø´Ø¯ÙŠØ¯Ø©.\n" +
      "Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠ Ø¹Ù„Ø§Ù…Ø§Øª Ø®Ø·Ø±ØŒ Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ù‚Ø±Ø¨:",
    tips: ["Ù„Ø§ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙˆØª ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø®Ø·ÙŠØ±Ø©."],
    when_to_seek_help: "Ø£ÙŠ Ø¹Ù„Ø§Ù…Ø© Ø®Ø·ÙˆØ±Ø©: Ø§Ù„Ø¢Ù†.",
    next_question: "ÙˆØ´ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ù‚Ø±Ø¨ØŸ",
    quick_choices: ["Ø­Ø±Ù‚ Ø®ÙÙŠÙ", "Ø¬Ø±Ø­ Ø¨Ø³ÙŠØ·", "Ø§Ù„ØªÙˆØ§Ø¡/ÙƒØ¯Ù…Ø©", "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"],
  });
}

/* =========================
   YES/NO Router (ÙƒÙ…Ø§ Ù‡Ùˆ)
========================= */
function yesNoRouter(session, message) {
  const lastQ = String(session?.lastCard?.next_question || "").trim();
  if (!lastQ) return null;

  const m = String(message || "").trim();
  const isYes = /^Ù†Ø¹Ù…$/i.test(m);
  const isNo = /^Ù„Ø§$/i.test(m);
  if (!isYes && !isNo) return null;

  if (/Ù†Ù…Ø·\s*Ø­ÙŠØ§Ù‡|Ù†Ù…Ø· Ø­ÙŠØ§Ø©|Ø¨Ø¯Ù„\s*Ø§Ù„Ø¹Ù„Ø§Ø¬|Ø¨Ø¯Ù„ Ø§Ù„Ø¹Ù„Ø§Ø¬/i.test(lastQ)) {
    if (isYes) {
      return makeCard({
        title: "Ù†ØµØ§Ø¦Ø­ Ù†Ù…Ø· Ø­ÙŠØ§Ø©",
        category: "general",
        verdict: "ØªÙ…Ø§Ù… ğŸ‘ Ù‡Ø°Ù‡ Ù†ØµØ§Ø¦Ø­ Ø¹Ø§Ù…Ø© ÙˆØ¢Ù…Ù†Ø© ØªØ³Ø§Ø¹Ø¯ ÙƒØ«ÙŠØ±Ù‹Ø§:",
        tips: [
          "Ø®ÙÙ‘Ù Ø§Ù„Ø³ÙƒØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª Ø§Ù„Ù…Ø­Ù„Ù‘Ø§Ø© Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù†.",
          "Ø§Ø®ØªØ± ÙˆØ¬Ø¨Ø§Øª Ù…ØªÙˆØ§Ø²Ù†Ø©: Ø¨Ø±ÙˆØªÙŠÙ† + Ø®Ø¶Ø§Ø± + ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª Ù…Ø¹Ù‚Ø¯Ø©.",
          "Ù†Ø´Ø§Ø· Ø¨Ø¯Ù†ÙŠ Ù…Ø¹ØªØ¯Ù„ 30 Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ø¹Ø¸Ù… Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (Ù…Ø´ÙŠ Ø³Ø±ÙŠØ¹).",
          "Ù†ÙˆÙ… Ù…Ù†ØªØ¸Ù… 7â€“9 Ø³Ø§Ø¹Ø§Øª ÙˆØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø³Ù‡Ø±.",
          "Ø§Ø´Ø±Ø¨ Ù…Ø§Ø¡ Ø¨Ø§Ù†ØªØ¸Ø§Ù… ÙˆÙ‚Ù„Ù„ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©.",
        ],
        when_to_seek_help:
          "Ø¥Ø°Ø§ Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ù…Ø³ØªÙ…Ø±Ø©/ØªØ³ÙˆØ¡ Ø£Ùˆ Ø¸Ù‡Ø±Øª Ø¹Ù„Ø§Ù…Ø§Øª Ø®Ø·ÙˆØ±Ø© (Ø£Ù„Ù… ØµØ¯Ø±/Ø¶ÙŠÙ‚ Ù†ÙØ³/Ø¥ØºÙ…Ø§Ø¡): Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨/Ø§Ù„Ø·ÙˆØ§Ø±Ø¦.",
        next_question: "ØªØ­Ø¨ Ù†Ø±ÙƒØ² Ø¹Ù„Ù‰: Ø§Ù„ØªØºØ°ÙŠØ© ÙˆÙ„Ø§ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¨Ø¯Ù†ÙŠØŸ",
        quick_choices: ["Ø§Ù„ØªØºØ°ÙŠØ©", "Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¨Ø¯Ù†ÙŠ", "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"],
      });
    }
    if (isNo) {
      return makeCard({
        title: "Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø§ÙÙŠØ©",
        category: "general",
        verdict: "ØªÙ…Ø§Ù….",
        tips: [],
        when_to_seek_help: "Ø¥Ø°Ø§ Ø£Ø¹Ø±Ø§Ø¶ Ø·Ø§Ø±Ø¦Ø©: Ø·ÙˆØ§Ø±Ø¦ ÙÙˆØ±Ù‹Ø§.",
        next_question: "ØªØ±Ø¬Ø¹ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©ØŸ",
        quick_choices: ["Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"],
      });
    }
  }

  if (/Ø´Ø±Ø­|Ø®Ø·ÙˆØ§Øª|ØªÙØ§ØµÙŠÙ„/i.test(lastQ)) {
    if (isYes) {
      return makeCard({
        title: "ØªÙˆØ¶ÙŠØ­",
        category: session.lastCard?.category || "general",
        verdict: "ØªÙ…Ø§Ù…. Ø§ÙƒØªØ¨ Ù„ÙŠ: ÙˆØ´ Ø¨Ø§Ù„Ø¶Ø¨Ø· ØªØ¨ØºÙ‰ Ø£Ø¹Ø±ÙÙƒ Ø¹Ù„ÙŠÙ‡ØŸ",
        tips: ["Ù…Ø«Ø§Ù„: Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø­Ø¬Ø²ØŒ ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¹Ø¯ØŒ Ø¥Ù„ØºØ§Ø¡ØŒ Ø£Ùˆ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…."],
        when_to_seek_help: "",
        next_question: "ÙˆØ´ ØªØ¨ØºÙ‰ ØªØ­Ø¯ÙŠØ¯Ù‹Ø§ØŸ",
        quick_choices: ["Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", "Ø¥Ù„ØºØ§Ø¡"],
      });
    }
    if (isNo) {
      return makeCard({
        title: "Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø§ÙÙŠØ©",
        category: "general",
        verdict: "ØªÙ… ğŸ‘",
        tips: [],
        when_to_seek_help: "",
        next_question: "ØªØ­Ø¨ ØªØ³Ø£Ù„ Ø´ÙŠØ¡ Ø«Ø§Ù†ÙŠØŸ",
        quick_choices: ["Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"],
      });
    }
  }

  return null;
}

/* =========================
   Groq call (Structured JSON) â€” Ù†Ø³ØªØ®Ø¯Ù…Ù‡ ÙÙ‚Ø· Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
========================= */
const CARD_SCHEMA = {
  type: "object",
  additionalProperties: false,
  properties: {
    title: { type: "string" },
    category: {
      type: "string",
      enum: [
        "general",
        "emergency",
        "appointments",
        "report",
        "mental",
        "bmi",
        "bp",
        "sugar",
        "water",
        "calories",
      ],
    },
    verdict: { type: "string" },
    tips: { type: "array", items: { type: "string" } },
    when_to_seek_help: { type: "string" },
    next_question: { type: "string" },
    quick_choices: { type: "array", items: { type: "string" } },
  },
  required: [
    "title",
    "category",
    "verdict",
    "tips",
    "when_to_seek_help",
    "next_question",
    "quick_choices",
  ],
};

function chatSystemPrompt() {
  return (
    "Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ØªØ«Ù‚ÙŠÙ ØµØ­ÙŠ ÙÙ‚Ø·ØŒ ÙˆÙ„Ø³Øª Ø·Ø¨ÙŠØ¨Ù‹Ø§ ÙˆÙ„Ø§ Ø¨Ø¯ÙŠÙ„Ø§Ù‹ Ø¹Ù† Ø§Ù„Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ø·Ø¨ÙŠØ©.\n" +
    "Ø¥Ø°Ø§ Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ØªØ­ÙŠØ©ØŒ Ø§Ø¨Ø¯Ø£ Ø¨Ø±Ø¯ Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ Ù‚ØµÙŠØ± Ø«Ù… Ø§Ù†ØªÙ‚Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØµØ­ÙŠ.\n" +
    "Ù‚Ø¯Ù‘Ù… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ø§Ù…Ø© Ø¹Ù† Ø§Ù„ØµØ­Ø© ÙˆÙ†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© Ø¨Ø£Ø³Ù„ÙˆØ¨ Ø¹Ø±Ø¨ÙŠ ÙˆØ§Ø¶Ø­ ÙˆÙ…Ø®ØªØµØ±.\n" +
    "Ù…Ù…Ù†ÙˆØ¹ Ù…Ù†Ø¹Ù‹Ø§ Ø¨Ø§ØªÙ‹Ø§: Ø§Ù„ØªØ´Ø®ÙŠØµØŒ ÙˆØµÙ Ø§Ù„Ø£Ø¯ÙˆÙŠØ©ØŒ Ø§Ù„Ø¬Ø±Ø¹Ø§ØªØŒ Ø£Ùˆ Ø®Ø·Ø© Ø¹Ù„Ø§Ø¬.\n" +
    "Ø§Ø°ÙƒØ± Ù…ØªÙ‰ ÙŠØ¬Ø¨ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨/Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø¹Ù†Ø¯ Ø£Ø¹Ø±Ø§Ø¶ Ø®Ø·ÙŠØ±Ø©.\n" +
    "Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ØªØ£ÙƒØ¯Ù‹Ø§ØŒ Ù‚Ù„: Ù„Ø§ Ø£Ø¹Ù„Ù….\n" +
    "Ø£Ø®Ø±Ø¬ JSON ÙÙ‚Ø· Ø¨Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.\n"
  );
}

function reportSystemPrompt() {
  return (
    "Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ØªØ«Ù‚ÙŠÙ ØµØ­ÙŠ Ø¹Ø±Ø¨ÙŠ Ù„Ø´Ø±Ø­ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„/Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±.\n" +
    "Ø§Ù„Ù…Ø¯Ø®Ù„ Ù†Øµ Ù…ÙØ³ØªØ®Ø±Ø¬ Ù…Ù† ØµÙˆØ±Ø©/Ù…Ù„Ù.\n" +
    "Ø§Ø´Ø±Ø­ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¨Ø´ÙƒÙ„ Ø¹Ø§Ù… + Ù†ØµØ§Ø¦Ø­ Ø¹Ø§Ù…Ø© + Ù…ØªÙ‰ ÙŠØ±Ø§Ø¬Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨.\n" +
    "Ù…Ù…Ù†ÙˆØ¹: ØªØ´Ø®ÙŠØµ Ù…Ø¤ÙƒØ¯ØŒ Ø¬Ø±Ø¹Ø§ØªØŒ ÙˆØµÙ Ø¹Ù„Ø§Ø¬.\n" +
    "Ø£Ø®Ø±Ø¬ JSON ÙÙ‚Ø· Ø¨Ù†ÙØ³ Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©.\n"
  );
}

async function callGroqJSON({ system, user, maxTokens = 1400 }) {
  if (!GROQ_API_KEY) throw new Error("Missing GROQ_API_KEY");

  const url = "https://api.groq.com/openai/v1/chat/completions";
  const body = {
    model: GROQ_MODEL,
    temperature: 0.2,
    max_tokens: maxTokens,
    response_format: {
      type: "json_schema",
      json_schema: { name: "dalil_alafiyah_card", strict: true, schema: CARD_SCHEMA },
    },
    messages: [
      { role: "system", content: system },
      { role: "user", content: user },
    ],
  };

  for (let attempt = 0; attempt < 3; attempt++) {
    const res = await fetch(url, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${GROQ_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify(body),
    });

    if (res.status === 429) {
      await sleep(1200 + attempt * 700);
      continue;
    }

    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(`Groq API error: ${res.status} ${JSON.stringify(data)}`);

    const text = data?.choices?.[0]?.message?.content || "";
    const parsed = safeJsonParse(text);
    if (parsed) return parsed;

    await sleep(350);
  }

  throw new Error("Groq returned invalid JSON repeatedly");
}

/* =========================
   Safety post-filter (âœ… ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª/Ø§Ù„ÙˆØµÙØ© ÙÙ‚Ø·)
========================= */
function postFilterCard(card) {
  const combined =
    (card?.verdict || "") +
    "\n" +
    (Array.isArray(card?.tips) ? card.tips.join("\n") : "") +
    "\n" +
    (card?.when_to_seek_help || "");

  const hasDoseNumber =
    /(\b\d{1,4}\b)\s*(mg|Ù…Ù„Øº|mcg|Âµg|g|Ø¬Ø±Ø§Ù…|Ù…Ù„|ml|cc)\b/i.test(combined) ||
    /(\bÙ…Ø±Ø©\b|\bÙ…Ø±ØªÙŠÙ†\b|\bØ«Ù„Ø§Ø«\b)\s*(ÙŠÙˆÙ…ÙŠØ§|ÙŠÙˆÙ…ÙŠÙ‹Ø§|Ø¨Ø§Ù„day|ÙÙŠ Ø§Ù„ÙŠÙˆÙ…)/i.test(combined);

  const hasDirectPrescriptionVerb =
    /(Ø®Ø°|Ø®Ø°ÙŠ|ØªÙ†Ø§ÙˆÙ„|ØªÙ†Ø§ÙˆÙ„ÙŠ|Ø§Ø³ØªØ®Ø¯Ù…|Ø§Ø³ØªØ®Ø¯Ù…ÙŠ|Ø§Ø¨Ø¯Ø£|Ø§Ø¨Ø¯Ø§)\s+/i.test(combined) &&
    /(Ø¯ÙˆØ§Ø¡|Ø­Ø¨ÙˆØ¨|Ù‚Ø±Øµ|ÙƒØ¨Ø³ÙˆÙ„|Ø´Ø±Ø§Ø¨|Ø¨Ø®Ø§Ø®|Ø§Ù†Ø³ÙˆÙ„ÙŠÙ†|antibiotic|metformin|ibuprofen|paracetamol)/i.test(combined);

  if (hasDoseNumber || hasDirectPrescriptionVerb) {
    return makeCard({
      title: "ØªÙ†Ø¨ÙŠÙ‡",
      category: card?.category || "general",
      verdict:
        "Ø£Ù†Ø§ Ù„Ù„ØªØ«Ù‚ÙŠÙ Ø§Ù„ØµØ­ÙŠ ÙÙ‚Ø·. Ù…Ø§ Ø£Ù‚Ø¯Ø± Ø£ÙˆØµÙ Ø£Ø¯ÙˆÙŠØ© Ø£Ùˆ Ø¬Ø±Ø¹Ø§Øª.\n" +
        "Ø¥Ø°Ø§ Ø³Ø¤Ø§Ù„Ùƒ Ø¹Ù„Ø§Ø¬ÙŠ/Ø¯ÙˆØ§Ø¦ÙŠØŒ Ø±Ø§Ø¬Ø¹ Ø·Ø¨ÙŠØ¨/ØµÙŠØ¯Ù„ÙŠ.",
      tips: [
        "Ø§ÙƒØªØ¨ Ù„Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ ÙˆÙ…Ø¯Ø© Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ÙˆØ§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ù† ÙˆØ¬Ø¯Øª.",
        "Ø¥Ø°Ø§ Ø£Ø¹Ø±Ø§Ø¶ Ø´Ø¯ÙŠØ¯Ø©: Ø·ÙˆØ§Ø±Ø¦.",
      ],
      when_to_seek_help: "Ø£Ù„Ù… ØµØ¯Ø±/Ø¶ÙŠÙ‚ Ù†ÙØ³/Ø¥ØºÙ…Ø§Ø¡/Ù†Ø²ÙŠÙ Ø´Ø¯ÙŠØ¯: Ø·ÙˆØ§Ø±Ø¦ ÙÙˆØ±Ù‹Ø§.",
      next_question: "Ù‡Ù„ ØªØ±ÙŠØ¯ Ù†ØµØ§Ø¦Ø­ Ù†Ù…Ø· Ø­ÙŠØ§Ø© Ø¹Ø§Ù…Ø© Ø¨Ø¯Ù„ Ø§Ù„Ø¹Ù„Ø§Ø¬ØŸ",
      quick_choices: ["Ù†Ø¹Ù…", "Ù„Ø§", "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"],
    });
  }

  return card;
}

/* =========================
   Routes
========================= */
app.get("/", (req, res) => {
  res.json({
    ok: true,
    service: "Dalil Alafiyah API",
    routes: ["/chat", "/report", "/reset", "/metrics"],
  });
});

app.get("/metrics", (req, res) => {
  res.json({ ok: true, data: METRICS });
});

app.post("/reset", (req, res) => {
  const userId = getUserId(req);
  sessions.delete(userId);
  res.json({ ok: true });
});

app.post("/chat", async (req, res) => {
  const t0 = Date.now();
  METRICS.chatRequests++;

  const userId = getUserId(req);
  const session = getSession(userId);

  const message = String(req.body?.message || "").trim();
  if (!message) return res.status(400).json({ ok: false, error: "empty_message" });

  // âœ… Dedup: Ø¥Ø°Ø§ Ù†ÙØ³ Ø§Ù„Ù†Øµ Ø§Ù†Ø±Ø³Ù„ Ù…Ø±ØªÙŠÙ† Ø¨Ø³Ø±Ø¹Ø© (Ø£Ù‚Ù„ Ù…Ù† 900ms) Ø±Ø¬Ù‘Ø¹ Ø¢Ø®Ø± Ø¨Ø·Ø§Ù‚Ø©
  const now = Date.now();
  if (session.lastInText === message && now - (session.lastInAt || 0) < 900) {
    const fallback = session.lastCard || menuCard();
    return res.json({ ok: true, data: fallback, dedup: true });
  }
  session.lastInText = message;
  session.lastInAt = now;

  // ØªØ­ÙŠØ©/Ø´ÙƒØ±
  if (isGreeting(message)) {
    const card = greetingCard();
    session.lastCard = card;
    bumpCategory("general");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }
  if (isThanks(message)) {
    const card = thanksCard();
    session.lastCard = card;
    bumpCategory("general");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }

  // Ù…Ø³Ø­/Ø¥Ù„ØºØ§Ø¡
  if (/^(Ø¥Ù„ØºØ§Ø¡|Ø§Ù„ØºØ§Ø¡|cancel|Ù…Ø³Ø­|Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©|Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯|Ø§Ø¨Ø¯Ø£ Ø¬Ø¯ÙŠØ¯)$/i.test(message)) {
    resetFlow(session);
    const card = menuCard();
    session.lastCard = card;
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }

  // Ø·ÙˆØ§Ø±Ø¦
  if (isEmergencyText(message)) {
    METRICS.emergencyTriggers++;
    const card = makeCard({
      title: "âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ø·Ø§Ø±Ø¦",
      category: "emergency",
      verdict:
        "Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø© Ù‚Ø¯ ØªÙƒÙˆÙ† Ø®Ø·ÙŠØ±Ø©.\n" +
        "ÙŠÙÙ†ØµØ­ Ø¨Ø§Ù„ØªÙˆØ¬Ù‡ Ù„Ø£Ù‚Ø±Ø¨ Ø·ÙˆØ§Ø±Ø¦ Ø£Ùˆ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ø³Ø¹Ø§Ù ÙÙˆØ±Ù‹Ø§.",
      tips: ["Ù„Ø§ ØªÙ†ØªØ¸Ø±.", "Ø¥Ø°Ø§ Ù…Ø¹Ùƒ Ø´Ø®ØµØŒ Ø§Ø·Ù„Ø¨ Ù…Ø³Ø§Ø¹Ø¯ØªÙ‡ ÙÙˆØ±Ù‹Ø§."],
      when_to_seek_help: "Ø§Ù„Ø¢Ù†.",
      next_question: "Ù‡Ù„ Ø£Ù†Øª ÙÙŠ Ø£Ù…Ø§Ù† Ø§Ù„Ø¢Ù†ØŸ",
      quick_choices: ["Ù†Ø¹Ù…", "Ù„Ø§"],
    });
    session.lastCard = card;
    bumpCategory("emergency");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }

  // Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
  if (/^(Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©|Ø§Ù„Ù‚Ø§Ø¦Ù…Ù‡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠÙ‡|Ù…Ù†ÙŠÙˆ|Ù‚Ø§Ø¦Ù…Ø©|Ø§Ø¨Ø¯Ø£|Ø§Ø¨Ø¯Ø¡)$/i.test(message)) {
    resetFlow(session);
    const card = menuCard();
    session.lastCard = card;
    bumpCategory("general");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }

  // ====== âœ… Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ø¤Ø³Ø³Ø© (Hardcoded routing) ======

  // 1) Ø§Ø±Ø´Ø§Ø¯ Ø¯ÙˆØ§Ø¦ÙŠ Ø¹Ø§Ù…
  if (/^(ğŸ’Š\s*)?Ø¥Ø±Ø´Ø§Ø¯ Ø¯ÙˆØ§Ø¦ÙŠ Ø¹Ø§Ù…$/i.test(message)) {
    const card = medGuideMenuCard();
    session.lastCard = card;
    bumpCategory("general");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }
  if (/^(Ù…Ø¶Ø§Ø¯ Ø­ÙŠÙˆÙŠ|Ù…Ø³ÙƒÙ†Ø§Øª|Ø£Ø¯ÙˆÙŠØ© Ø­Ø³Ø§Ø³ÙŠØ©|Ø§Ø¯ÙˆÙŠØ© Ø­Ø³Ø§Ø³ÙŠÙ‡|Ø£Ø¯ÙˆÙŠØ© Ø³Ø¹Ø§Ù„\/Ø²ÙƒØ§Ù…|Ø§Ø¯ÙˆÙŠØ© Ø³Ø¹Ø§Ù„\/Ø²ÙƒØ§Ù…|Ø£Ø¯ÙˆÙŠØ© Ø³Ø¹Ø§Ù„|Ø§Ø¯ÙˆÙŠØ© Ø³Ø¹Ø§Ù„|Ø²ÙƒØ§Ù…)$/i.test(message)) {
    // ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©
    const kind =
      /Ø­Ø³Ø§Ø³ÙŠ/i.test(message) ? "Ø£Ø¯ÙˆÙŠØ© Ø­Ø³Ø§Ø³ÙŠØ©" :
      /(Ø³Ø¹Ø§Ù„|Ø²ÙƒØ§Ù…)/i.test(message) ? "Ø£Ø¯ÙˆÙŠØ© Ø³Ø¹Ø§Ù„/Ø²ÙƒØ§Ù…" :
      String(message).trim();
    const card = medGuideDetailsCard(kind);
    session.lastCard = card;
    bumpCategory("general");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }

  // 2) Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù„Ù…Ø®ØªØ¨Ø± ÙˆØ§Ù„ØªØ­Ø§Ù„ÙŠÙ„
  if (/^(ğŸ§ª\s*)?Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù„Ù…Ø®ØªØ¨Ø± ÙˆØ§Ù„ØªØ­Ø§Ù„ÙŠÙ„$/i.test(message)) {
    const card = labPrepMenuCard();
    session.lastCard = card;
    bumpCategory("report");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }
  if (/^ğŸ§ª\s*Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù„Ù…Ø®ØªØ¨Ø±$/i.test(message) || /^Ø§Ù„ØªØ­Ø¶ÙŠØ± Ù„Ù„Ù…Ø®ØªØ¨Ø±$/i.test(message)) {
    const card = labPrepDetailsCard();
    session.lastCard = card;
    bumpCategory("report");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }

  // 3) ØªØ«Ù‚ÙŠÙ Ø¹Ù† Ù…Ø±Ø¶ Ø´Ø§Ø¦Ø¹
  if (/^(ğŸ©º\s*)?ØªØ«Ù‚ÙŠÙ Ø¹Ù† Ù…Ø±Ø¶ Ø´Ø§Ø¦Ø¹$/i.test(message)) {
    const card = commonDiseaseMenuCard();
    session.lastCard = card;
    bumpCategory("general");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }
  if (/^(Ø§Ù„Ø³ÙƒØ±ÙŠ|Ø§Ù„Ø¶ØºØ·|Ø§Ù„Ø±Ø¨Ùˆ|Ø§Ù„Ù‚ÙˆÙ„ÙˆÙ† Ø§Ù„Ø¹ØµØ¨ÙŠ)$/i.test(message)) {
    const card = commonDiseaseDetailsCard(String(message).trim());
    session.lastCard = card;
    bumpCategory("general");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }

  // 4) Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© ÙˆÙ†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø© + ØºØ³Ù„ Ø§Ù„ÙŠØ¯ÙŠÙ†
  if (/^(ğŸŒ¿\s*)?Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© ÙˆÙ†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ù‡$/i.test(message) || /^(ğŸŒ¿\s*)?Ø§Ù„ÙˆÙ‚Ø§ÙŠØ© ÙˆÙ†Ù…Ø· Ø§Ù„Ø­ÙŠØ§Ø©$/i.test(message)) {
    const card = preventionMenuCard();
    session.lastCard = card;
    bumpCategory("general");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }
  if (/^ğŸ§¼\s*ØºØ³Ù„ Ø§Ù„ÙŠØ¯ÙŠÙ† ÙˆØ§Ù„Ù†Ø¸Ø§ÙÙ‡$/i.test(message) || /^ğŸ§¼\s*ØºØ³Ù„ Ø§Ù„ÙŠØ¯ÙŠÙ† ÙˆØ§Ù„Ù†Ø¸Ø§ÙØ©$/i.test(message) || /^ØºØ³Ù„ Ø§Ù„ÙŠØ¯ÙŠÙ†$/i.test(message) || /^Ø§Ù„Ù†Ø¸Ø§ÙÙ‡$/i.test(message) || /^Ø§Ù„Ù†Ø¸Ø§ÙØ©$/i.test(message)) {
    const card = handHygieneCard();
    session.lastCard = card;
    bumpCategory("general");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }

  // 5) Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù†Ø´Ø£Ø©
  if (/^(ğŸ¥\s*)?Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù†Ø´Ø£Ù‡$/i.test(message) || /^(ğŸ¥\s*)?Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ù†Ø´Ø£Ø©$/i.test(message)) {
    const card = facilityGuidanceCard();
    session.lastCard = card;
    bumpCategory("general");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }
  if (/^Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª$/i.test(message)) {
    const card = facilityClinicsCard();
    session.lastCard = card;
    bumpCategory("general");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }
  if (/^Ø­Ø¬Ø² Ù…ÙˆØ§Ø¹ÙŠØ¯ \(ÙˆØ§ØªØ³Ø§Ø¨\)$/i.test(message) || /^Ø­Ø¬Ø² Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨$/i.test(message) || /^Ø­Ø¬Ø² ÙˆØ§ØªØ³Ø§Ø¨$/i.test(message)) {
    const card = facilityWhatsAppCard();
    session.lastCard = card;
    bumpCategory("general");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }

  // 6) Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø´ÙØ§Ø¡
  if (/^(ğŸ“…\s*)?Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø´ÙØ§Ø¡$/i.test(message)) {
    const card = shifaaMenuCard();
    session.lastCard = card;
    bumpCategory("appointments");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }
  if (/^Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„$/i.test(message)) {
    const card = shifaaLinksCard();
    session.lastCard = card;
    bumpCategory("appointments");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }
  if (/^Ø®Ø·ÙˆØ§Øª Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯$/i.test(message)) {
    const card = shifaaBookingStepsCard();
    session.lastCard = card;
    bumpCategory("appointments");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }
  if (/^Ù…Ù…ÙŠØ²Ø§Øª Ø´ÙØ§Ø¡$/i.test(message) || /^Ø¹Ù† Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø´ÙØ§Ø¡$/i.test(message)) {
    const card = shifaaFeaturesCard();
    session.lastCard = card;
    bumpCategory("appointments");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }

  // Ø§ÙÙ‡Ù… ØªÙ‚Ø±ÙŠØ±Ùƒ (Ù‚ØµÙŠØ±)
  if (/Ø§ÙÙ‡Ù…\s*ØªÙ‚Ø±ÙŠØ±Ùƒ|ğŸ“„/i.test(message) && message.length <= 30) {
    const card = understandReportCard();
    session.lastCard = card;
    bumpCategory("report");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }

  // Ø¥Ø³Ø¹Ø§ÙØ§Øª Ø£ÙˆÙ„ÙŠØ© (Ù…Ø­ÙƒÙˆÙ…Ø©)
  if (/^(ğŸ©¹\s*)?Ø¥Ø³Ø¹Ø§ÙØ§Øª Ø£ÙˆÙ„ÙŠØ© \(Ù…Ø­ÙƒÙˆÙ…Ø©\)$/i.test(message) || /^(ğŸ©¹\s*)?Ø§Ø³Ø¹Ø§ÙØ§Øª Ø§ÙˆÙ„ÙŠÙ‡ \(Ù…Ø­ÙƒÙˆÙ…Ø©\)$/i.test(message)) {
    const card = firstAidGuardedCard();
    session.lastCard = card;
    bumpCategory("general");
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }

  // YES/NO Router
  const yn = yesNoRouter(session, message);
  if (yn) {
    session.lastCard = yn;
    bumpCategory(yn.category);
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: yn });
  }

  // Bare yes/no ÙÙ‚Ø· Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠ Ø³Ø¤Ø§Ù„ Ø³Ø§Ø¨Ù‚
  if (!session.flow && isBareYesNo(message) && !session.lastCard?.next_question) {
    const card = makeCard({
      title: "Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø§ÙÙŠØ©",
      category: "general",
      verdict: "ÙˆØ¶Ø­ Ù„ÙŠ Ø£ÙƒØ«Ø± ğŸ˜Š",
      tips: ["Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ø¨Ø´ÙƒÙ„ Ø£ÙˆØ¶Ø­ Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ø³Ø§Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©."],
      when_to_seek_help: "Ø¥Ø°Ø§ Ø£Ø¹Ø±Ø§Ø¶ Ø·Ø§Ø±Ø¦Ø©: Ø·ÙˆØ§Ø±Ø¦ ÙÙˆØ±Ù‹Ø§.",
      next_question: "ÙˆØ´ ØªØ¨ØºÙ‰ ØªØ³Ø£Ù„ØŸ",
      quick_choices: menuCard().quick_choices,
    });
    session.lastCard = card;
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }

  // Ø±Ø³Ø§Ù„Ø© Ù‚ØµÙŠØ±Ø©/ØºØ§Ù…Ø¶Ø©
  const inferred = inferCategoryFromMessage(message);
  if (isTooVague(message, session)) {
    const card = makeCard({
      title: "ØªÙˆØ¶ÙŠØ­ Ø³Ø±ÙŠØ¹",
      category: inferred === "emergency" ? "emergency" : inferred || "general",
      verdict: "Ø£Ù‚Ø¯Ø± Ø£Ø³Ø§Ø¹Ø¯ÙƒØŒ Ø¨Ø³ Ø£Ø­ØªØ§Ø¬ ØªÙØ§ØµÙŠÙ„ Ø¨Ø³ÙŠØ·Ø© Ø¹Ø´Ø§Ù† Ù…Ø§ Ø£Ø¹Ø·ÙŠÙƒ Ø±Ø¯ Ø¹Ø§Ù….",
      tips: ["Ø§ÙƒØªØ¨: Ø§Ù„Ø¹Ù…Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ + Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ + Ù…Ø¯ØªÙ‡Ø§ + Ù‡Ù„ ÙÙŠÙ‡ Ø­Ø±Ø§Ø±Ø©/Ø£Ù„Ù… Ø´Ø¯ÙŠØ¯ØŸ"],
      when_to_seek_help: "Ø¥Ø°Ø§ Ø£Ù„Ù… ØµØ¯Ø±/Ø¶ÙŠÙ‚ Ù†ÙØ³/Ø¥ØºÙ…Ø§Ø¡/Ù†Ø²ÙŠÙ Ø´Ø¯ÙŠØ¯: Ø·ÙˆØ§Ø±Ø¦ ÙÙˆØ±Ù‹Ø§.",
      next_question: "ÙˆØ´ Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø¨Ø§Ù„Ø¶Ø¨Ø· ÙˆÙ…ØªÙ‰ Ø¨Ø¯Ø£ØªØŸ",
      quick_choices: ["Ø£Ø¹Ø±Ø§Ø¶ Ø¨Ø¯Ø£Øª Ø§Ù„ÙŠÙˆÙ…", "Ù…Ù† ÙŠÙˆÙ…ÙŠÙ†", "Ø£Ø³Ø¨ÙˆØ¹+", "Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"],
    });
    session.lastCard = card;
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);
    return res.json({ ok: true, data: card });
  }

  // ====== LLM fallback (Ù„Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø­Ø±Ø©) ======
  session.history.push({ role: "user", content: message });
  session.history = trimHistory(session.history, 10);

  const last = req.body?.context?.last || session.lastCard || null;
  const lastStr = last ? clampText(JSON.stringify(last), 1200) : "";
  const msgStr = clampText(message, 1200);

  const historyStr = clampText(
    session.history
      .slice(-6)
      .map((x) => `${x.role === "user" ? "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" : "Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯"}: ${x.content}`)
      .join("\n"),
    1800
  );

  const userPrompt =
    (historyStr ? `Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (Ø¢Ø®Ø± Ø±Ø³Ø§Ø¦Ù„):\n${historyStr}\n\n` : "") +
    (last ? `Ø³ÙŠØ§Ù‚ Ø¢Ø®Ø± Ø¨Ø·Ø§Ù‚Ø© (Ù„Ø§ ØªÙƒØ±Ø±Ù‡Ø§ Ø­Ø±ÙÙŠÙ‹Ø§ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡Ø§ ÙÙ‚Ø· Ø¥Ø°Ø§ Ù…Ø±ØªØ¨Ø·Ø©):\n${lastStr}\n\n` : "") +
    `Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:\n${msgStr}\n\n` +
    "Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…: Ù„Ø§ ØªØ´Ø®ÙŠØµØŒ Ù„Ø§ Ø£Ø¯ÙˆÙŠØ©ØŒ Ù„Ø§ Ø¬Ø±Ø¹Ø§Øª.\n" +
    "Ù‚Ø¯Ù‘Ù… Ù†ØµØ§Ø¦Ø­ Ø¹Ø§Ù…Ø© Ø¹Ù…Ù„ÙŠØ© + Ù…ØªÙ‰ ÙŠØ±Ø§Ø¬Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨/Ø§Ù„Ø·ÙˆØ§Ø±Ø¦.\n" +
    "Ù…Ù‡Ù…: Ù„Ø§ ØªØ¹ÙŠØ¯ Ù†ÙØ³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¬ÙˆØ§Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚ØµÙŠØ±Ù‹Ø§.\n";

  try {
    const obj = await callGroqJSON({
      system: chatSystemPrompt(),
      user: userPrompt,
      maxTokens: 1200,
    });

    const card = makeCard({ ...obj, category: obj?.category || inferred || "general" });
    const safeCard = postFilterCard(card);

    session.lastCard = safeCard;
    session.history.push({ role: "assistant", content: JSON.stringify(safeCard) });
    session.history = trimHistory(session.history, 10);

    bumpCategory(safeCard.category);
    METRICS.chatOk++;
    updateAvgLatency(Date.now() - t0);

    return
